{
  "title": "Transformer for one stop interpretable cell type annotation",
  "url": "https://openalex.org/W4316096017",
  "year": 2023,
  "authors": [
    {
      "id": "https://openalex.org/A2109687789",
      "name": "Jiawei Chen",
      "affiliations": [
        "Center for Life Sciences",
        "Peking University"
      ]
    },
    {
      "id": "https://openalex.org/A2097611263",
      "name": "Hao Xu",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A2793588375",
      "name": "Wanyu Tao",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A2124881236",
      "name": "Zhaoxiong Chen",
      "affiliations": [
        "Center for Life Sciences",
        "Peking University"
      ]
    },
    {
      "id": "https://openalex.org/A2151840284",
      "name": "Yuxuan Zhao",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A3189374507",
      "name": "Jing-Dong J. Han",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A2109687789",
      "name": "Jiawei Chen",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A2097611263",
      "name": "Hao Xu",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    },
    {
      "id": "https://openalex.org/A2793588375",
      "name": "Wanyu Tao",
      "affiliations": [
        "Center for Life Sciences",
        "Peking University"
      ]
    },
    {
      "id": "https://openalex.org/A2124881236",
      "name": "Zhaoxiong Chen",
      "affiliations": [
        "Center for Life Sciences",
        "Peking University"
      ]
    },
    {
      "id": "https://openalex.org/A2151840284",
      "name": "Yuxuan Zhao",
      "affiliations": [
        "Center for Life Sciences",
        "Peking University"
      ]
    },
    {
      "id": "https://openalex.org/A3189374507",
      "name": "Jing-Dong J. Han",
      "affiliations": [
        "Peking University",
        "Center for Life Sciences"
      ]
    }
  ],
  "references": [
    "https://openalex.org/W2076687510",
    "https://openalex.org/W2794480084",
    "https://openalex.org/W2949177718",
    "https://openalex.org/W2109890799",
    "https://openalex.org/W3208953781",
    "https://openalex.org/W2971653850",
    "https://openalex.org/W3217613634",
    "https://openalex.org/W4212836561",
    "https://openalex.org/W4214520160",
    "https://openalex.org/W4295808856",
    "https://openalex.org/W6739901393",
    "https://openalex.org/W3035422918",
    "https://openalex.org/W4304775823",
    "https://openalex.org/W3039453617",
    "https://openalex.org/W2523620612",
    "https://openalex.org/W2551194178",
    "https://openalex.org/W2526262591",
    "https://openalex.org/W2523369352",
    "https://openalex.org/W2523419694",
    "https://openalex.org/W1979283544",
    "https://openalex.org/W2885927965",
    "https://openalex.org/W2794083495",
    "https://openalex.org/W2894687190",
    "https://openalex.org/W2948300330",
    "https://openalex.org/W3179857518",
    "https://openalex.org/W2995410603",
    "https://openalex.org/W2907514116",
    "https://openalex.org/W3006566541",
    "https://openalex.org/W3024842005",
    "https://openalex.org/W3041129226",
    "https://openalex.org/W3047307039",
    "https://openalex.org/W2951914955",
    "https://openalex.org/W3096486351",
    "https://openalex.org/W4248967728",
    "https://openalex.org/W2796170779",
    "https://openalex.org/W3016020856",
    "https://openalex.org/W2897346235",
    "https://openalex.org/W2964643116",
    "https://openalex.org/W2971398276",
    "https://openalex.org/W2966569571",
    "https://openalex.org/W2959295202",
    "https://openalex.org/W2917234282",
    "https://openalex.org/W2020310303",
    "https://openalex.org/W2150686415",
    "https://openalex.org/W4225598893",
    "https://openalex.org/W3126902084",
    "https://openalex.org/W4200468913",
    "https://openalex.org/W2594844287",
    "https://openalex.org/W2970751796",
    "https://openalex.org/W2128120736",
    "https://openalex.org/W2921168633",
    "https://openalex.org/W2074963908",
    "https://openalex.org/W4226183288",
    "https://openalex.org/W2774307122",
    "https://openalex.org/W2322101694",
    "https://openalex.org/W6969310825",
    "https://openalex.org/W2800392236",
    "https://openalex.org/W3128961456",
    "https://openalex.org/W4282838697"
  ],
  "abstract": null,
  "full_text": "Article https://doi.org/10.1038/s41467-023-35923-4\nTransformer for one stop interpretable cell\ntype annotation\nJiawei Chen 1,2,H a oX u1,2,W a n y uT a o1, Zhaoxiong Chen1, Yuxuan Zhao1 &\nJing-Dong J. Han 1\nConsistent annotation transfer fromreference dataset to query dataset is\nfundamental to the development and reproducibility of single-cell research.\nCompared with traditional annotation methods, deep learning based methods\nare faster and more automated. A series of useful single cell analysis tools\nbased on autoencoder architecture havebeen developed but these struggle to\nstrike a balance between depth and interpretability. Here, we present TOSICA,\na multi-head self-attention deep learning model based on Transformer that\nenables interpretable celltype annotation using biologically understandable\nentities, such as pathways or regulons. We show that TOSICA achieves fast and\naccurate one-stop annotation and batch-insensitive integration while provid-\ning biologically interpretable insights for understanding cellular behavior\nduring development and disease progressions. We demonstrate TOSICA’s\nadvantages by applying it to scRNA-seq data of tumor-inﬁltrating immune\ncells, and CD14+ monocytes in COVID-19 to reveal rare cell types, hetero-\ngeneity and dynamic trajectories associated with disease progression and\nseverity.\nSingle-cell technologies have enabled studying biological processes\nand human diseases at unprecedented resolution and transformed the\ntool boxes in biology. An important step in scRNA-seq analysis is to\nidentify cell populations or types by clustering\n1. Cell type annotation\ncan resolve cellular heterogeneity across tissues, developmental\nstages and organisms, and improve our understanding of cellular and\ngene functions in health and disease. Many unsupervised scRNA-seq\nclustering methods have been proposed\n2–4, which are followed by\ntime-consuming and labor-costly annotations5. These traditional\nmethods often consist of preprocessing, dimensionality reduction,\nclustering, differential analysis, and manual annotation based on prior\nknowledge. When subtypes are annotated manually based on a small\nset of marker genes, the same subtype can sometimes be given a new\nname in another research due to a slight difference. Also, when all\nsamples cannot be obtained at the same time, it would be desirable to\nclassify the cell types on theﬁrst batch of data and use them to\nannotate the data obtained later or to be obtained in the future with\nthe same standard, without the need to processing and mapping them\ntogether again. Thus, transferring cell type annotation from a refer-\nence dataset to newly generated query datasets with consistency and\nreproducibility is increasingly important and necessary. We noted\nmost of the existing AI-based tools although can handle large dataset,\nthey involve information combination and non-linear activation\nbetween layers making theﬁnal learned features abstract and unable\nto trace back the input features (including both biological information\nlike genes, and technical information like batch effect, and so on)\n(as reviewed by refs.\n6–8 and collected in websitehttps://github.com/\nOmicsML/awesome-deep-learning-single-cell-papers). For example,\nthe change of dimensions and non-linear aggregation of features\nthroughout the autoencoder’s deep processing stages leads to\nuntraceable and uninterpretable latent space and loss of information\nand feature resolution\n9,10. In addition, with the increase of non-linear\naggregation layers to achieve more powerful learning capability,\nthe model gets deeper meanwhile the contribution from input\ngets harder to trace, which leadsto the loss of interpretability\n11.\nHowever, the Transformer framework does not involve dimensionality\nReceived: 29 July 2022\nAccepted: 9 January 2023\nCheck for updates\n1Peking-Tsinghua Center for Life Sciences, Academy for Advanced Interdisciplinary Studies, Center for Quantitative Biology (CQB), Peking University, Beijing\n100871, China.2These authors contributed equally: Jiawei Chen, Hao Xu.e-mail: jackie.han@pku.edu.cn\nNature Communications|          (2023) 14:223 1\n1234567890():,;\n1234567890():,;\nreduction10,12, thus keeping all attention layer traceable to the original\ninput features13, thus making the models interpretable. Therefore, we\nchoose Transformer as the framework to develop a new AI-based cell\ntype label transfer tool between a reference dataset and a query\ndataset, which we named Transformer for One-Stop Interpretably Cell-\ntype Annotation (TOSICA).\nTOSICA is a multi-head self-attention network for interpretable cell\ntype annotation in single-cell data and datasets integration simulta-\nneously. By connecting attention to prior biological knowledge and\nwithout any batch information, TOSICA interpretably integrates and\nannotates single-cell data in a batch-insensitive manner while retaining\nbiological variation. Benchmarks and case studies conﬁrm the strength\nof TOSICA in accuracy and robustness for heterogeneous single-cell\nd a t a ,e v e ni nt h ed i fﬁcult task of uneven abundance of cell types between\nreference and query. When tested on many datasets, TOSICA provides\nthe advantage to interpret the attention feature genes and pathways, and\nsurprisingly also automaticallyﬁltering out batch effect, potentially as a\nconsequence of direct mapping of cell types to genes (or pathways when\nusing a pathway mask). TOSICA not only met the needs for accurate cell\ntype annotation across different datasets, exceeding existing methods in\naccuracy, but also often do so with reduced time cost.\nResults\nThe structure of TOSICA\nTOSICA is an automatic cell-type annotator based on Multi-Head Self-\nattention\n12. Through supervised training, our model learns the pro-\njection function from gene expression to cell type, meanwhile trans-\nfers high-dimensional and sparse expression space to low-dimensional\nand dense feature space.\nTOSICA is composed of three parts: Cell Embedding layer, Multi-\nhead Self-attention layer, and Cell-Type Classiﬁer (Fig. 1a). The ﬁrst\nstep of TOSICA is Cell Embedding, which transforms genes into tokens,\nits transformation matrix is originally a fully connected weight matrix.\nBut transformation matrix is then masked (marked) by a matrix based\non expert knowledge (e.g., a gene’s membership to a pathway), only\nsparse connections among genes and pathways remain in the masked\ntransformation matrix for training and learning (Illustrated in Fig.1a).\nThereby one token only receives information from speciﬁcg e n e sa n d\nstands for a pathway. This operation is repeated m times in parallel,\nand all m tokens vectors are merged together. This tokens matrix then\nis appended with a class token (CLS)\n14, a trainable parameter which\nthen abstracts the information during the following network layers and\nis used to predict the cell type. Next, this new merged matrix becomes\nthe input of Multi-head Self-attention layer, where the query (Q), key\n(K), and value (V) matrix are linearly projected from input mentioned\nbefore, and each of them can be regarded as a slightly different copy of\noriginal input. As biological processes are complex and interactive,\nthere are subtle relationships between pathways, which are calculated\nby Q and K and referred as attention score (A). It is noteworthy that the\nattention scores between CLS and pathway tokens mean the impor-\ntance of the latter to the classiﬁcation and identiﬁcation the cell type.\nOutput matrix (O) is the result of operation of A and V, representing a\ncomprehensive score of each pathway and their interacting partners.\nAt this time, CLS in O has collected the information of various path-\nways, and then transformed to a vector of cell type probabilities.\nTransformer is successful in interpretability beneﬁted by self-attention\nmechanism, which calculates the relationship (referred to as“atten-\ntion”) between tokens of object representation\n12.J u s ta sV i s i o nT r a n s -\nformer calculates attention between an added class token and\nsignatures of pictures to explain which pixels are important for\nclassiﬁcation\n13,14, TOSICA calculates the attention (relationship map-\nping) between cell-type classiﬁer token (CLS) and signatures (for\nexample pathway tokens) of cell. In addition, attention scores between\nCLS and pathway tokens, used as the attention embedding of cells,\nenable a variety of downstream analyses.\nTOSICA is a universal, accurate and efﬁcient cell type annotator\nWe test TOSICA on six different datasets with“ground truth” cell type\nlabels obtained from their original publications: human artery\n(hArtery)\n15, human bone (hBone)16, human pancreas (hPancreas)17–21,\nmouse brain (mBrain)22–25, mouse pancreas (mPancreas)26, and mouse\natlas sequenced by Smart-seq2 and 10X platform (mAtlas)27 (Fig. 1b,\nSupplementary Dataset 1, 2, Supplementary Figs. 1–7), and compare its\naccuracy with other 18 cell type annotators2,3,28–43. The accuracy here is\ndeﬁned as the fraction of cells correctly predicted. The accuracy of\nTOSICA on every dataset ranks at top 6 (Supplementary Dataset 3), and\nits mean accuracy of 86.69% is the highest among all 19 methods\n(Fig. 2a). Although TOSICA ranksﬁf t ha n ds i x t ho nt w oe a s y - t o - c l a s s i f y\ndatasets (hArtery and hPancreas),where all top six methods have above\n90% accuracy, its accuracy of 93.75% and 95.76% is close to the top-\nranked methods (Seurat 96.37% for hArtery and SingleCellNet 97.53%\nfor hPancreas). In contrast, on the datasets that vary signiﬁcantly on\naccuracy across methods (hBone, mPancreas, and mAtlas), TOSICA\nranks top 2 (Supplementary Dataset 3). Notably, on the biggest dataset\nmAtlas, which also has the most cell types, TOSICA annotated the cells\nin query with a high accuracy of 81.06%, while the second best tool\nACTINN has an accuracy of 79.57%. And the same types of cells from\nr e f e r e n c ea n dq u e r ya r ei nt h es a m ec l u s t e ri nt h eT O S I C Aa t t e n t i o n\nscore based UMAP (Fig.2b). Meanwhile, with the increase of the dataset\nsize, time cost of TOSICA on mAtlas is the fourth shortest and does not\nexplode exponentially like most of the other methods (Fig.2c).\nWe then tested the impact of different masks on accuracy (Sup-\nplementary Fig. 8a). In order to stimulate the situation of having no\nexpert knowledge, we build two random masks with 1% and 5%\nreserved connections according to the real-world masks (Supple-\nmentary Fig. 8b) to avoid increasing the number of parameters. Ran-\ndom masks usually can result in the similar accuracy as knowledge-\nbased masks, but in the case of mPancreas dataset, the accuracy\nconverges lower with the random mask (Supplementary Fig. 8c). Most\nimportantly, models with random masks need more epochs to con-\nverge (Supplementary Fig. 8c). So TOSICA is not limited by expert\nknowledge and robust to mask choice, and one can choose mask\ndepending on biological context or research interests, but expert\nknowledge helps to converge to the best model faster.\nSince all methods perform relatively badly on hBone dataset, we\nwonder what characteristics of dataset have the most impact on cell\ntype prediction. We quantify the number of cells (Log size), number of\ncell types (Types), uneven distribution of cell types (Entropy) in\ntraining set, as well as asymmetry of cell types distribution in training\nand test set (Kullback-Leibler Divergence, D\nKL)( s e e“Methods”), and\ncalculate their correlation with accuracy. The result shows that, when\ncell types distribute unevenly between reference set and query set,\nwhich is common in real-world, it is difﬁcult for an annotator to predict\ncell type correctly (PCC between ACC and D\nKL = −0.9, Fig. 2d). Not\nsurprisingly, the cell type distribution of hBone dataset is the most\nunbalanced between training and test set (Fig.2a). On theﬁve cell\ntypes, preﬁbrochondrocytes (preFC), prehypertrophic chondrocytes\n(preHTC), homeostatic chondrocytes (HomC), regulatory chon-\ndrocytes (RegC) and hypertrophic chondrocytes (HTC) that are more\nunevenly distributed in test or reference set, TOSICA (76.47%) beats\nthe second (SingleR, 63.23%) or third (SciBet, 68.18%) highest mean\naccuracy methods (Fig.2e). Altogether, TOSICA has an acceptable time\ncost on large datasets, while performs better than any other methods\non tough tasks, making it a universal cell type annotator.\nTOSICA enables discovery of new cell types\nSome cell types are at low abundance in the reference of mAtlas, may be\ninsufﬁcient for training a good predictor, but TOSICA still identiﬁes\nthem well and clusters them together, also separates them from other\nc e l lt y p e sa sm u c ha sp o s s i b l ei nt h eq u e r ys e t( F i g .2b). In a more\nextreme but common scenario, some cell types have never been seen\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 2\nduring training. Thus, we delete the‘alpha cells’ in reference set of\nhPancreas to simulate the loss of one high-percentage cell type. As\nmentioned earlier, the output of TOSICA is the probabilities that a cell is\na certain cell type, so when predicting, if the highest probability is below\na preset cutoff (0.95), this cell is annotated as‘Unknown’.A se x p e c t e d ,\n‘alpha cells’ in the query set of hPancreas are clustered together (Fig.3a)\nand 76% of them are labeled as‘Unknown’ by TOSICA (Fig.3b), while the\nrest are labeled as‘pancreatic polypeptide cell’ (PP), which is also an\nendocrine cell (Fig.3b). Three other annotators with high average\naccuracy, SingleR, SciBet, and ACTINN (Fig.2a), do not automatically\nidentify‘alpha’ cells as a new cell type, instead incorrectly label them as\n‘PP’, ‘delta’ or ‘beta’ (Supplementary Fig. 9a–c). On contrary, CELLBLAST\nand chetah, two annotators that actively identify new cell types, label\n‘alpha’ cells with 99% and 62% as‘PP’, with 0 and 37% as a new cell type,\nrespectively (Supplementary Fig. 9d, e). CaSTLe even simply recognizes\nmost of the cells of all cell types as‘Unknown’, including the cell types\nthat are well-represented in the training sets (Supplementary Fig. 9f).\nThere is also another rare cell type only appeared in query,‘MHC class II’\ncell, and is annotated as‘macrophage’ or ‘Unknown’ and clustered\nseparately by TOSICA (Fig.3a, b). Other methods also predict MHC II as\n‘macrophage’ or ‘Unknown’ like TOSICA (Supplementary Fig. 9). Since\nmacrophage is one type of MHC II cell, such an annotation is acceptable.\nThus, compared to all other methods, TOSICA has a unique ability to\naccurately discover and annotate new cell types.\nQ\nK\nV\nA\nO\nCell Embedding Multi-head Self-attention Cell Type Classifier\nAttention Embedding\nCelli\nn HVG\nKnowldege-based\nmask\nm Embedding\n(k GS + 1 CLS) ×\nCLS\nm CLS nc Cell Type\n GSs\nCellTypes  TrajectoryGS x\n Bio-StatesGS x\nN Layer\nH Head\nCLS: Class Token GS: Gene Set\nThe letter prefix represents the dimension of the object\nQ, K, V: Query, Key, Value\nA: Attention O: Output\nHVG: Highly variable gene\na\nb hPancreas\n14,818\nmPancreas\n36,351\nmAtlas\n356,213\nmBrain\n56,195\nhBone\n26,140\nhArtery\n46,359\nstate = healthy state = healthy GSE84133\nGSE85241\nGSE116470\nGSE109774\nGSE110823\nday\n12.5, 13.5, 14.5\nage\n18 m\nArticalArtical\nReference = Train(70%) + Validation(30%)\nstate = disease state = disease GSE81608\nE-MTAB-5061\nGSE86473\nGSE60361 day\n15.5\nage\n1, 3, 21,\n24, 30 m\nArticalArtical\nQuery = Test\nFig. 1 | Algorithmic framework of TOSICA. aThe model is trained on single-cell\nRNA sequencing data and cell type label for each cell. Based on databases or expert\nknowledge, masked learnable embeddings are used to convert the reference input\ndata (n genes) to k input tokens representing each gene set (GS), to which class\ntoken (CLS) is added. In the attention function, query (Q), key (K), and value (V)\nmatrix are linearly projected from these GSs and CLS combined tokens and the\nweights (attention, A) is computed by a compatibility function of the Q with the\ncorresponding K, then assigned to each V for computing output (O). In each Multi-\nhead Self-attention layer, the attention function is performed H times in parallel.\nThe CLS of O, considered as latent space of each cell, is used as input of the whole\nconjunction neural network cell type classiﬁer. Meanwhile, the attention of class\n(CLS) token to gene set (GS) tokens is referred as attention score and used for cell\nembedding.b hArtery and hBone datasets use healthy samples as training data and\npredict disease samples. hPancreas and mBrain datasets are split by data source.\nTraining and test data in mPancreas and mAtlas come from different timepoints.\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 3\nTOSICA provides high resolution and interpretable cell type\nannotation\nManual annotation of cell types, especially cell subtypes, relies on\nmarker genes selection. However, speciﬁcity of marker genes is\ndetermined by comparing with the other cell types in the same dataset.\nThus, across different datasets, the same cell may have different\nmarker gene sets, thus annotated differently. Here, the annotation\nstandard is variable. A well-trained automatic annotator using uniform\nbiologically relevant standards can avoid the problem of giving the\nsame cell different annotations. In the mPancreas dataset, a class of\nmature acinar cells (Mat. Acinar) with distribution bias is predicted as\nproliferative acinar cells (Prlf. Acinar) by TOSICA (Fig.3c). We examine\nhPancreas\nmBrain\nmAtlas\nhArtery\nmPancreas\nhBone\ngarnettscID scLearnscmapcellSCSAMarkercountscTyperSCINAscmapclusterscPredCaSTLechetahCELLBLASTSingleCellNetSeuratACTINNSciBetSingleRTOSICA\nMean of acc\nLog size\nTypes\nEntropy\nDKL\nACC of Method\n0\n0.5\n1\nLog size\n4\n4.5\n5\n5.5\nTypes\n0\n50\n100\n150\nEntropy\n2\n3\n4\n5\n6\nDKL\n0\n1\n2\n3\n4\nMean of acc\n0\n0.2\n0.4\n0.6\n0.8\n1\n0.870.87 0.55 0.65 0.79 0.630.580.560.520.52 0.81 0.820.780.60 0.66 0.740.42 0.68 0.53\n1\n−0.04\n−0.08\n−0.16\n−0.9\n1\n0.99\n0.89\n−0.32\n1\n0.93\n−0.3\n1\n−0.22 1\n−1 −0.8−0.6−0.4−0.2 0 0.2 0.4 0.6 0.8 1\nACC\nSize\nTypes\nEntropy\nDKL\n0.86\n0.7\n0.85\n0.64\n0\n0.53\n0.52\n0\n0.1\n0.2\n0.3\n0.4\n0.5\n0.6\n0.7\n0.8\n0.9\n1\nRepCFC preFCpreHTCHomCRegCHTC\nRepC\nFC\npreFC\npreHTC\nHomC\nRegC\nHTC\nP\nO\nTOSICA\n0.9\n0.81\n0.52\n0.52\n0.56\n0\n0.1\n0.2\n0.3\n0.4\n0.5\n0.6\n0.7\n0.8\n0.9\n1RepCFC preFCpreHTCHomCRegCHTC\nRepC\nFC\npreFC\npreHTC\nHomC\nRegC\nHTC\nSingleR\n0.85\n0.95\n0.52\n0.64\n0.58\n0\n0.1\n0.2\n0.3\n0.4\n0.5\n0.6\n0.7\n0.8\n0.9\n1RepCFC preFCpreHTCHomCRegCHTC\nRepC\nFC\npreFC\npreHTC\nHomC\nRegC\nHTC\nReference Query\nDataset\nTime (s)\nmethod\nACTINN\nCaSTLe\nchetah\nSciBet\nscID\nscmapcluster\nSeurat\nSingleCellNet\nSingleR\nCELLBLAST\nscmapcell\nscTyper\nMarkercount\nSCSA\nSCINA\nTOSICA\n0\n25000\n50000\n75000\nhBone\n26,140\nhArtery\n46,359\nmAtlas\n356,213\nhPanc\n14̹818\nmPanc\n36,351\nmBrain\n56,195\nSciBet\na\nb\ncd\ne\n*\n*\nP\nO\nP\nO\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 4\nthe reference labeled Mat. Acinar cells that are predicted by TOSICA as\nMat. Acinar and Prlf. Acinar, to which we refer as MM (reference Mat.\nAcinar, TOSICA Mat. Acinar) and MP (reference Mat. Acinar, TOSICA\nPrlf. Acinar), respectively. Because mPancreas is related to develop-\nment, we use gene sets representing potential targets of regulation by\ntranscription factors or microRNAs as mask (regulon mask) for\nTOSICA. Weﬁnd that MM and MP are distinguished by MIR-6382 and\nMIR-29B-3P regulons (Fig.3d), with attention score of MIR-29B-3P\nhigher in MP. Among the genes that are important for MIR-29B-3P\nregulon based on internal information from TOSICA (Supplementary\nFig. 10a), the human homolog ofSparc has been reported to increase\nlevels of acinar markers and pro-acinar transcription factors\n44,i n d i -\ncating it is critical role for newborn acinar cells. This also highlights the\nadvantage of hierarchical annotation in not only recovering biological\ninsight at the pathway/regulon level but also at gene level. Principal\ncomponent analysis of the original expression matrix also shows that\nMP shares similar PCs with PP (reference Prlf. Acinar, TOSICA Prlf.\nAcinar) compared with other MM, where the transition ordering is\nvisible on PC1 (Supplementary Fig. 11a). Hierarchical clustering of gene\nexpression matrix further conﬁrms ourﬁn d i n gt h a tM Pa n dP Ps h o w\nsimilar patterns (Fig.3e). Thus, TOSICA’s gene set attentions auto-\nmatically distinguish cells originally labeled as Mat. Acinar and Prlf.\nAcinar, and further identiﬁed an intermediate state between the two,\nwhich is closer to Prlf. Acinar and incorrectly labeled as Mat. Acinar in\nthe annotation database. This is a manifestation of the high resolution\nand high accuracy annotation by TOSICA.\nTOSICA enables interpretable dynamic trajectory analysis\nDue to the good interpretability of attention score, it can well recon-\nstruct the trajectory and reveal the key pathways in the biological\nprocess. Using the top 50 TF regulons attentions to perform the\nunsupervised pseudotime trajectory analysis, we show the changes of\nchondrocytes types upon the onset of osteoarthritis (OA) (Fig.3f). The\ntrajectory (Fig. 3f) is consistent with that obtained by expression\nmatrix\n16. However, different from the routine gene expression-based\nanalysis, TOSICA’s regulon attention-based trajectories directly show\nthat the failure of the transition from NF1 dominance to CEBP regulon\ndominance characterizes the onset of OA (Fig.3g), highlighting the\nbiological interpretability and insights generated by TOSICA on the\ndynamic trajectory. Indeed, the homolog of CEBP has been reported to\ninhibit proliferation of mouse chondrocytes in vitro\n45,a n dNf1 ablation\nin Fgfr1Col2cKO mice reverses their hypertrophic zone phenotype46.\nTOSICA is immune to batch effect\nGenerally, query and reference datasets are generated in different\nlaboratories with different experimental protocols and thus contain\nbatch effects. Batch information is necessary for conventional data-\nintegration method to try to overcome these batch effects, which are\ndifﬁcult to completely remove and mixed up with biological differ-\nences. In contrast, despite no batch information is included in either\nthe training set or test set when they both comes from different\nbatches, different studies or subjects (Supplementary Dataset 1),\nTOSICA can consistently predict cell types with great accuracy (Fig.2a)\nand generate batch insensitive embedding, perhaps due to direct\nmapping of cell types to genes (or pathways when using a pathway\nmask). We take advantage of an efﬁcient benchmarking tool scIB\n47 to\nassess TOSICA and other integration methods on 5 datasets via batch\naverage silhouette width (batch ASW), which measures the relation-\nship between the within-cluster distances of a cell and the between-\ncluster distances of a cell to the closest cluster to evaluate batch effect\nremoval, and global cluster matching (normalized mutual information,\nNMI), which compares the overlap of two clusters to evaluate biolo-\ngical conservation. Larger values of batch ASW and NMI represent\nstronger ability of batch effect removal and biological conservation,\nrespectively\n47. On 2 of the 5 test datasets, which have more cells, the\nbatch ASW of TOSICA ranks in the top 2 and is only slightly lower\n(0.02–0.06 or 2.1–5.6%) than the top 1 method’s batch ASW (Supple-\nmentary Fig. 11b). Meanwhile, biological NMI of TOSICA ranks within\ntop 5 among 14 methods on each dataset. Conspicuously, while scGen\nand Seurat show excellent ability on datasets with fewer batches and\ncells, neither of them works on mouse atlas dataset, on which TOSICA\nranks at the top in both batch effect removal and biological con-\nservation (Supplementary Fig. 11b). Also, TOSICA is robust against the\nchoice of masks in its of batch effect removal ability, except batch\neffects removal ability is unexpectedly slightly stronger when using\nrandom masks, and it is expected that some knowledge-based masks\nare better than others for a speciﬁc dataset, for example for hBone\n(Supplementary Fig. 11b). These results indicate that TOSICA is insen-\nsitive to batch effect and good at biological conservation, and excels\non large datasets with many batches, especially considering that we\nnever provide batch information to it.\nInterpretability of TOSICA is hierarchical\nAll previous cell type annotators are gene-based, thus reveal little on\nthe biological insight behind the cell type marker genes, many more\nsubsequent analyses are needed to infer the potential enriched path-\nways and regulators behind the marker genes. Instead, by embedding\ngenes to higher level of biological processes tokens, TOSICA directly\nlearns the biological processes and signaling pathways giving rise to\nthe cell types, thus separating cell types, including new cell types\n(Fig. 2d) with accurate high-resolution annotation (Fig. 3d) and\nallowing direct trajectory regulation discovery (Fig.3g), while immune\nto batch effect (Supplementary Fig. 11b). This high-level attention\nframework not only allows interpretability but is essential for the high\naccuracy of TOSICA (Fig.2a). Furthermore, as shown by the discovery\nof MIR-29B-3P regulon (Fig.3d) and its important target geneSparc in\nthe development of acinar cell (Supplementary Fig. 10a), the inter-\npretability does not stop at the high-level structures, the important\nlow-level entities, genes, that signiﬁcantly contribute to these high-\nlevel annotations are also available from the networks within TOSICA\n(Supplementary Fig. 10), and can be revealed simultaneously thus\ngenerating a comprehensive hierarchical annotation structure.\nFig. 2 | Universality of TOSICA on different datasets. aTOSICA ranksﬁrst on\nmean accuracy compared to 18 other cell type annotators on different datasets.\nColumns are sorted by the mean accuracy of each method on all datasets (top). The\nnumber of cell types (Types), number of cells (Log size), Shannon-entropy\n(Entropy) in reference, and Kullback-Leibler divergence (D\nKL) between reference\nand query are labeled on the right. Gray means this dataset is too large for this\nmethod to deal with.b TOSICA succeeds in matching cells in query (mouse age≠\n18 months) to reference (mouse age = 18 months) on mAtlas as shown by TOSICA\nattention embedded UMAP. The UMAP is done on the whole mAtlas dataset,\nincluding both reference and query. Cells in the reference (left panel) or query\n(right panel) are colored by cell types while cells in the query (left panel) or\nreference (right panel) are colored gray. The same types of cells from reference and\nquery are located in the same cluster. Circled cells are rare in reference but\nclustered correctly in the query by TOSICA.c Runtime of TOSICA (marked by *) is\nrelatively stable with increasing data size, and the fourth shortest on mAtlas. hPanc\nand mPanc stand for hPancreas and mPancreas.d D\nKL has the most negative impact\non accuracy. Heatmap shows the correlation between accuracy (ACC) and number\nof cells (Size), number of cell types (Types), Shannon-entropy (Entropy), and\nKullback-Leibler divergence (D\nKL). e TOSICA performs better than two other top-\nranked methods onﬁve cell types unbalanced between reference and query (red\nlabels). Heatmap shows the proportion of cells in each row with cell type O (original\nlabel, shown on the right) is predicted as cell type P (prediction, shown on the top).\nCell types are ordered by ratios of their proportions in reference to query. Data are\nnormalized within each row (origin label). Only values >0.5 are labeled. Source data\nare provided as a Source dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 5\nTOSICA parses tumor inﬁltrating myeloid cells heterogeneity\nwith high resolution\nOne of the most common demands in single-cell analysis is the transfer\nof identiﬁed cell population from an original reference to newly gen-\nerated data, which may come from different batch and biological state\n(e.g., disease). To demonstrate the applicability and interpretability of\nTOSICA on such a task, we prepare two sets of pan-cancer tumor\ninﬁltrating immune cells data, myeloid\n48 and T49 cells, respectively. In\nthe myeloid dataset, a total of 71,159 myeloid cells come from tumors,\nadjacent non-cancer tissues, peripheral blood of 43 patients across 9\ncommon cancer types. Among them, kidney cancer (KIDNEY, 28,930\ncells), uterine corpus endometrial carcinoma (UCEC, 9816 cells) and\n−3 −1 1 3\nZ-score\nExpression level\nHomC\npreFC\nRegC\nRepC\nFC\nHTC\npreHTC\nOriginal\nDisease\nHealthy\nState1\n0.8\n0.6\n0.4\n0.2\n0\nPseudotime\n3.53\n3.54\n3.55\n3.530 3.535 3.540 3.545 3.550\nCEBP_Q2_01\nTGCCAAR_NF1_Q6\nEpsilon\nMast\nT cell\nMacrophage\nSchwann\nUnknown\nDuctal\nPP\nAcinar\nDelta\nPSC\nAlpha\nBeta\nMHC class II\nEndothelial\nTOSICAa\nc d\ne\nf\ng\n0.24\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0.93\n0\n0\n0\n0\n0\n0\n0\n0.03\n0\n0\n0\n0.93\n0\n0\n0\n0\n0\n0\n0\n0\n0.19\n0\n0.01\n0.99\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0.01\n0\n1\n0\n0\n0\n0.03\n0\n0\n0\n0\n0\n0\n0\n1\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n1\n0\n0\n0\n0\n0\n0\n0.01\n0\n0\n0\n0\n0.99\n0\n0.19\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0.66\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0.6\n0\n0\n0\n0\n0\n0\n0\n0\n0.01\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0\n0.02\n0\n0.56\n0.07\n0.05\n0.01\n0\n0\n0\n0.01\n0.3\n0.76\n0.4\nAcinarBetaDeltaDuctalEndothelialEpsilonMastPP PSCMacrophageSchwannT cellUnknown\nAcinar\nBeta\nDelta\nDuctal\nEndothelial\nEpsilon\nMast\nPP\nPSC\nAlpha\nMHC class II\n1\n0\nP\nOb\nOriginal\n3\n4\n5\n34567\nMIR_6382\nMIR_29B_3P\nTOSICA\n3.550\n3.545\n3.540\n3.535\n3.530\nCEBP_Q2_013.555\n3.545\n3.535\n3.550\n3.540\n3.530\nTGCCAAR_NF1_Q6\nMat. Acinar Delta\nFev+ Delta\nPrlf. Trunk\nFev+ Epsilon\nFev+ Pyy\nTrunk\nFev+ Alpha\nTip\nNgn3 High late\nBeta\nDuctal\nAlpha\nFev+ Beta\nPrlf. Ductal\nNgn3 Low EP\nPrlf. Acinar\nEpsilon\nPrlf. Tip\nMultipotent\nNgn3 High early\nOT\nMM Mat. Mat.\nMP Mat. Prlf.\nPM Prlf. Mat.\nPP Prlf. Prlf.\nHomC\nHTC\npreHTC\nOriginal\nUnknown\n(Alpha)\nUnknown\n(MHC class II)\nAlpha\nMHC class II\nMat. Acinar\nPrlf. Acinar\nMat. Acinar\nPrlf. Acinar\nMM\nMP\nHomC\nHTC\npreHTC\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 6\nesophageal carcinoma (ESCA, 8154 cells) are used as reference dataset\n(Fig. 4a) and myeloma (MYE, 7861 cells), thyroid carcinoma (THCA,\n5939), ovarian or fallopian tube carcinoma (OV-FTC, 4002 cells), pan-\ncreatic adenocarcinoma (PAAD, 3093 cells), colon cancer (CRC, 2725\ncells), and lymphoma (LYM, 639 cells) are used as query dataset\n(Fig. 4a, b). REACTOME pathway\n50 knowledgebase is used to build the\nmodel. Then, 8 evaluation metrics (ASW, graph connectivity and\nk-nearest-neighbor batch effect test (kBET) for batch effect removal\na n dN M I ,A d j u s t e dR a n dI n d e x( A R I ) ,A S Wa n di s o l a t e dl a b e lF 1s c o r e\nfor biological variation retention) are computed to verify the integra-\ntion ability by scIB\n47. scIB ranks TOSICA the second out of all 11\napplicable data integration methods evaluated on all metrics combined\n(overall score = 0.6 × biology conservation + 0.4 × batch removal)\n(Supplementary Fig. 12a). Note that Seurat-based methods, including\nSeurat v3 CCA and Seurat v3 RPCA, are unable to integrate datasets\nfrom more than 85 batches, these methods are thus not applicable for\ncomparison.\nOn the cDCs populations, TOSICA reveals that the same cDC\nsubsets from different tumor types are clustered together (Supple-\nmentary Fig. 12b), which is consistent with previous observations\n48.I n\nparticular, TOSICA detects a pair of population-speciﬁc pathways\n(NOD1/2 SIGNALING PATHWAY and TOLL RECEPTOR CASCADES)\nthat separate inﬂammation-related cDCs (cDC2_FCN1 and cDC2_IL1B)\nand a mature cDC subset (cDC3_LAMP3), which broadly present in\ntumor microenvironment (TME) from the rest of cDCs (Fig.4c). This\nis in agreement with previous observations showing low expression\nof Toll-like receptor (TLR) signaling genes and low innate immune\nactivity of cDC3_LAMP3\n48 and the“pro-inﬂammatory” properties of\ncDC2_FCN1 and cDC2_IL1B in blood51. As interpretable trajectories,\nthe diffusion map52 based on TOSICA attention embedding conﬁrms\ntwo potential origins of the cDC3_LAMP3 from cDC1s and cDC2-\nCXCL9, as previously suggested\n48 (Fig. 4d). Furthermore, the map\nreveals another state transition path from cDC2 to pro-inﬂammatory\ncDC2 subtypes (Fig.4d), which has not been observed in the previous\nanalysis48. Such an observation is further supported by partition-\nbased graph abstraction (PAGA) analysis and diffusion pseudotime\nreconstruction, when cDC3_LAMP3 is regarded as the root of the\nlineages (Fig.4d).\nOn the LYVE1+ resident tissue macrophages (RTMs), which func-\ntions to restrain inﬂammation andﬁbrosis in multiple human tissues\n53,\nTOSICA shows signiﬁcant heterogeneity of attention scores in Mac-\nro_LYVE1 across different caner types. TOSICA attention scores reveal\nthat ESCA separates from other cancers in cytokine signaling and\ninsulin signaling pathway (Fig.4e), hinting at higher inﬂammatory state\nof LYVE1+ RTMs in ESCA, which was not observed in the original study.\nNext, we examine whether TOSICA is able to detect the state shift\nduring disease progression and aging within the same cell type.\nTOSICA attention scores show a signiﬁcant upregulated of FGFR sig-\nnaling pathway (Fig.4f, RCC = 0.29p =2 . 2 8 e−24) and downregulated\nof interferon signaling with advanced stage of ESCA in LYVE1+ RTMs\n(Supplementary Fig. 12c, RCC =−0.30, p =1 . 3 8 e−27). Besides, the loss-\nfunction of innate immune system with aging\n54 is detected in CD14+\nMono (RCC =−0.26,p =2 . 6 8 e−177), which is accompanied by slight up-\nregulation (RCC = 0.14,p =2 . 0 e−47) of IFN signaling (Fig.4g). Such\npathway level association with disease progression or aging have not\nbeen observed in the previous analysis with other methods. The 5\nimportant genes for these two regulon tokens in TOSICA include the\nwell-known inﬂammatory genes NLRP3 and IFITM3 (Supplementary\nFig. 12d).\nFurthermore, beneﬁting from its high resolution, TOSICA identi-\nﬁes several subtypes of monocytes that have not been discovered in\nthe original publication\n48 (Fig. 4h), all having their own biological sig-\nnatures and potentially different functions (Supplementary Fig. 12e).\nSubtype C1 apoptotic CD14 is generally enriched in tumor tissues\n(paired t-testp-value = 0.021), especially in ESCA (paired t-testp-value\n= 0.0012) when compared to the matching normal tissues, while C0\nCD16 mainly resides in non-tumor tissues of the same type (paired\nt-test p-value = 0.0015) (Fig.4i).\nOverall, TOSICA accurately annotates query tumor inﬁltrating\nmyeloid cell types. With high biological resolution and batch insensi-\ntivity of attention (Supplementary Fig. 12a), TOSICA reveals many\nnovel dynamic and functional status of single cells, with their key\ncontributors hierarchically annotated at both pathway and gene levels\nto guide further experimental explorations.\nTOSICA reveals tumor inﬁltrating T cells dynamics\nDiscovering the origin of tumor inﬁltrating T cells is important to\ncancer immune therapy. Here on a tumor inﬁltrating T cells dataset, a\ntotal of 109,389 CD8+ T cells and 79,303 CD4+ T cells derived from the\ntumors, adjacent non-cancer tissues, peripheral blood of 48 patients\nacross 11 common cancer types, in which THCA (56,958 cells), UCEC\n(32,655 cells) and breast cancer (BC, 7354 cells) are used as reference\ndataset (Supplementary Fig. 13a, b) and renal cancer (RC, 26,649 cells),\nESCA (24,884 cells), multiple myeloma (MM, 12,274 cells), B-cell lym-\nphoma (BCL, 11,956 cells), pancreatic cancer (PACA, 9860 cells),\novarian cancer (OV, 4523 cells), fallopian tube carcinoma (FTC, 1037\ncells) and cholangiocarcinorma (CHOL, 542 cells) are used as query\ndataset (Supplementary Fig. 13a, b). REACTOME pathway knowledge-\nbase is used as mask in TOSICA. On this dataset, TOSICA ranks second\nout of all 10 applicable methods on the combined effectiveness in\nbatch effect removal and biological variation retention (Supplemen-\ntary Fig. 13c). In addition, the runtime of TOSICA is the shortest\n(minutes), while it takes scGen nearlyﬁve days toﬁnish (Supplemen-\ntary Fig. 13c).\nDiffusion map based on TOSICA attention embedding recapitu-\nlates the previous observation\n49 that CD4+ T cells develop from naïve\nT cells to Temra cells, TFH/TH1 cells, or TNFRSF9+ Treg cells, sepa-\nrately (Supplementary Fig. 14a–c). Along this transition process, many\ninterleukin signaling pathway and cytotoxic effector molecules (Sup-\nplementary Fig. 14c)—including IL2, IL1, IL6, TLR, NETRIN1, CTLA4, and\nCBL related pathway—signiﬁcantly increase (FDR < 0.001, generalized\nadditive model) and MHCI/II, IL7 and TGFb pathways decrease\nFig. 3 | One stop interpretable de novo, high resolution, dynamic, and hier-\narchical annotation for biological insights by TOSICA. aTOSICA successfully\nisolates and labels the masked alpha cells as‘Unknown’ cell type. UMAP is based on\nattention of hPancreas test set. Red circled and marked by red arrows are manually\ndeleted alpha cells and blue circled and marked by blue arrows are MHC class II\ncells, originally not present in training set. These two kinds of cells are learned as\nisolated ‘Unknown’ cell types, and are separated by TOSICA attention scores’\nUMAP. b TOSICA labels most of alpha cell and little other cell types as unknown.\nHeatmap shows proportion of cells in each row with original label O (original label,\nshown on the right) predicted as cell type P (prediction, shown on the top). See\nSupplementary Fig. 9 for comparison to other methods.c Some originally labeled\nmature Acinar (Mat., top) are predicted by TOSICA as proliferative Acinar (Prlf.,\nbottom), red circled. UMAP is based on attention of mPancreas test set. The inset\nillustrates naming of MM, MP, PM, and PP, originally (O) labeled versus TOSICA (T)\nlabeled. d Two pathways’ attention score separate the MM and MP.e Hierarchical\nclustering of DEGs between the originally labeled Mat. Acinar and Prlf. Acinar also\ngroups MM and PM together, and MP and PP together.f The proportion changes of\n3 cell types in the human bone (red circled) during the transition from healthy to\nosteoarthritis (OA), shown by diffusion map of hBone, colored by originally labeled\ncell type (left), pseudotime (middle) and sample status (healthy versus OA (right).\nEmbedding is based on TOSICA attention.g High level of NF1 tracks the trajectory\nfrom HomC to HTC and preHTC (red circled) shown by diffusion map of hBone,\ncolored by attention score of NF1 pathways (left), and by scatter plot (right), where\nlower CEBP attention score in preHTC versus HTC associates with OA (middle and\nright). Source data are provided as a Source dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 7\n(FDR < 0.001, generalized additive model). In CHOL, UCEC, PACA, and\nESCA, the tumor inﬁltrating CD4+ T cells are more likely to develop\nalong Treg path rather than Temra path (Supplementary Fig. 14d).\nLikewise, attention score based UMAP shows that GXMK+ Tex cells,\nnot terminal Tex cells as previously assumed\n49,a r et h ec o m m o ne n d\npoint of the two state transition path from naïve CD8+ T cells: theﬁrst\npath going through GZMK+ Tem cells, and the second going through\nZNF683+ Trm and terminal Tex cells, which are previously considered\nto be the end of the transition process of the two dynamic path49\n(Supplementary Fig. 14e, f). Besides, TOSICA also reveals speciﬁc\ninﬂammatory and metabolic pathways enriched for each cell type in\nthe transition process (Supplementary Fig. 14g).\ncDC3_LAMP3\ncDC1_CLEC9A\ncDC2_CXCL9\ncDC2_CD1C\ncDC2_CD1A\ncDC2_CXCR4hi\ncDC2_ISG15\ncDC2_IL1B\ncDC2_FCN1\n3.6\n3.7\n3.8\n3.9\n4.0\n3.5 3.6 3.7 3.8 3.9 4.0\nCYTOKINE_SIGNALING_IN_IMMUNE_SYSTEM\nSIGNALING_BY_INSULIN_RECEPTOR\nCancer\nUCEC\nTHCA\nKIDNEY\nESCA\n01 3 24\n3.50\n3.55\n3.60\n3.65\n3.70SIGNALING_BY_FGFR\nESCA State\nRCC = 0.286\np = 2.28e-24\n20\n80\n40\n60\nAge\nINNATE_IMMUNE_SYSTEM\nINTERFERON_SIGNALING\n-2 2 0\n-1\n0\n1\n2\n3\nMono_CD14Macro_LYVE1\nC0\nC1\nC3\nC2\nKIDNEY CRC L YM MYE\nUCEC ESCA PAAD THCA OV−FTC\nTN TN TP TP\nTN TN TN TN TN\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\n0.00\n0.25\n0.50\n0.75\n1.00\nAbundance (%) C0\nC1\nC2\nC3\nMonocyte \na\nd\nef g\nh i\nFGFR/SMAD CD14\nCD16\nApoptotic CD14\nNLR CD14\nOriginal TOSICA\nCell type\nReference Query\nCRC\nESCA\nKIDNEY\nLYM\nMYE\nOV-FTC\nPAAD\nTHCA\nUCEC\nCancer type\nb\ncDC1_CLEC9A\ncDC2_CD1A\ncDC2_CD1C\ncDC2_CXCL9\ncDC2_CXCR4hi\ncDC2_FCN1\ncDC2_IL1B\ncDC2_ISG15\ncDC3_LAMP3\nTOLL_RECEPTOR_CASCADES\n3.45 3.50 3.55 3.60\n3.40\n3.60\n3.80\n4.00NOD1_2_SIGNALING_PATHWAY\nc\ncDC2_FCN1\ncDC2_IL1B\ncDC3_LAMP3\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 8\nIn this case, TOSICA demonstrates its advantage compared to\nother cell type annotators in uncovering previously unknown dynamic\ntrajectories of cells.\nTOSICA hierarchically interprets the immune response of\npatients with COVID-19 and SLE\nTo demonstrate large-scale interpretable biomedical application of\nTOSICA, we use it to determine the transcriptional programs of the\ncellular response to COVID-19 infection. We reanalyze a large-scale\nCOVID-19 single cell transcriptome atlas of PBMC\n55,i nw h i c hp a r t so f\nhealthy control from Wuhan, Beijing, Harbin and Suihua cohorts\n(52,836 cells) are used to train the TF regulon masked TOSICA and the\nrest of healthy control and COVID-19 positive patients from 10 city\ncohorts (1,409,866 cells) are used as query dataset (Fig.5a). Among all\ncell types, DC_LAMP3, Epi and Mast are unknown cell types for refer-\nence but TOSICA can still identify them de novo as an isolated cluster\non UMAP (Fig.5a and Supplementary Fig. 15a) with little batch effect\n(Supplementary Fig. 15b). Furthermore, 8 evaluation metrics (3 for\nbatch effect removal and 5 for biological variation retention) are\ncomputed to verify the integration ability by scIB\n47, which ranks\nTOSICA theﬁrst out of all 13 applicable methods evaluated on com-\nbined effectiveness in batch effect removal and biological variation\nretention (Fig.5b ) .W et h e ne v a l u a t et h es i g n iﬁcantly enriched TFs\nwithin NK cells (Supplementary Fig. 15c), CD8+ T cells, CD4+ T cells, B\ncells and myeloid cells (Supplementary Fig. 15d). Compared with the\nexpression of marker genes, TFs attention score of MYOD_01 can\nseparately label NK cells (Supplementary Fig. 15c), while the expression\nof the known NK cell marker geneNKG7, mixes NK cells with CD8+\nT cells (Supplementary Fig. 15e).\nOn monocytes (Fig. 5c), the major inﬂammatory cell types,\nTOSICA identiﬁes 7 subtypes of monocytes, one for CD16+ monocytes\nand 6 for CD14+ monocytes (Fig.5d). Among them, C3 population\n(high activity of OCT1 and CREB) decreases and C4 population (high\nactivity of CEBP and TEF) increases during COVID-19 progression from\nhealthy to moderate to severe (Fig.5e, f). TOSICA’s TF regulon atten-\ntions in C3 and C4 show that AP2_Q6 and FOXO4_01 have low activities\nand AP4_01, MIR3617_5P, NFKB_Q6, and ATF3_Q6 have upregulated\nactivities during COVID-19 disease progression (Fig.5g). Their typical\ntarget genes indeed show a similar expression pattern (Fig.5h).\nAs aﬁnal case, we use TOSICA to assist with interpretable cell type\nannotation from established independent reference model and ana-\nlyze cell response heterogeneity. As example, we use reference model\ntrained in the above COVID-19 analysis to map a query PBMC dataset of\neight patients with systemic lupus erythematosus (SLE) whose cells\nwere either untreated (control) or treated with interferon (IFN-β)\n56\n(Supplementary Fig. 16a). Not surprisingly, our model is able to iden-\ntify the cell state transition under IFN-β treatment on monocytes\n(Supplementary Fig. 16b). Differential TF attention can distinguish\ndifferent cell types (Supplementary Fig. 16c). Between IFN-β and con-\ntrol conditions in all cells, the top 25 differentially active TFs, including\nthe top-ranked SREBP (Supplementary Fig. 16d), are consistent with\npreviously reported interferon induction of lipogenesis\n57,w h i c h\nhas not been described in the previous scRNA-seq analysis 56.\nConsistent with thisﬁnding, in each cell types, the activity of SREBP\nand SREBP1 are also upregulated and FOXO1/3 are downregulated by\nIFN-β, especially in myeloid cells (Supplementary Fig. 16e). Further-\nmore, several pairs of population-speciﬁc TF activities can separate\nIFN-β-related CD14+ Mono and B cells from untreated cells (Supple-\nmentary Fig. 16f, g).\nIn this example, TOSICA preserves cell type response to disease\nand drug interference after reference mapping. The intelligible and\ninterpretable high-resolution annotation transfer between completely\nindependent studies on different biological processes is demon-\nstrated, thus allowing interdisciplinary data integration of single-cell\nstudies.\nDiscussion\nIn this study, we develop and establish TOSICA, a Transformer-based\ncell type annotation and integration tool that offers accurate, trans-\nferrable, high-resolution, batch insensitive, biologically interpretable\ncell type annotations under many scenarios, including but not limited\nto new cell type discovery, dynamic trajectory analysis, cross platform,\nand population dataset integration. The high accuracy and batch-\ninsensitivity of TOSICA can be mainly attributed to the attention layers\nand tokens masked by high-level biologically relevant pathways or\nregulons in the Transformer architecture, which allow TOSICA to focus\non biologically relevant interacting genes, pathways or regulons,\ninstead of individual genes that are susceptible to random noise and/or\nbatch effects. By doing so, new cell types, high-resolution subtypes,\nand their dynamic behaviors are also recognized by their biologically\nrelevant and interacting signatures rather than random noise and/or\nbatch effects, meanwhile the annotations are, intrinsically by default,\nbiologically relevant and interacting signatures generated by the\nattention layer. The various systems level comparisons with existing\nmethods and case-by-case close examination of different datasets and\ntasks demonstrate the accuracy, robustness,ﬂexibility, and general-\nizability of TOSICA as an indispensable new tool for advancing the\nsingle-cell studies. As an innovative application of Transformer archi-\ntecture in single-cell omics data analysis, TOSICA creates an unprece-\ndented opportunity toward effectively and interpretably annotating\ncell types across large-scale datasets in one step. The whole package of\nTOSICA, along with tutorials and demo cases, is available online at\nhttps://github.com/JackieHanLab/TOSICA\n58 for the community. We\nalso provide a simple workﬂow schematic of how to use the TOSICA\ntoolkit (Supplementary Fig. 17).\nMethods\nTOSICA model\nFor each cell, expression levels ofn genes (e 2 Rn)a r eﬁrst embedded\ninto k tokens (t 2 Rk ) using linear transformation weight (W), which\nwill be learned during training.\nTo achieve that every token represents a different pathway, the\nweight matrix of linear transformation is masked, only if these genes\nbelong to the pathway, the connection can be saved. Thus, we generate\na mask matrix (M) using expert knowledge,M is composed of 0 or 1\nand has the same dimension asW. The masked linear transformation\nFig. 4 | TOSICA resolves pan-cancer tumor inﬁltrating myeloid cell hetero-\ngeneity. a, b TOSICA predicts cell types reliably across different cell types even\nwhen the reference and query contain no overlapping cancer types as shown by\nTOSICA attention embedded UMAP. UMAP is colored by the cancer types in the\nreference (3, left panel ina), in query (6, right panel ina), and by cell types in the\nquery as originally labeled (left panel inb) and predicted by TOSICA (right panel in\nb). c cDC2_FCN1, cDC2_IL1B, and cDC3_LAMP3 distinguish from other cell types in\nattention scores of 2 REACTOME pathways. Each dot represents one cell and is\ncolored by cell types.d Three developmental trajectories from cDC2_CXCL9 and\ncDC1_CLEC9A to cDC3_LAMP3 and cDC2 to cDC2_FCN1, cDC2_IL1B delineated by\nTOSICA attention embedded diffusion map (left) and partition-based graph\nabstraction (PAGA) (right). Edge weights in PAGA represent conﬁdence for the\nconnections between cell types, colored by pseudotime.e Macro_LYVE1 of ESCA\ndistinguish from that of other cancers in attention scores of 2 REACTOME path-\nways. f Attention score of SIGNALING_BY_FGFR increases with advanced stage of\nESCA. Statistical test is two-sided.g INNATE_IMMUNE_SYSTEM is downregulated\nand INTERFERON_SIGNALING is upregulated during aging in Mono_CD14. Dots are\ncolored by age.h Attention score based UMAP identiﬁes 4 subtypes of monocytes.\ni The distribution of the 4 monocyte subtypes changes with tumor (T) versus\nmatching normal (N) tissues or peripheral blood (P) in different cancer types.\nSource data are provided as a Source dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 9\nB_Memory\nB_Naive\nB_SOX5\nCD4_GZMA\nCD4_MKI67\nCD4_Naive\nCD4_Tcm\nCD4_Tem\nCD4_Treg\nCD8_CTL\nCD8_MKI67\nCD8_Naive\nCD8_Tem\nCD14_MC\nCD16_MC\nDC_LAMP3\nEpi\nIntermed_MC\nMacro\nMast\nMega\nNK1\nNK2\nNK3\nNeu\nPlasma\nT_gdT\ncDC\npDC\nReference Query\nMonocyte \nIntermed_MC\nCD14_MC\nCD16_MC\nC0\nC1 C2\nC3\nC4\nC5\nC6\n100\n50\n0\nHealthy\nModerate\nSevere\n*** p=1.87e-6\n50\n0\n100 * p=6.46e-3\nAP2_Q6\nAP4_01\nMIR3617_5P\nFOXO4_01\nNFKB_Q6\nATF3_Q6\n34\nIRF1\nNDUFB8\nDDX3X\nPTP4A3\nNFKBIA\nJUND\nHealthy\nModerate\nSevere\nHealthy\nModerate\nSevere\nMedian\nattention score\n0\n2\nMedian\nexpression level\n0\n2\n34\n1\nAbundance (%) Abundance (%)\na\nc\nd\neg\nfh\nOCT1/CREB\nAP1/AML1\nZNF486/ETS2\nSREBP1/NFKB\nGFI1/PEA3\nCEBP/TEF\nHNF1/STAT4\nEpi\nOutput Overall ScoreBatch CorrectionBatch ASWgraph connectivitykBET Bio conservationNMI cluster/labelARI cluster/labelCell type ASWisolated label F1CC conservation\nTOSICA\nscANVI\nscVI\nfastMNN\nscGen\nfastMNN\nComBat\nHarmony\nScanorama\nSeurat v3 RPCA\nSeurat v3 CCA\nBBKNN\nLIGER\nRanking\n1\n13\nGene\nEmbed\nGraph\nOutput\nScore\n0% 100%\nb\nFig. 5 | TOSICA reveals change in transcription factor activity during moderate\nand severe COVID-19. aTOSICA predicts cell types reliably across different cell\ntypes even when using healthy individuals as reference (left) and COVID19 patients\nas query (right). Colors denote 29 origin labels. Red circled cell types are unique in\nquery. b Comparison of integration accuracy on query data places TOSICAﬁrst\namong 13 methods. Each score is minimum–maximum scaled between 0 and 1.\nOverall scores are computed using a 40:60-weighted mean of batch correction and\nbio-conservation scores.c, d TOSICA attention score based UMAP predicts 3 known\n(c)a n d6n o v e l(d) monocyte types.e, f Subtype 3 monocytes increases (e)a n d\nsubtype 4 decreases (f) in abundance from healthy (N = 25), to moderate (N =7 9 ) ,\nand to severe (N = 91) COVID-19. Statistical test is two-sided. * RCCp <0 . 0 5 ;\n***p <0 . 0 0 1 .g TOSICA attention score of 6 transcription factors distinguishes\nsubtype 3 and 4 monocytes across different states of COVID19.h The expression\nlevels of major targets of the 6 TFs (g) generally show consistent trends with TFs\nattention score. Source data are provided as a Source dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 10\nweight (W′) is the product of the corresponding positions ofW and M.\nW0 = W*M ð1Þ\nt = W0 /C1 e ð2Þ\nThen the embedding operation is repeatedm times in parallel to\nincrease the dimensions of embedding space, wherem is a hyper-\nparameter that can be manually set, with a default of 48. Then alltsa r e\nconcatenated by column.\nT =c o l u m n b i n dt1, t2, ... , tm\n/C0/C1\n, T2 Rk × m ð3Þ\nHere, T (T 2 Rk × m) represents the pathway token matrix. Each\nrow inT, the so-called token, stands for a pathway.\nFollowing, a learnable parameter class token (CLS)i sc o n -\ncatenated toT at the top by row, and generates the input matrix (I).\nI =r o w b i n dCLS, TðÞ , CLS 2 Rm, I 2 R1+ k × m ð4Þ\nAn attention function can be described as mapping a query and a\nset of key-value pairs to an output12. In Multi-head self-attention layer,\nthe query (Q), key (K), and value (V) matrix are separately linearly\nprojected from input matrix (I) mentioned above, and the linear pro-\njection weights are referred asWq,k,v.\nQ, K, V = Wq,k,v /C1 I\nQ, K, V2R1+ k × m ð5Þ\nThen attention (A) matrix is computed byQ with the corre-\nspondingK, scaled by the inverse of the square of dimension ofK (dk)\nand activated by softmax function.\nA =s o f t m a xQ /C1 KT\nﬃﬃﬃﬃﬃﬃ\ndk\np\n !\nð6Þ\nwhere, dk = m,a n d\nsoftmax zi\n/C0/C1\n= exp zi\n/C0/C1\nP\njzj\nð7Þ\nThen A is assigned to eachV for calculate output (O).\nO = AttentionQ, K, VðÞ = A /C1 V ð8Þ\nIt is reported that instead of performing a single attention func-\ntion, it beneﬁcial to linearly project the queries, keys and valuesH\ntimes, which is the so called muti-head and each repeat is a head, with\ndifferent, learnable linear projections tod\nq, dk,a n ddv dimensions by\nWQ,K,V, respectively12.\nO =M u l t i H e a dQ, K, VðÞ = WO /C1 columnbind head1, ... , headH\n/C0/C1\n, O 2 R1+ k × m\nð9Þ\nwhere,headi = AttentionWQ\ni /C1 Q, WK\ni /C1 K, WV\ni /C1 V\n/C16/C17\nð10Þ\nThe CLS of O is used as input of a fully connected network and\nfollowed by a softmax function to obtain the probability of cell types\n(p 2 R\nnc, nc = number of cell types).\np =s o f t m a xWp /C1 CLS\n/C16/C17\nð11Þ\nIn addition, attention weights (or named as attention score) of\nCLS to pathways are abstract as low-dimensional feature of cell13.\nIn order to prevent overﬁtting, we refer to a previous research12,\nand introduce residual connection. In order to increase the model’s\nability to learn complex information, we add two more full-connected\nlayers after the attention sub layer (Supplementary Fig. 18).\nKnowledge-based mask matrix\nThe mask matrix used in this work is based on knowledge datasets\nfrom GSEA (http://www.gsea-msigdb.org/gsea/downloads.jsp). In par-\nticular, we map the input genes to selected gene sets (gmtﬁles), such\nas c2.cp.reactome.v7.5.1.symbols.gmt and c3.all.v7.5.1.symbols.gmt.\nTwo parameters are optional: a maximum number of genes in each\ngene set (default as 300) and a maximum number of gene sets (default\nas 300). The mask matrix is in the form of a binary matrixM with\ncolumns corresponding to numbers of gene sets and rows corre-\nsponding to genes, withM\ni,j =1i ft h eg e n ei belongs to the gene setj,\notherwise Mi,j = 0. Then, the matrix is sackedm times (dimension of\nembeddings) to generate gene set tokens from gene input, wherem\nwhere can be customized with a default of 48.\nModel training\nWe choose different studies or biological states to split the training\nand test set (Supplementary Dataset 1), and 30% of training set is\ndivided as validation set.\nThe accuracy is determined as the ratio of samples predicted\ncorrectly over all samples. The loss is calculated by cross entropy loss\nfunction. Stochastic gradient descent (SGD) is chosen as optimizer,\nand we use cosine learning rate decay to avoid too large steps in late\nstage of training. Typically, TOSCIA converges within 20 epochs.\nOther annotation methods\nFor all methods used for comparison, we provided them the same\ntraining (reference) dataset and test (query) dataset. And they are run\nusing their recommended default parameters. The majority of the\nmethods have built-in normalization. So, we provided each method\nwith the raw count data or log\n10(1e4*count +1) according to their\ndescription.\nQuantify the characteristics of datasets\n‘Log size’ is computed as below:\nLog size=l o g10 number of samples in datasetðÞ ð 12Þ\n‘Types’ equals the number of cell types.\nTypes = number of cell types ð13Þ\n‘Entropy’ is deﬁned as bellow:\nEntropy =\nXnc\ni =1\nlog2 pi\n/C0/C1\n/C1 pi ð14Þ\nwhere,pi = number of samples labelled as cell typei in training set\nnumber of all samples in training set\nð15Þ\nWe use Kullback-Leibler Divergence (DKL) to evaluate the unba-\nlance between reference and query sets:\nDKL =\nXnc\ni =1\nlog2 qi\n/C0/C1\n/C1 pi /C0\nXnc\ni =1\nlog2 pi\n/C0/C1\n/C1 pi ð16Þ\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 11\nwhere, pi is same as (15) and\nqi = number of samples labelled as cell typei in test set\nnumber of all samples in test set ð17Þ\nData analysis\nPython version 3.8.11 and R version 4.0.5 were used for downstream\nanalysis with the following packages: torch (version 1.7.1), scanpy\n(version 1.7.1), Seurat (version 4.1.0), ggplot2 (3.3.5), ComplexHeatmap\n(2.10.0), gam (1.22), and their dependent packages.\nAttention embedding preprocessing\nThe preprocessing of attention matrix is similar to that of the scanpy59\npipeline for scRNA-seq data. First, the matrix is normalized by library-\nsize correction using default size factor 10,000. Then, all attentions are\nidentiﬁed as input to perform PCA analysis. And then PCA matrix is\nused to build nearest neighbor graph, which is further embedded in\ntwo-dimensional UMAP for visualization.\nBenchmarking data integration\nscIB47 is used to benchmark data integration ability (version 1.0.0). For\nexisting methods, default parameters are used and only‘full features’\nand ‘unscaled’ model are used for comparing. For TOSICA, the raw\nattention embedding is used as input to scIB.\nThe study information in human pancreas and mouse brain\ndataset, donor information in human artery, human bone, mouse atlas,\ncancer and COVID-19 dataset are used for batch effect removal\nassessment. The cell type information in all datasets is used for bio-\nlogical conservation evaluation.\nIdentiﬁcation of signature attentions of cell types and sub-\nclusters\nThe signature attentions of cell types are identiﬁed based on Wilcoxon\nrank-sum (Mann–Whitney-U) test. Same as scanpy, attention scores are\nnormalized to 1e4 and logarithmized. Then, sc.tl.rank_genes_-\ngroups(method=‘wilcoxon’)i su s e df o rﬁnding marker attentions.P-\nvalues are adjusted by the Benjamini–Hochberg (BH) method.\nAs for sub-cluster identi ﬁcation, the cells of interest are\nselected, normalized, and logarithmized alone. All attentions are\nidenti ﬁed as input to perform PCA analysis. And then PCA matrix\nis used to build nearest neighbor graph, which is then used toﬁnd\nclusters by Louvain algorithm with parameter “resolution ” =0 . 3\nto identify sub-clusters.\nGenes’ importance to a pathway token\nThe importance of genes to pathway tokes are computed from the\nlinear transformation layer. Each gene’s weight for a token is calculated\nas the mean of the absolute value of weights in all embedding\ndimensions.\nCell differentiation trajectory inference\nTo model the cell state transition, the diffusion map algorithm, which\npreserves the global relations and pseudotemporal ordering of cells, is\napplied to infer the differentiation trajectory. We feed the attention\nmatrix and the previously calculated principal components matrix into\nthe scanpy pipeline. A neighborhood graph based on principal com-\nponents is constructed using the scanpy.pp.neighbors function. The\ndiffusion map is built using scanpy.tl.diffmap function. Theﬁrst two\ndiffusion components (DCs) are used for visualization. Partition-based\ngraph abstraction (PAGA) analysis is also used for visualization. With\nthe specifying of root cell, the diffusion pseudotime is calculated using\nscanpy.tl.dpt function.\nTo ﬁnd the potential attentions driving the differentiation pro-\ncess, we ﬁt a generalized additive model (gam function in the gam\npackage of R) for the pseudotime and the attention matrix. Attentions\nwith absolute coefﬁcient >0.5 and FDR < 0.01 are considered as the\ndynamic attention terms.\nStatistics and reproducibility\nNo statistical method was used to predetermine sample size. Only data\nwith poor labels were excluded from the analyses. The experiments\nwere not randomized. The investigators were not blinded to allocation\nduring experiments and outcome assessment.\nReporting summary\nFurther information on research design is available in the Nature\nPortfolio Reporting Summary linked to this article.\nData availability\nAll datasets used are obtained frompublic data repositories. See Sup-\nplementary Dataset 1 for detailed information, including access codes.\nTumor-inﬁltrating myeloid and T cells datasets are available from GEO\n“GSE154763” and “GSE156728”. COVID-19 and SLE datasets are available\nfrom GEO“GSE158055” and “GSE96583”. The mask matrix used in this\nwork is based on knowledge datasets from“GSEA [http://www.gsea-\nmsigdb.org/gsea/downloads.jsp]”. All other relevant data supporting the\nkey ﬁndings of this study are available within the article or the Supple-\nmentary Informationﬁles. Source data are provided with this paper.\nCode availability\nSoftware is available at“TOSICA [https://github.com/JackieHanLab/\nTOSICA]”58.\nReferences\n1. Sandberg, R. Entering the era of single-cell transcriptomics in\nbiology and medicine.Nat. Methods11,2 2–24 (2014).\n2. Butler, A., Hoffman, P., Smibert, P., Papalexi, E. & Satija, R.\nIntegrating single-cell transcriptomic data across different\nconditions, technologies, and species.Nat. Biotechnol.36,\n411–420 (2018).\n3. Stuart, T. et al. Comprehensive integration of single-cell data.Cell\n177, 1888–1902 e1821 (2019).\n4 . X u ,C .&S u ,Z .C .I d e n t iﬁcation of cell types from single-cell tran-\nscriptomes using a novel clustering method.Bioinformatics31,\n1974–1980 (2015).\n5 . X i e ,B .B . ,J i a n g ,Q . ,M o r a ,A .&L i ,X .R .A u t o m a t i cc e l lt y p ei d e n t i -\nﬁcation methods for single-cell RNA sequencing.Comput. Struct.\nBiotec. 19,5 8 7 4–5887 (2021).\n6. Abdelaal, T. et al. A comparison of automatic cell identiﬁcation\nmethods for single-cell RNA sequencing data.Genome Biol.20,\nhttps://doi.org/10.1186/s13059-019-1795-z(2019).\n7. Erfanian, N. et al. Deep learningapplications in single-cell omics\ndata analysis. Preprint atbioRxivhttps://doi.org/10.1101/2021.11.26.\n470166 (2022).\n8. Ma, Q. & Xu, D. Deep learning shapes single-cell data analysis\nCOMMENT.Nat. Rev. Mol. Cell Bio.23,3 0 3–304 (2022).\n9 . G o n g ,C . ,W a n g ,D . ,L i ,M . ,C h a n d r a ,V .&L i u ,Q .J .a .e . - p .V i s i o n\ntransformers with patch diversiﬁcation. Preprint athttps://arxiv.\norg/abs/2104.12753(2021).\n10. Ranftl, R., Bochkovskiy, A. & Koltun, V. J. a. e.-p. Vision transformers\nfor dense prediction. InProceedings of the IEEE/CVF International\nConference on Computer Vision,1 2 1 7 9–12188 (ICCV, 2021).\n11. Li, X. et al. Interpretable deep learning: interpretation, interpret-\nability, trustworthiness, and beyond.Knowl Inf Syst64,\n3197–3234 (2022).\n1 2 . V a s w a n i ,A .e ta l .A t t e n t i o ni sa l ly o un e e d .I nAdvances in\nNeural Information Processing SystemsVol. 32 (NeurIPS 2017);\nhttps://papers.nips.cc/paper/ 2017/hash/3f5ee243547dee91\nfbd053c1c4a845aa-Abstract.html .\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 12\n1 3 . A b n a r ,S .&Z u i d e m a ,W .J .a .e . - p .Q u a n t i f y i n ga t t e n t i o nﬂow in\ntransformers. Preprint athttps://arxiv.org/abs/2005.00928(2020).\n14. Dosovitskiy, A. et al. An image is worth 16 × 16 words: transformers\nfor image recognition at scale. Preprint athttps://arxiv.org/abs/\n2010.11929(2020).\n15. Alsaigh, T., Evans, D., Frankel, D. & Torkamani, A. Decoding the\ntranscriptome of calciﬁed atherosclerotic plaque at single-cell\nresolution.Commun Biol.5, 1084 (2022).\n16. Chou, C. H. et al. Synovial cell cross-talk with cartilage plays a major\nrole in the pathogenesis of osteoarthritis.Sci. Rep.10,\n10868 (2020).\n17. Baron, M. et al. A single-cell transcriptomic map of the human and\nmouse pancreas reveals inter- and intra-cell population structure.\nCell Syst.3,3 4 6–360 e344 (2016).\n18. Lawlor, N. et al. Single-cell transcriptomes identify human islet cell\nsignatures and reveal cell-type-speciﬁc expression changes in type\n2d i a b e t e s .Genome Res.27,2 0 8–222 (2017).\n19. Muraro, M. J. et al. A single-cell transcriptome atlas of the human\npancreas.Cell Syst.3,3 8 5–394 e383 (2016).\n20. Segerstolpe, A. et al. Single-cell transcriptome proﬁling of human\npancreatic islets in health and type 2 diabetes.Cell Metab.24,\n593–607 (2016).\n21. Xin, Y. et al. RNA sequencing of single human islet cells reveals type\n2d i a b e t e sg e n e s .Cell Metab.24,6 0 8–615 (2016).\n22. Zeisel, A. et al. Brain structure. Cell types in the mouse cortex and\nhippocampus revealed by single-cell RNA-seq.Science 347,\n1138–1142 (2015).\n23. Saunders, A. et al. Molecular diversity and specializations among\nthe cells of the adult mouse brain.Cell174,1 0 1 5–1030 e1016 (2018).\n2 4 . R o s e n b e r g ,A .B .e ta l .S i n g l e - c e l lp r oﬁling of the developing mouse\nbrain and spinal cord with split-pool barcoding.Science 360,\n176–182 (2018).\n25. Tabula Muris, C. et al. Single-cell transcriptomics of 20 mouse\norgans creates a Tabula Muris.Nature 562,3 6 7–372 (2018).\n26. Bastidas-Ponce, A. et al. Comprehensive single cell mRNA proﬁling\nreveals a detailed roadmap for pancreatic endocrinogenesis.\nDevelopment146, https://doi.org/10.1242/dev.173849(2019).\n27. Tabula Muris, C. A single-cell transcriptomic atlas characterizes\nageing tissues in the mouse.Nature 583,5 9 0–595 (2020).\n28. Alquicira-Hernandez, J., Sathe, A., Ji, H. P., Nguyen, Q. & Powell, J. E.\nscPred: accurate supervised method for cell-type classiﬁcation\nfrom single-cell RNA-seq data.Genome Biol.20, 264 (2019).\n29. Aran, D. et al. Reference-based analysis of lung single-cell\nsequencing reveals a transitional proﬁbrotic macrophage.Nat.\nImmunol.20,1 6 3–172 (2019).\n3 0 . B o u f e a ,K . ,S e t h ,S .&B a t a d a ,N .N .s c I Du s e sd i s c r i m i n a n ta n a l y s i st o\nidentify transcriptionally equivalent cell types across single-cell\nRNA-Seq data with batch effect.iScience23,1 0 0 9 1 4( 2 0 2 0 ) .\n31. Cao, Y., Wang, X. & Peng, G. SCSA: a cell type annotation tool for\nsingle-cell RNA-seq data.Front. Genet.11, 490 (2020).\n3 2 . C a o ,Z .J . ,W e i ,L . ,L u ,S . ,Y a n g ,D .C .&G a o ,G .S e a r c h i n gl a r g e - s c a l e\nscRNA-seq databases via unbiased cell embedding with Cell\nBLAST. Nat. Commun.11, 3458 (2020).\n33. Choi, J. H., In Kim, H. & Woo, H. G. scTyper: a comprehensive\npipeline for the cell typing analysis of single-cell RNA-seq data.\nBMC Bioinforma.21,3 4 2( 2 0 2 0 ) .\n3 4 . d eK a n t e r ,J .K . ,L i j n z a a d ,P . ,C a n d e l l i ,T . ,M a r g a r i t i s ,T .&H o l s t e g e ,F .\nC. P. CHETAH: a selective, hier a r c h i c a lc e l lt y p ei d e n t iﬁcation\nmethod for single-cell RNA sequencing.Nucleic Acids Res.47,\ne95 (2019).\n35. Duan, B. et al. Learning for single-cell assignment.Sci. Adv.6,\nhttps://doi.org/10.1126/sciadv.abd0855(2020).\n36. HanByeol Kim, J. L., Keunsoo, Kang & Seokhyun, Yoon MarkerCount:\na stable, count-based cell type identiﬁer for single cell RNA-Seq\nexperiments.Res. Sq.https://doi.org/10.21203/rs.3.rs-418249/v2\n(2021).\n37. Kiselev, V. Y., Yiu, A. & Hemberg, M. scmap: projection of single-cell\nRNA-seq data across data sets.Nat. Methods15,3 5 9–362 (2018).\n38. Li, C. W. et al. SciBet as a portable and fast single cell type identiﬁer.\nNat. Commun.11, https://doi.org/10.1038/s41467-020-15523-2\n(2020).\n3 9 . L i e b e r m a n ,Y . ,R o k a c h ,L .&S h a y ,T .C a S T L e— classiﬁcation of single\ncells by transfer learning: harnessing the power of publicly avail-\nable single cell RNA sequencing experiments to annotate new\nexperiments.PLoS ONE13\n, e0205499 (2018).\n40. Ma, F. & Pellegrini, M. ACTINN: automated identiﬁcation of cell\ntypes in single cell RNA sequencing.Bioinformatics36,\n533–538 (2020).\n41. Pliner, H. A., Shendure, J. & Trapnell, C. Supervised classiﬁcation\nenables rapid annotation of cell atlases.Nat. Methods16,\n983–986 (2019).\n42. Tan, Y. & Cahan, P. SingleCellNet: a computational tool to classify\nsingle cell RNA-seq data across platforms and across species.Cell\nSyst. 9,2 0 7–213 e202 (2019).\n43. Zhang, Z. et al. SCINA: a semi-supervised subtyping algorithm of\nsingle cells and bulk samples.Genes 10, https://doi.org/10.3390/\ngenes10070531(2019).\n4 4 . H e y m a n s ,C . ,D e g o s s e r i e ,J . ,S p o u r q u e t ,C .&P i e r r e u x ,C .E .P a n -\ncreatic acinar differentiation is guided by differential laminin\ndeposition.Sci. Rep.9,2 7 1 1( 2 0 1 9 ) .\n45. Okuma, T. et al. Regulation of mouse chondrocyte differentiation\nby CCAAT/enhancer-binding proteins.Biomed. Res.36,\n21–29 (2015).\n46. Karolak, M. R., Yang, X. & Elefteriou, F. FGFR1 signaling in hyper-\ntrophic chondrocytes is attenuated by the Ras-GAP neuroﬁbromin\nduring endochondral bone formation.Hum. Mol. Genet.24,\n2552–2564 (2015).\n47. Luecken, M. D. et al. Benchmarking atlas-level data integration in\nsingle-cell genomics.Nat. Methods19,4 1–50 (2022).\n48. Cheng, S. et al. A pan-cancer single-cell transcriptional atlas of\ntumor inﬁltrating myeloid cells.Cell 184,7 9 2–809 e723 (2021).\n49. Zheng, L. et al. Pan-cancer single-cell landscape of tumor-\ninﬁltrating T cells.Science 374, abe6474 (2021).\n50. Fabregat, A. et al. Reactome pathway analysis: a high-performance\nin-memory approach.BMC Bioinforma.18, 142 (2017).\n51. Dutertre, C. A. et al. Single-cell analysis of human mononuclear\nphagocytes reveals subset-deﬁning markers and identiﬁes circu-\nlating inﬂammatory dendritic cells.Immunity\n51,5 7 3–589\ne578 (2019).\n52. Haghverdi, L., Buettner, F. & Theis, F. J. Diffusion maps for high-\ndimensional single-cell analysis of differentiation data.Bioinfor-\nmatics 31,2 9 8 9–2998 (2015).\n53. Chakarov, S. et al. Two distinct interstitial macrophage populations\ncoexist across tissues in speciﬁc subtissular niches.Science 363,\nhttps://doi.org/10.1126/science.aau0964(2019).\n54. Shaw, A. C., Goldstein, D. R. & Montgomery, R. R. Age-dependent\ndysregulation of innate immunity.Nat. Rev. Immunol.13,\n875–887 (2013).\n55. Ren, X. et al. COVID-19 immune features revealed by a large-scale\nsingle-cell transcriptome atlas.Cell 184, 5838 (2021).\n56. Kang, H. M. et al. Multiplexed droplet single-cell RNA-sequencing\nusing natural genetic variation.Nat. Biotechnol.36,8 9( 2 0 1 8 ) .\n57. Hao, J. et al. IFN-gamma induces lipogenesis in mouse mesangial\ncells via the JAK2/STAT1 pathway.Am. J. Physiol. Cell Physiol.304,\nC760–C767 (2013).\n58. Jiawei C., Hao. X. & Jing-Dong, J. H. Transformer for one stop\ninterpretable cell type annotation.GitHub repository JackieHanLab/\nTOSICA, https://doi.org/10.5281/zenodo.7511202(2023).\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 13\n59. Wolf, F. A., Angerer, P. & Theis, F. J. SCANPY: large-scale single-cell\ngene expression data analysis.Genome Biol.19,1 5( 2 0 1 8 ) .\nAcknowledgements\nThis work was supported by grants from China Ministry of Science and\nTechnology (2020YFA0804000), National Natural Science Foundation\nof China (NSFC) (92049302, 32088101), and Shanghai Municipal Sci-\nence and Technology Major Project (2017SHZDZX01) to J.D.J.H.\nAuthor contributions\nJ.D.J.H. and J.C. conceived and designed the project. J.C. and H.X.\ndesigned and implemented the computational framework and con-\nducted benchmarks and case studies under the guidance of J.D.J.H. W.T.\ndownloaded and labeled two datasets and Z.C. and Y.Z. helped with the\ninitial design. H.X., J.D.J.H., and J.C. wrote the manuscript.\nCompeting interests\nThe authors declare no competing interests.\nAdditional information\nSupplementary informationThe online version contains\nsupplementary material available at\nhttps://doi.org/10.1038/s41467-023-35923-4.\nCorrespondenceand requests for materials should be addressed to\nJing-Dong J. Han.\nPeer review informationNature Communicationsthanks Andrew Chen,\nand the other, anonymous, reviewer(s)for their contribution to the peer\nreview of this work.\nReprints and permissions informationis available at\nhttp://www.nature.com/reprints\nPublisher’s noteSpringer Nature remains neutral with regard to jur-\nisdictional claims in published maps and institutional afﬁliations.\nOpen AccessThis article is licensed under a Creative Commons\nAttribution 4.0 International License, which permits use, sharing,\nadaptation, distribution and reproduction in any medium or format, as\nlong as you give appropriate credit to the original author(s) and the\nsource, provide a link to the Creative Commons license, and indicate if\nchanges were made. The images or other third party material in this\narticle are included in the article’s Creative Commons license, unless\nindicated otherwise in a credit line to the material. If material is not\nincluded in the article’s Creative Commons license and your intended\nuse is not permitted by statutory regulation or exceeds the permitted\nuse, you will need to obtain permission directly from the copyright\nholder. To view a copy of this license, visithttp://creativecommons.org/\nlicenses/by/4.0/.\n© The Author(s) 2023\nArticle https://doi.org/10.1038/s41467-023-35923-4\nNature Communications|          (2023) 14:223 14",
  "topic": "Annotation",
  "concepts": [
    {
      "name": "Annotation",
      "score": 0.8351842761039734
    },
    {
      "name": "Computer science",
      "score": 0.7506164908409119
    },
    {
      "name": "Interpretability",
      "score": 0.7419134974479675
    },
    {
      "name": "Artificial intelligence",
      "score": 0.5785506963729858
    },
    {
      "name": "Deep learning",
      "score": 0.561249315738678
    },
    {
      "name": "Transfer of learning",
      "score": 0.45956188440322876
    },
    {
      "name": "Autoencoder",
      "score": 0.42510196566581726
    },
    {
      "name": "Machine learning",
      "score": 0.39060884714126587
    }
  ],
  "institutions": [
    {
      "id": "https://openalex.org/I4210160507",
      "name": "Center for Life Sciences",
      "country": "CN"
    },
    {
      "id": "https://openalex.org/I20231570",
      "name": "Peking University",
      "country": "CN"
    }
  ],
  "cited_by": 160
}
{
  "title": "MarsGT: Multi-omics analysis for rare population inference using single-cell graph transformer",
  "url": "https://openalex.org/W4390636271",
  "year": 2024,
  "authors": [
    {
      "id": "https://openalex.org/A2099521366",
      "name": "Xiaoying Wang",
      "affiliations": [
        "The Ohio State University",
        "Shandong University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A5108891969",
      "name": "Maoteng Duan",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2102418880",
      "name": "Jingxian Li",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2748277261",
      "name": "Anjun Ma",
      "affiliations": [
        "The Ohio State University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A2136095299",
      "name": "Gang Xin",
      "affiliations": [
        "The Ohio State University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A2094446072",
      "name": "Dong Xu",
      "affiliations": [
        "University of Missouri"
      ]
    },
    {
      "id": "https://openalex.org/A2306024828",
      "name": "Zihai Li",
      "affiliations": [
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute",
        "The Ohio State University"
      ]
    },
    {
      "id": "https://openalex.org/A2150410584",
      "name": "Bingqiang Liu",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2092676467",
      "name": "Qin Ma",
      "affiliations": [
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute",
        "The Ohio State University"
      ]
    },
    {
      "id": "https://openalex.org/A2099521366",
      "name": "Xiaoying Wang",
      "affiliations": [
        "The Ohio State University",
        "Shandong University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A5108891969",
      "name": "Maoteng Duan",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2102418880",
      "name": "Jingxian Li",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2748277261",
      "name": "Anjun Ma",
      "affiliations": [
        "The Ohio State University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A2136095299",
      "name": "Gang Xin",
      "affiliations": [
        "The Ohio State University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A2094446072",
      "name": "Dong Xu",
      "affiliations": [
        "University of Missouri"
      ]
    },
    {
      "id": "https://openalex.org/A2306024828",
      "name": "Zihai Li",
      "affiliations": [
        "The Ohio State University",
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute"
      ]
    },
    {
      "id": "https://openalex.org/A2150410584",
      "name": "Bingqiang Liu",
      "affiliations": [
        "Shandong University"
      ]
    },
    {
      "id": "https://openalex.org/A2092676467",
      "name": "Qin Ma",
      "affiliations": [
        "The Ohio State University Comprehensive Cancer Center – Arthur G. James Cancer Hospital and Richard J. Solove Research Institute",
        "The Ohio State University"
      ]
    }
  ],
  "references": [
    "https://openalex.org/W3164102566",
    "https://openalex.org/W2984644935",
    "https://openalex.org/W1816511301",
    "https://openalex.org/W2900387735",
    "https://openalex.org/W2950814274",
    "https://openalex.org/W2989030274",
    "https://openalex.org/W2072921653",
    "https://openalex.org/W2790558187",
    "https://openalex.org/W2958554910",
    "https://openalex.org/W4205345182",
    "https://openalex.org/W6799554584",
    "https://openalex.org/W3180192281",
    "https://openalex.org/W2909811713",
    "https://openalex.org/W3010375621",
    "https://openalex.org/W2473258837",
    "https://openalex.org/W4321452549",
    "https://openalex.org/W3198168376",
    "https://openalex.org/W3168547639",
    "https://openalex.org/W4281257868",
    "https://openalex.org/W4295900303",
    "https://openalex.org/W6739901393",
    "https://openalex.org/W3012871709",
    "https://openalex.org/W3212664589",
    "https://openalex.org/W4306639438",
    "https://openalex.org/W3138479716",
    "https://openalex.org/W2910390900",
    "https://openalex.org/W2956840440",
    "https://openalex.org/W4313449211",
    "https://openalex.org/W3211534834",
    "https://openalex.org/W3029650759",
    "https://openalex.org/W4304806722",
    "https://openalex.org/W3044842300",
    "https://openalex.org/W3132661792",
    "https://openalex.org/W2790581709",
    "https://openalex.org/W2510746232",
    "https://openalex.org/W4229366049",
    "https://openalex.org/W6811248232",
    "https://openalex.org/W1977608023",
    "https://openalex.org/W2085043753",
    "https://openalex.org/W3164692211",
    "https://openalex.org/W6784195601",
    "https://openalex.org/W3174072032",
    "https://openalex.org/W1977258127",
    "https://openalex.org/W3094712772",
    "https://openalex.org/W2088883749",
    "https://openalex.org/W3016105251",
    "https://openalex.org/W4319591822",
    "https://openalex.org/W2997800206",
    "https://openalex.org/W2042652801",
    "https://openalex.org/W2301449312",
    "https://openalex.org/W2030692523",
    "https://openalex.org/W2172867687",
    "https://openalex.org/W1968799291",
    "https://openalex.org/W2524943084",
    "https://openalex.org/W2561322596",
    "https://openalex.org/W2794480084",
    "https://openalex.org/W3047725782",
    "https://openalex.org/W2898824002",
    "https://openalex.org/W2984472267",
    "https://openalex.org/W4393448247"
  ],
  "abstract": null,
  "full_text": "Article https://doi.org/10.1038/s41467-023-44570-8\nMarsGT: Multi-omics analysis for rare popu-\nlation inference using single-cell graph\ntransformer\nXiaoying Wang1,2,3,6,M a o t e n gD u a n1,6, Jingxian Li1,A n j u nM a2,3,G a n gX i n3,\nDong Xu4,5,Z i h a iL i3, Bingqiang Liu 1,7 &Q i nM a2,3,7\nRare cell populations are key in neoplastic progression and therapeutic\nresponse, offering potential intervention targets. However, their computa-\ntional identiﬁcation and analysis often lag behind major cell types. Toﬁll this\ngap, we introduce MarsGT: Multi-omics Analysis for Rare population inference\nusing a Single-cell Graph Transformer. It identiﬁes rare cell populations using a\nprobability-based heterogeneous graph transformer on single-cell multi-omics\ndata. MarsGT outperforms existing tools in identifying rare cells across 550\nsimulated and four real human datasets.In mouse retina data, it reveals unique\nsubpopulations of rare bipolar cells and a Müller glia cell subpopulation. In\nhuman lymph node data, MarsGT detectsa ni n t e r m e d i a t eBcell population\npotentially acting as lymphoma precursors. In human melanoma data, it\nidentiﬁes a rare MAIT-like population impacted by a high IFN-I response and\nreveals the mechanism of immunotherapy. Hence, MarsGT offers biological\ninsights and suggests potential strategies for early detection and therapeutic\nintervention of disease.\nMulticellular organisms encompass a diverse range of specialized cells.\nIdentifying these cell types is pivotal in immunotherapy and clinical\nscenarios, as it illuminates immune mechanisms, aids in devising tar-\ngeted therapies, and bolsters personalized medicine by unmasking the\nunique cellular makeup of each patient\n1. However, difﬁculties surface\nwhen encountering rare or transiently expressed cells2,3. Despite their\nscarcity, rare cell populations step up to play crucial roles in a variety of\nbiological processes\n4,5. For example, antigen-speciﬁc memory T cells\nare integral for sustained immunosurveillance and long-term immu-\nnity, even in infection-free periods\n6. Conversely, invariant natural killer\nT cells impact a variety of pathologies, including microbial infections\nand autoimmune diseases, due to their robust immunoregulatory\nfunctions\n7,8. Additionally, minimal residual disease, denoting the min-\nute cancer cell population post-treatment, acts as a signiﬁcant early\nindicator for potential tumor relapse, highlighting the necessity to\nidentify and comprehend these rare cell groups in disease dynamics\nand therapeutic interventions\n9,10.Ar e ﬁned grasp of these rare cell\npopulations, culminating in a more detailed depiction, will illuminate\nour understanding of tumor microenvironments and the intricate\nmechanisms that steer the responses to immunotherapy.\nThe advent of single-cell RNA sequencing (scRNA-seq) has vastly\nimproved our ability to identify individual cell types, offering high-\nresolution molecular proﬁles that illuminate cellular diversity and the\ncomplex dynamics of gene expression within speciﬁcc e l l s\n11,12.M o s t\nexisting rare cell identiﬁcation tools, such as FIRE 4,G a p C l u s t13,\nTooManyCells14, GiniClust15,R a c e I D2, and SCMER1,c o n f r o n ts e v e r a l\nchallenges, such as high false positives when inferring rare popula-\ntions, limited performance with complex samples like tumor biopsy\nReceived: 7 August 2023\nAccepted: 14 December 2023\nCheck for updates\n1School of Mathematics, Shandong University, Jinan, Shandong 250100, China.2Department of Biomedical Informatics, College of Medicine, The Ohio State\nUniversity, Columbus, OH 43210, USA.3Pelotonia Institute for Immuno-Oncology, The James Comprehensive Cancer Center, The Ohio State University,\nColumbus, OH 43210, USA.4Department of Electrical Engineering and Computer Science, University of Missouri, Columbia, MO 65211, USA.5Christopher S.\nBond Life Sciences Center, University of Missouri, Columbia, MO 65211, USA.6These authors contributed equally: Xiaoying Wang, Maoteng Duan.7These\nauthors jointly supervised this work: Bingqiang Liu, Qin Ma.e-mail: bingqiang@sdu.edu.cn; qin.ma@osumc.edu\nNature Communications|          (2024) 15:338 1\n1234567890():,;\n1234567890():,;\nsingle-cell data, inability to concurrently identify major and rare cell\ntypes, and compromised accuracy with ultra-rare cell types (<1% of the\nsample)\n14. These issues could stem from the limited representation of\nrare cells, which may lead to inaccurate grouping with more prevalent\ncell populations when solely relying on gene expression data. This\npursuit can be further accelerated by technological innovations like\nsingle-cell ATAC sequencing (scATAC-seq)\n12. When synergistically used\nwith scRNA-seq, these methodologies provide partial regulatory data\nconcerning enhancer regions pivotal in preserving cell type identities\n1.\nThis invaluable information can be tapped into for the construction of\ngene regulatory networks, thereby unraveling critical insights into the\nnature and function of rare cell populations\n16.\nMeanwhile, graph neural networks have recently demonstrated\nprofound proﬁciency in deciphering complex biological data, offering\nrobust backing for the precise analysis and study of scMulti-omics\ndata16–20. The implementation of the heterogeneous graph transformer\nprovides a uniﬁed framework that amalgamates diverse single-cell data\ntypes, thereby facilitating a comprehensive understanding of cellular\nheterogeneity\n16,21–23. This approach unveils the intricate interplay\namong various cell types within complex cellular landscapes, enhan-\ncing our comprehension of biological systems and bolstering oppor-\ntunities for precision therapeutic interventions.\nTo ﬁll the gap and validate the theory, we developed MarsGT\n(Multi-omics analysis forrare population inference usingsingle-cell\nGraph Transformer), an end-to-end deep learning model for rare cell\npopulation identiﬁcation from scMulti-omics data. Graph neural net-\nworks have recently demonstrated profound proﬁciency in modeling\nsingle-cell data\n24,25. Furthermore, our in-house tool, DeepMAPS16,h a s\nshown the superior performance of heterogeneous graph transformer\n(HGT), a powerful graph neural network architecture that can deal with\nlarge-scale heterogeneous and dynamic graphs, in biological network\ninference and cell clustering from the joint analysis of scMulti-omics\ndata. With such a foundation, MarsGT introduces a probability-based\nHGT framework to analyze scMulti-omics data from a heterogeneous\ngraph, including cells, genes, and peaks, which can build peak-gene\nregulatory relationships and utilize such relationships to characterize\nrare cell populations.\nMarsGT, as a probability-based subgraph-sampling method, can\nhighlight rare cell-related genes and peaks in a heterogeneous graph.\nWe conducted extensive simulations (n = 550) to thoroughly test the\naccuracy and robustness of MarsGT in identifying rare cell popula-\ntions. The performance of MarsGT, validated on the above simulation\ndata and four human peripheral blood mononuclear cell datasets,\nsurpassed existing methods in F1 score and Normalized Mutual\nInformation (NMI) metrics. To further showcase the application cap-\nability of MarsGT, we applied MarsGT on three scMulti-omics case\nstudies of (1) mouse retina, (2) human Fresh Frozen Lymph Node with\nlymphocytic lymphoma, and (3) melanoma patients and healthy\ndonors. Our results demonstrate that MarsGT can distinguish unique\nrare cell populations— a feat not achievable with other computational\ntools— and provide strategies for early clinical detection and the\ndevelopment of immunological blockers.\nResults\nOverview of the MarsGT framework\nMarsGT incorporates scRNA-seq and scATAC-seq data, and con-\ncurrently yields primary and rare cell populations along with their\nrespective regulatory relations (Fig.1 and Supplementary Fig. 1). A\nheterogeneous graph, comprising cells, genes, and enhancers, is\nconstructed from the initial scRNA-seq and scATAC-seq data, with the\npresence of genes and peaks within cells represented as edges. We\nposit that a gene ubiquitously expressed is less likely to be pivotal for\nidentifying rare cells compared to a gene that is expressed only within\nas p e c iﬁc subpopulation. To discern rare cells, it is imperative to\nidentify genes or peaks that are highly expressed in a target cell but\nexhibit low or no expression in other cells. We deﬁned such genes and\npeaks as rare-related genes and peaks. The genes/peaks within a cell\nare segmented into high or low-selection regions according to theﬁrst\nquartile of the expression/accessibility. For a given cell, the selection\nprobability of a gene/peak is determined by the proportion of gene/\npeak expression/accessibility in the high selection region. Such rare-\nrelated genes and peaks have a higher probability of being sampled to\nthe key features of rare cells in our multi-head attention graph trans-\nformer. The multi-head attention mechanism facilitates the update of\njoint embeddings of cells, genes, and peaks on the sampled subgraphs.\nThe cell assignment probability matrix and peak-gene link assignment\nprobability matrix are predicted post-learning joint embedding. The\npeak-gene relations and rare cell populations from the subgraphs are\nconcurrently determined and iteratively updated for model training.\nFurthermore, to safeguard that features pertinent to major cells are\nnot diminished, regularization terms are incorporated into the training\nprocess (Supplementary Fig. 2). The fully trained model is subse-\nquently applied to the entire heterogeneous graph, and a transcription\nfactor (TF) database is incorporated to construct cell cluster enhancer\ngene regulatory networks (eGRNs)\n12 (Methods).\nMarsGT achieves superior performances in rare and major cell\npopulation identiﬁcation simultaneously on simulated and\nreal data\nWe assessed the performance of MarsGT in identifying both rare and\nmajor cell populations across 550 simulated matched scRNA-seq and\nscATAC-seq datasets. To evaluate the performance of the tools on\ndistinct datasets, we simulated 100 datasets using highly homo-\ngeneous cell line data. Each simulation dataset contained 500 cells and\n2-3 cell types (Sim-CL 1, 2). To test these tools on heterogeneous data,\nwe simulated an additional 300 datasets using peripheral blood\nmononuclear cell (PBMC) data. Each simulation dataset contained 500\nc e l l sa n d2 - 3c e l lt y p e s( S i m - P B M C1 ,2 ,3 ,4 ,5 ,6 )( S u p p l e m e n t a r yD a t a1 ,\nMethods). Furthermore, to ensure that the simulation datasets more\nclosely resemble real data, we increased both the number of cell types\nand the number of cells. We generated 150 simulated datasets using\nperipheral blood mononuclear cells. Each simulation dataset con-\ntained 5000 cells and 5-15 cell types (Sim-PBMC 7, 8, 9) (Methods).\nEach simulated dataset included benchmark annotations from their\noriginal manuscripts. MarsGT wasﬁrst compared with CellCUIS\n26,\nFIRE4,a n dG a p C l u s t15, which operate as classiﬁcation-like tools, to infer\nrare cells only. The performance was evaluated based on the F1 score,\nPrecision, and Recall metrics for rare cell identiﬁcation performance.\nTo ensure fairness, each benchmarking tool was also tuned with dif-\nferent parameter combinations (Methods). We selected the parameter\ncombination for performance comparison based on the grid search\nbenchmarking of all the above tools. Speciﬁcally, if the mean score of a\nparameter combination achieves the highest across all datasets, we\nconsider it the default parameter (Methods). MarsGT outperformed all\nclassiﬁcation-like tools across Sim-CL 1-2 and Sim-PBMC 1-5 simulated\ndatasets (totaling 350) in terms of F1 score, Precision, and Recall\n(Supplementary Fig. 3, Supplementary Data 2, and Source Data 1).\nMarsGT also outperformed all classiﬁcation-like tools on the Sim-\nPBMC 7-9 simulated datasets (totaling 150) (Fig.2a, Supplementary\nFig. 4, and Source Data 2, 3). Furthermore, to verify MarsGT’sr a t eo f\nfalse positives, we compared it with other tools using the Sim-PBMC 6\ndataset (totaling 50), which lacks rare cells (Methods). The results\nconﬁrmed that MarsGT does not force the identiﬁcation of rare cell\npopulations (Supplementary Fig. 5, Supplementary Data 3, and\nSource Data 4).\nFurthermore, to evaluate MarsGT’s ability to identify major and\nrare cell populations simultaneously, we compared it with three\nclustering-like tools (GiniClust\n13,R a c e I D2, and SCMER1) using NMI,\nPurity, and Entropy metrics. In all simulation datasets, MarsGT sur-\npassed all clustering-like tools across all simulation datasets in terms of\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 2\nPurity and Entropy. Regarding the NMI index, GiniClust exhibited a\nsimilar performance to MarsGT (Fig.2b, Supplementary Figs. 4, 6,\nSupplementary Data 2, and Source Data 2, 3, 5). A cell type is classiﬁed\nas a rare cell type if it constitutes less than 3% of the total cells. How-\never, certain rare cells, such as senescent cells, can constitute an even\nsmaller proportion\n27. To assess each tool’s ability to identify these\nextremely rare cell types, we performed a gradient test with propor-\ntions of 0.5%, 1%, 2%, and 3% rare cells acrossﬁve simulated datasets. A\ndetailed comparison across all evaluation metrics demonstrated that\nMarsGT outperformed the existing top-performing tool in rare cell\nidentiﬁcation, exhibiting a superior F1 score that was 11.56%~143.49%\nhigher, across different proportions of rare cells (Supplementary\nFig. 7, Supplementary Data 4, and Source Data 6).\nTo evaluate MarsGT’s performance on real datasets, we chose four\ndatasets (PBMC-bench-1, 2, 3, and PBMC-test) from human peripheral\nblood mononuclear cells with ground truth labels. To maintain fair-\nness, we presented the performance in a bar plot, using default para-\nmeters for all benchmarking tools and showing the results of\nparameter combinations (Supplementary Data 5, 6). In real data, we\nseparately classiﬁed cell types constituting less than 3% and 1% of total\ncell counts as rare cell types. MarsGT achieved 100% and 63.71% higher\nF1 scores, compared to the second-best-performing tool (GiniClust),\nfor 1% and 3% simulated rare cell proportion identi ﬁcation,\nrespectively in the independent test dataset (PBMC-test) (Fig.2c).\nMarsGT delivered the best performance among all rare cell identiﬁ-\ncation tools, achieving an NMI score that was 7.14% higher than that of\nthe second-best-performing tool (GiniClust) in the independent test\ndataset (PBMC-test) (Fig.2c and Source Data 7). The cell clustering\nUMAP on an independent dataset with benchmarking labels illustrated\nthat MarsGT can accurately identify all rare cell types compared to\nother tools (Fig.2d). The cell clustering UMAP on an independent\ndataset with benchmarking labels illustrated that MarsGT can accu-\nrately identify all rare cell types compared to other tools(Supple-\nmentary Fig. 8, Supplementary Data 7, and Source Data 8), which\nconﬁrmed MarsGT’s robust stability.\nMarsGT effectively captures differential regulatory mechanisms\nand uncovers biologically meaningful rare cell populations\noften missed by other tools\nTo underscore MarsGT’s robust capability in identifying rare cell\npopulations within species beyond humans, we utilized MarsGT on\na published dataset involving matched single-nucleus RNA\nsequencing (snRNA-seq) and single-nucleus ATAC sequencing\n(snATAC-seq) performed on 9383 cells from the mouse retina\n(Supplementary Data 1). This study demonstrates MarsGT’s cap-\nabilities in discerning major and numerous rare cell populations,\nBuild heterogeneous graph\nCell-gene links\nCell-peak links\nSelect subgraphs\nGene(i) exp.\nCells ranked by exp.\nn cells\nm subgraphs\nPeaks Genes\nCells\nCells\nGenes\nPeaks\nInput data\nMessage passing\nEmbedding update\nLearn joint embeddings\nOutput\n1. Major cell clusters\n2. Rare cell clusters\n3. Cell cluster eGRN\nCell assignmentCells\nCell embeddings\n…\nPseudo cell clustersCells\n0.60 0.20 0.20\n0.10 0.60 0.05\n0.15 0.20 0.52\n0.10 0.09 0.77\n0.49 0.15 0.20\n…\nBuild peak-gene relation\nPeak-gene\nPeak embeddings Gene embeddings\n……\nPseudo cell clustersPeak-gene\n0.77 0.14 0.09\n0.42 0.45 0.13\n0.51 0.16 0.33\n0.10 0.77 0.13\n0.29 0.44 0.27\n…\nWhole-graph prediction\nApply to\nwhole graph\nSubgraphs Model\ntraining\nEpoch iteration\nTF\ndatabase\nTF\nHigh-order cells\nHigher selection possibility\nLower selection possibility\nSubgraph tends to\ninvolve more rare cells\nFig. 1 | The framework of MarsGT.The model employs a six-step process for cell\nclustering and eGRN inference from matched scRNA-seq and scATAC-seq data.\nFirst, a heterogeneous graph, comprised of cells, genes, and peaks, is constructed\nfrom the original scRNA-seq and scATAC-seq data. Genes and peaks serving as\nedges are selected for a cell if they show high accessibility/expression within that\ncell and low accessibility/expression in others. The second step is learning joint\nembedding, which employs four graph relations to pass the message via a het-\nerogeneous transformer. Arrows depict connections between target and source\nnodes. The third step involves cell assignment. Here, cell clusters are inferred from\na probability matrix with rows representing cells and columns indicating pseudo-\ncell clusters. Cells that share the same maximum probability belong to the same\ncluster. The fourth step is constructing the peak-gene relationship via a matrix\ncalculated from gene and peak embeddings, with rows denoting the regulatory\npotential of the peak to gene and columns indicating pseudo-cell clusters. In the\nﬁnal step, the trained model is applied to the entire graph. Following this, TF\ndatabase information is integrated to infer cell clusters and eGRNs. Circles repre-\nsent rare cell populations.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 3\nand we were able to identify 18 distinct cellular clusters, inclusive of\none amacrine cell (AC) group, eight bipolar cell (BC) groups, one\nCone cell group, one horizontal cell (HC) group, three müller glia\ncell (MG) groups, one retinal ganglion cell (RGC) group, and three\nRod cell groups (Fig. 3a). Moreover, 12 rare cellular populations\nwere distinguished, eight of which boast a 95% conﬁdence level as\nhighlighted by scPower\n28 (Fig. 3b). The annotation of major cell\npopulations was accomplished through the visualization of\nexpression levels pertaining to curated marker genes29–31 (Fig. 3c).\nThe populations of BC are known to exhibit a multitude of rare\npopulations. Utilizing MarsGT, we identiﬁed eight unique popula-\ntions of BC. These populations were annotated by visualizing the\nexpression levels of curated marker genes speci ﬁct ot h eB C\nsubpopulation\n32 (Fig. 3d). Excluding rod bipolar cell (RBC), all eight\na\nMarsGT GapClust CellSIUS GiniClustSCMERFIRE MarsGT RaceID\nSim-PBMC 7 Sim-PBMC 8\nSimulated datasets Simulated datasetsSimulated datasets Simulated datasets\nF1 score\nNMI Purity Entropy\nb\nRecallPrecisionF1 score Precision RecallF1 score\n1 PBMC-bench-2\n0 000 00\n1 PBMC-bench-3\n0 000 0 00\nPBMC-test1\n0 000000000 0 000\n1\n0\nPBMC-bench-1\n000 0 00\n1% rare population recognition 3% rare population recognitionc All cell clustering\nd\nUMAP-2\nUMAP-1\nMarsGT\nUMAP-2\nUMAP-1\nOriginal labels\n1%< rare population\n3%< rare population\nB1 B\nCD14+ Mono\nCD16+ Mono\nCD4+ T activated\nCD4+ T naïve\nCD8+ T\nCD8+ T naïve\nErythroblast\nG/Mprog\nHSC\nILC\nLymph prog\nMK/E prog\nNK\nNaïve CD20+ B\nNormoblast\nPlasma cell\nProerythroblas\ntTransitional B\ncDC2\npDC\nCellSIUS\nUMAP-2\nUMAP-1\nFIRE\nUMAP-2\nUMAP-1\nGapClustUMAP-2\nUMAP-1\nGiniClust\nUMAP-2\nUMAP-1\nRaceID\nUMAP-2\nUMAP-1\nSCMER\nUMAP-2\nUMAP-1\nSim-PBMC 9 Sim-PBMC 7 Sim-PBMC 8 Sim-PBMC 9\nNMI\nSimulated datasetsSimulated datasets\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 4\npopulations are regarded as rare cell populations at a 95% con-\nﬁdence level, as determined by scPower28.\nTo validate whether the rare cell populations we identiﬁed is a\nfalse positive, further testing is required. Hence, we inferred potential\ncell-cell communications and constructed communication networks\namong different BC populations using CellChat\n33. Notably, we identi-\nﬁed a non-canonical Wnt (ncWnt) signaling pathway originating from\nRBC and targeting both BC3 and BC6(Supplementary Fig. 9, Supple-\nmentary Data 8). Previous research has highlighted the role of Wnt5a\nand Wnt5b, produced by RBC, in activating a non-canonical signaling\npathway in rods, which in turn regulates early Outer Plexiform Layer\n(OPL) patterning\n34, thereby validating the accuracy of the rare cell\npopulations identiﬁed by MarsGT. We calculated the differentially\nexpressed genes (DEGs) for each population further to elucidate the\nfunctionality of these distinct BC populations. Based on the cell\npopulation-speciﬁc DEG list, we inferred the functional pathways for\neach cell population (Fig.3e). Notably, neuron migration was moder-\na t e l ye n r i c h e di nB C 1 B ,w h i c ha l i g n sw i t hi t st r a n s l o c a t i o nf r o mt h e\nbipolar to the amacrine cell layer. Categories such as axonogenesis and\nthe glutamate receptor signaling pathway revealed modest differences\namong BC clusters. Interestingly, extracellular ligand-gated ion chan-\nnel activity was predominantly enriched in OFF types, reﬂecting their\nemployment of ionotropic glutamate receptors\n35.\nInterestingly, our analysis distinguished cluster 10, which com-\nprises 127 cells, from cluster 2. Although both clusters are annotated as\nMG, cluster 10 stands out as a rare cell population. We denote cluster 2\nas MG-1 and cluster 10 as MG-2. In the original paper, the 127 cells are\nannotated as Rod (120) and MG (5) by scRNA-seq and marker gene\n36.\nTo further validate ourﬁndings, we utilized GiniClust15, the algorithm\nwith the second-best performance in our benchmarking section after\nMarsGT. GiniClust annotated the 127 cells as Rod (83 cells) and MG\n(41 cells) (Supplementary Fig. 10). This indicates that the rare MG\nidentiﬁed in our study, which was not found in the original text, are not\nfalse positives. We ventured further into exploring the functional dif-\nferences between the two MG clusters. Notably, we found MG-1 to be\nenriched in sprouting angiogenesis (Fig.3f), suggestive of potential\ndefects in retinal vascular development and a consequential functional\ndeﬁcit in MG, known to play a critical role in guiding outgrowing\nvessels\n37. MG-2 exhibited enrichment in the structural constituent of\neye lens function (Fig.3f). Thisﬁnding echoes the assertions of pre-\nvious research indicating that MG in both mature and embryonic retina\nbinds antibodies generated to a lens fraction enriched forα-crystallin,\nak e yl e n sp r o t e i n\n38. The eGRN of the structural constituent of eye lens\npathway related-gene is displayed in Supplementary Fig. 11 (Supple-\nmentary Data 9). We further visualized the eGRN for MG-1 and MG-2\n(Fig. 3g, Supplementary Data 10, 11 and Source Data 9). Compared to\nother methods, MarsGT effectively captures differential regulatory\nnetworks, successfully identifying biologically meaningful rare cell\npopulations that are often missed by RNA-only or other tools.\nTo further assert that MarsGT does not overlook pertinent infor-\nmation in the data while identifying rare cell populations, we initially\ncompute the differentially expressed genes of the predominant cell\npopulations. We identiﬁed top DEGs such asArr3, Gnat2,a n dPde6h,\nwhich act as marker genes forthe Cone. Additionally,hsd7a serves as\nt h em a r k e rg e n ef o rH C ,w h e r e a sApoe, Clu,a n dSlc1a function as\nmarker genes for MG.Meg3 is identiﬁed as the marker gene for RGC,\nand Nrl for Rod\n32 (Supplementary Fig. 12, Supplementary Data 12). The\nresults validate the accuracy of MarsGT in identifying the predominant\ncell populations. Utilizing the raw gene expression data and cell\npopulations, we deduced potential cell-cell communications and\nsubsequently constructed communication networks among different\ncell populations within multiple signaling pathways, facilitated by\nCellChat\n33. Notably, we discovered a VEGF signaling pathway extend-\ning from AC, MG, RGC, HC, MG, and Rod towards MG as the target\n(Supplementary Fig. 13, Supplementary Data 13), which is consistent\nwith the previous research\n30.\nMarsGT identiﬁes a rare state, B lymphoma-state-1, which offers\nthe potential in preventing B-lymphoma progression\nTo underscore MarsGT’s robust capability in identifying rare cell\npopulations within cancer data, we utilized a matched scRNA-seq and\nscATAC-seq dataset available on the 10X Genomics website (Supple-\nmentary Data 1). This data originated from 14,566 cells obtained from a\nﬂash-frozen intra-abdominal lymph node tumor in a patient diagnosed\nwith diffuse small lymphocytic lymphoma of the lymph node. MarsGT\nidentiﬁed 14 distinct cell clusters, which we annotated by visualizing\nthe expression levels of curated marker genes (Fig.4a, b). Notably, four\nof these clusters were annotated as B cells. To differentiate the sub-\npopulations of B cells, we visualized the expression levels of both\nnormal B marker genes and B lymphoma marker genes across the four\nsubpopulations (Fig.4c). We designated one subpopulation as normal\nB cell population and three as lymphoma cell populations: B\nlymphoma-state-1 (BLS1), B lymphoma-state-2 (BLS2), and B\nlymphoma-state-3 (BLS3). BLS1, a rare cell population, exhibits a 95%\nconﬁdence level, as indicated by scPower\n28. Intriguingly, it was evident\nthat B cell subpopulations annotated using solely RNA or ATAC data\ncould not be effectively distinguished (Fig.4c, Supplementary Fig. 14).\nWe also applied other scMulti-omics tools to the dataset for com-\nparative purposes. For instance, Seurat\n39 only identiﬁed two B cell\nsubpopulations with hard annotation by curated marker genes (Sup-\nplementary Fig. 15), while our in-house tool DeepMAPS identiﬁed only\nthree B cell subpopulations\n16. However, neither tool successfully\nidentiﬁed the rare cell cluster within the B cells.\nA pseudotime analysis on the four B cell clusters (comprising\nthe normal B cell populations and three B lymphoma cell popula-\ntions), using slingshot, postulated a lineage whereby the rare cell\npopulation BLS1 originates from the normal B cell populations. It\nwas inferred that BLS1 predates BLS2, which in turn predates BLS3\n(Fig. 4d, e). To substantiate this proposed linear-like developmental\ntrajectory, we computed gene signature scores\n40 reﬂecting different\nfunctions (anti-apoptosis, metastatic, and PD-PDL1) across the four\nB cell populations (Fig.4f, Supplementary Data 14, Supplementary\nData 15 and Source Data 10). These results depict a progressive\nprogression of B lymphoma from BLS1 to BLS3. Focusing onPDL1,a\ncritical gene in the PD1-PDL1 pathway that is promoted bySTAT1 and\nHIF1A, we observed more regulatory relations and intensity of\nSTAT1 and HIF1A in BLS3 (Fig.4g, h, Supplementary Data 16). This\nﬁnding is in line with our inferred linear-like development tendency.\nFurthermore, BCL2, an oncogenic gene that plays an anti-apoptotic\nrole in cancer and drives its progression\n41–44, demonstrated an\nincrementally enhanced regulatory score from normal B cells to\nBLS3 (Fig.4i, Supplementary Data 16), lending further credibility to\nFig. 2 | Benchmarking of MarsGT in terms of rare cell population identiﬁcation.\na Benchmark rare cell population identiﬁcation on Sim-PBMC 7, 8, 9 datasets with\nclassiﬁcation-like tools in terms of F1 score. The X-axis signiﬁes the dataset, while\nthe Y-axis presents F1 scores arranged in descending order.b Rare cell population\nidentiﬁcation on Sim-PBMC 7, 8, 9 datasets benchmarked with clustering-like tools\nevaluated via NMI scores. The X-axis signiﬁes the dataset, while the Y-axis denotes\nNMIs, organized in descending order.c Comparative results on three real training\ndatasets (PBMC-bench-1, 2, 3) and one independent test dataset (PBMC-test). Test\nparameters across all tools are determined by the most optimal results obtained\nfrom the training dataset.d The UMAPS results for the independent PBMC-test\ndataset were calculated using PCA and predicted cell clusters in the tools. The\npurple and orange ellipses represent rare cell populations constituting less than 1%\nand 3%, respectively. Tools like FIRE and GapClust can distinguish only between\nmajor and rare populations in a binary fashion based on their method design.\nCellSISU, due to its design, can identify several rare cell populations but cannot\nrecognize major ones. Source data are provided as a Source Dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 5\nUMAP-2\nUMAP-1\na\nRod\nCone\nMG\nBC\nHC\nAC\nRGC\nNrl\nPde6h\nArr3\nGnat2\nDbi\nApoe\nSlc1a3\nSparc\nTrpm1\nlsl1\nGrm6\nTrnp1\nPcskln\nTpm3\nPax6\nMeg3\n0\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\n14\n15\n16\n17cd\nBC1\nBC2\nBC4\nRBC\n3 7 8 9 11 12 13 16\nPde6h\nVsx1\nScgn\nGrik1\nGria1\nScgn\nVstm2b\nCasp7\nBC8/9 Grm6\nBC7 Igfn1\nBC6 Cck\nBC5 Sox6\nBC3 Erbb4\nFraction of cells in group (%) Mean expression in group F raction of cells in group (%) Mean expression in group\n3: RBC\n8: BC6\n13: BC7\n4: RGC\n9: BC5\n14: AC\n1: ROD-2\n6: ROD-3\n11: BC1\n16: BC8/9\n2: MG-1\n7: BC3\n12: BC4\n17: HC\nf\n0.50\n0.75\n1.00\n1.25\n1.50\n1.75\n2.00\n2.50\nMulticellular organismal signaling\nCellular response to metal ion\nNeuron migration\nRegulation of pre-synapse assembly\nCentral nervous system neuron differentiation\nCell communication involved in cardiac conduction\nCardiac muscle cell action potential\nPotassium ion transmembrane transporter activity\nGlutamate receptor signaling pathway\nCollateral sprouting\nLearning\nLocomotory behavior\nRegulation of ion transmembrane transport\nPositive regulation of neurogenesis\nExtracellular ligand-gated ion channel activity\nRegulation of neurogenesis\nAxonogenesis\nMain axon\nSynapse organization\nRegulation of synapse organization organization\nAxon guidance\n2.25\neb-new\n5: Cone\n10: MG-2\n15: MG-3\n0: ROD-1\nBC subclusters\n200 4000 2500 4000\n0\n1\n2\n3\n4\n5\n6\n7\n8\n11\n12\n13\n14\n15\n16\n17\n9\n10\nNumber of cells\nCell clusters\n4061\n2568\n475\n447\n411\n378\n25\n184\n170\n118\n92\n78\n75\n16\n11\n16\n131\n127\n3% rare population1% rare population\ng\nEnrichment score\n6000\n0.0\n0.2\n0.4\n0.6\n2000 40000\nSprouting angiogenesis\nStructural constituent of eye lens\nEnrichment score\nPosition in the ranked gene list\nFDR = 0.0272\n2000 4000 60000\n0.0\n0.2\n0.4\n0.6Enrichment score\nFDR = 4e-04\nPosition in the ranked gene list\nMG-1 MG-2\nchr17:46903462-46905951\nchr17:46908034-46935184\nchr1:86530872-86534144\nchr1:86523754-86529335\nchr6:91658217-91670921\nchr6:91682646-91699915\nchr14:55535886-55536560\nchr14:55513392-55528588\nchr3:51386035-51390595\nchr3:51391565-51398043\nCdh2 chr2:25455967-25462580\nchr2:25464829-25470689chr18:16805511-16810048\nchr7:19697534-19699568\nchr7:19700622-19701707\nchr2:29191479-29193244\nchr2:29194127-29196308\nchr19:22904920-22905638\nchr19:22915694-22917441\nchr14:93884489-93884889\nchr14:93889803-93891556\nchr10:105572361-105572903\nchr10:105573420-105575715\nchr14:65967765-65971877\nClu\n1234\nChromatin accessibility\nchr2:148870185-148879583\nchr2:148889499-148891378\nchr5:115427353-115443434\nchr5:115444126-115455208\nchr2:29191479-29193244\nchr2:29194127-29196308\nchr9:40804896-40805760\nchr9:40798483-40802472\nApoe\nCfap77\nTmtc2\nTrpm3\nPcdh9\nSetx\nMsi1\nPtgds\nCst3\nPrph2\nMgarp\nNrl\nSlc6a6\nHspa8\nPtma\nShared regulation\nchr2:29194127-29196308\nchr2:29191479-29193244\nTtf1\nAcsl3\nchr1:78655331-78660178\nBsg\nchr10:79710004-79713901\nchr10:79699872-79709419\nchr14:65998865-66007119chr14:65980800-65983085\n95% statistically significant\nFig. 3 | MarsGT effectively captures differential regulatory mechanisms and\nuncovers biologically meaningful rare cell populations often missed by\nother tools. aA UMAP visualizing the cell clusters predicted by MarsGT, annotated\nbased on marker genes.b The number of cells in each cell cluster, with the red color\nsignifying a 95% conﬁdence level for rare cell populations.p-values were calculated\nbased on two-tail negative binomial test. Multiple testing correction was performed\nby using FDR-adjustedp-values for scPower calculation.c Dotplot depicts the\nexpression value and proportion of marker genes for the cell clusters predicted by\nMarsGT. d Dot plot represents the expression value and proportion of BC marker\ngenes for the cell clusters predicted by MarsGT.e The enrichment score across\neach pathway is calculated using differentially expressed genes (DEGs) across\nvarious BC subpopulations. Pathways within the red box have been validated in the\nliterature.f Pathway enrichment as determined by Gene Set Enrichment Analysis\n(GSEA), based on the DEGs of MG-1 and MG-2. The structural constituent of the eye\nlens is the pathway enriched in MG-2, and Sprouting angiogenesis is the pathway\nenriched in MG-1.g The different peak-gene networks of MG-1 and MG-2. Rec-\ntangles symbolize the peaks, and their colors represent the mean accessibility of\nthe peak in the cell population. Accessibility levels ranging from 0 to 0.1 are\ndenoted as 1, those from 0.1 to 0.5 as 2, from 0.5 to 1 as 3, and anything above 1 is\ndenoted as 4. The color of the line and circle represent the cell populations. The\norange color signiﬁes genes or relationships unique to MG-1, green indicates those\nunique to MG-2, while blue represents genes or relationships shared between MG-1\nand MG-2.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 6\nour inference. The scATAC-seq tracks ofSTAT1, HIF1A and BCL2 are\nshown in Fig. 4j and Supplementary Fig. 16. Exploring BLS1 in\ngreater depth, we compared the disparities among the four B cell\nclusters and identiﬁed a unique TF for BLS1, namely, MEF2C, along\nwith switch-enhancer corresponding TFs: POU2F2, FOXP1, SPI1, and\nNFIC. Simulating a knockout experiment\n45 involving these ﬁve TFs\nrevealed a shift in B lymphoma cells towards normal B cells, sug-\ngesting that identifying the rare BLS1 state could offer potential\navenues for curbing B-lymphoma progression (Fig. 4k, l,\nSupplementary Fig. 17). It has been reported previously that MEF2C\nmutations lead to deregulated expression of theBCL6 oncogene in\nB lymphoma\n46,47, and that POU2F2 reﬂects the survival of B cell\nmalignancies48. Additionally, FOXP1 is known to suppress immune\nresponse49–52. The roles of SPI1 and NFIC, as inferred by MarsGT, may\nprovide fresh insights into therapeutic strategies for B lymphoma.\nIn short, MarsGT can effectively identify a rare subset of B cells,\nBLS1, provides valuable insights into B-lymphoma progression, and\nopens new avenues for potential interventions, thereby advancing\nSignature activity score\nUMAP-2\nUMAP-1\na c\nUMAP-2\nUMAP-1\nUMAP-2\nUMAP-1\nd e\n0.0\n0.5\n1.0\nAnti-apoptosis\n(KEGG: hsa04210)\nMAPK signaling\n(KEGG: PATH:hsa04010)\nPD-1 checkpoint\n(KEGG: hsa05235)\np=0.0061\np=6.3e-07\np=0.00091\np=0.074\np=2.22e-16\np=1.9e-14\np=0.0098\np=1.2e-10\np=4.3e-10\n0 (BLS2)\n10 (Normal B)\n13 (BLS1) \n6 (BLS3)\nFraction of cells in group (%)\nMean expression in group\nb 0\nCGR3A\nLYZ\nCD14\nITGAM\nCD40\nPAX5\nBANK1\nMS4A1\nCD79A\nCD19\nCD8A\nCD4\nSELL\nCCR7\nCD3E\nCD3D\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\n13\nCD274\nCSF1R\nf\ng\nRegulatory score Expression\nchr18:63319757-63320675\nchr18:63317821-63318709\nchr18:63312714-63313504\nchr18:63311355-63312237\nchr18:63292654-63293569\nchr18:63285083-63285875\nchr18:63309284-63310099\nchr18:63290575-63291481\nchr18:63298500-63299384\nBCL2\ni POU2F2 KO\nUMAP-2\nUMAP-1\nk FOXP1 KO\nUMAP-2\nUMAP-1\nl\nchr2:191013783-191014702\nchr2:191030345-191031207\nchr2:191003470-191004164 \nchr2:191029150-191029855 \nchr2:191038093-191038980\nSTAT1\nchr14:61694932-61695818\nchr14:61670845-61671695\nchr14:61662220-61663084\nHIF1Ah\nRegulatory score Expression Regulatory score Expression\n10: B\n1: DP\n2: CD8 T\n3: DP\n4: CD4 T\n5: Macrophage\n6: B\n7: CD8 T\n8: CD8 T\n9: Macrophage\n11: CD4 T\n12: CD4 T\n0: B\n13: B\nj\n08\n02 3\n05\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 7\nour understanding of cellular disease dynamics and fostering\ninnovative medical research and treatment strategies.\nMarsGT identiﬁes MAIT-like rare cell populations and eGRNs in\nmulti-sample melanoma scRNA-seq and scATAC-seq\nTo broaden MarsGT’s scope in multi-sample and rare cell population\ninference, we utilized ten matched scRNA-seq and scATAC-seq samples\nof peripheral blood mononuclear cells (PBMCs) from melanoma\npatients at baseline (prior to receiving anti-PD1 therapy) and healthy\ndonors. Of these, two samples were from healthy donors, while the\nremaining eight were from melanoma patients. MarsGT identiﬁed 13\ndistinct cell clusters from the integrated dataset of these ten samples,\nwhich include one CD4 + T cell group, three CD8 + T cell groups, two\nCD14+ monocytes (Mono) cell groups, one B cell group, one Nature\nkilling (NK) cell group, one FCGR3A+ Mono cell group, and three Den-\ndritic (DC) cell group. These clusters were annotated by visualizing the\nexpression levels of curated marker genes in the major cell populations\n(Fig. 5a, b). DEGs for each cell population were calculated and repre-\nsented in a heatmap (Supplementary Fig. 18). Notably, we observed two\nrare cell populations within the CD8 + T cells, namely, Cluster 9 and\nC l u s t e r1 2 .T h eD E G sa c r o s st h e s et h r e eC D 8 + Tc e l lp o p u l a t i o n sw e r e\ncomputed (Supplementary Fig. 19, Supplementary Data 17), leading to\nthe identiﬁcation of top DEGs such as ZBTB16 and SLC4A10 in Clusters 9\nand 12. These genes act as markers for Mucosal Associated Invariant\nT cells (MAIT), recognized as a crucial rare cell population in immune\nresponses. To delve deeper into the cell populations within Clusters 9\nand 12, we visualized additional MAIT marker genes (Fig.5c). Given that\nboth MAIT and Natural Killer T (NKT) cells are non-canonical T cells and\nshare similarities in their functions and partial marker genes, we com-\nputed the gene signature enrichment scores for MAIT and NKT\nrespectively. The MAIT score was signiﬁcantly higher than the NKT score\n(Fig.5d, Supplementary Data 18 and Source Data 11), leading us to deﬁne\nCluster 9 as MAIT-like 1 and Cluster 12 as MAIT-like 2.\nWe constructed the eGRN of the three CD8 + T cell populations\nand found that common enhancers and genes in the three cell popu-\nlations constituted the majority proportion (Fig.5e, f, Supplementary\nData 19). Meanwhile, each cell population demonstrated unique\nenhancers and genes, indicating that MAIT-like 1 and MAIT-like 2\nrepresent different MAIT-like subpopulations, each endowed with\nunique functional attributes. To support this observation, we inferred\nthe pathways enriched in the MAIT-like cell population based on the\ncell population’s active gene expression in the eGRNs (Fig.5g). MAIT-\nlike 1 and MAIT-like 2 shared several pathways, including Regulation of\nI-kappaB kinase/NF-kappaB Signaling, which play signiﬁcant roles in\nimmune responses. Unique to MAIT-like 1 were pathways such as\nPositive Regulation of Cytokine Production Involved in Immune\nResponse, Interleukin-12-Mediated Signaling Pathway, and Regulation\nof Type I Interferon Production. The MAPK Cascade pathway was\nunique to MAIT-like 2, further differentiating these two subpopula-\ntions. Divergent regulatory patterns became apparent when we\nfocused on a single regulon, ZBTB16, recognized as a critical tran-\nscription factor in MAIT cells. We visualized the expression of the\ngenes it regulates, as well as the average accessibility value of the peaks\nassociated with these regulated genes (Fig.5h). We further mapped the\nregulatory relationships of ZBTB16 within the two MAIT-like cell\npopulations (Fig.5i). Interestingly, our results highlight minor differ-\nences in expression and accessibility, but more substantial variations\nin regulatory relationships. This supports our hypothesis that reg-\nulatory information is pivotal in recognizing rare cell populations.\nMarsGT reveals the mechanism for different survival of PD1-\nblocking immunotherapy\nThe above ten sample datasets we analyzed incorporated immu-\nnotherapy data from eight melanoma patients, grouped according\nto their Interferon-I response capacity (IRC). Four patients exhib-\nited high IRC, as determined by the levels of Interferon-I stimulated\nproteins measured by mass cytometry, while the remaining four\ndemonstrated low IRC (Supplementary Fig. 20). The source study\ninferred that a hyporesponsive IRC effectively predicted extended\nsurvival following PD1-blocking immunotherapy, while high\nresponsiveness strongly associated with treatment failure and\nreduced survival duration. Interestingly, we observed that in both\nMAIT-like 1 and MAIT-like 2 cells, samples with low IRC represented\na majority, accounting for 83.57% and 70.18%, respectively, aﬁgure\nsigniﬁcantly higher than those with high IRC (Fig.6a). Given the\npotential signiﬁcance of MAIT-like 1 cells in understanding the\nsurvival mechanisms underpinning PD1-blocking immunotherapy,\nwe decided to investigate this cell population further (MAIT-like 2,\nwith only 69 cells, was excluded due to potential low conﬁdence).\nWe found 176 MAIT-like 1 cells in the high IRC group, compared to\n895 cells in the low IRC group (Fig.6b). Additionally, the count of\nDCs in the low IRC group exceeded those in the high IRC group. We\ncompared the expression of IFN-I stimulated genes (ISGs) between\nhigh and low IRC patients.\nContrary to the IRC assignments, ISG expression in low IRC\npatients was signiﬁcantly higher than in high IRC patients (Fig.6ca n d\nSource Data 12). Upon calculating the unique enhancers in the eGRNs\nof high IRC and low IRC groups, respectively, we found that tran-\nscription factors TCF1 and BCL6 were exclusively present in the low\nIRC group. Previous studies have demonstrated that the TCF1-Bcl6 axis\ncounteracts type I interferon to repress exhaustion and maintain T cell\nstemness\n53. Then we calculated the effector and exhaustion gene sig-\nnature scores for MAIT cells in high IRC and low IRC groups, respec-\ntively (Fig.6d, Supplementary Data 20 and Source Data 13). MAIT-like\n1 cells in the high IRC group appeared exhausted, while those in the low\nIRC group appeared effective. This observation may explain the\nFig. 4 | MarsGT identiﬁes the rare cells in the intermediate transition state on B\nlymphoma data. aUMAP visualizes cell clusters predicted by MarsGT, annotated\nbased on the marker genes.b Dot plot demonstrates the expression value and\nproportion of marker genes within the cell clusters predicted by MarsGT.c A\nstacked violin plot represents the subpopulations of B cells, annotated with the\nmarker genes for both normal and tumorous B cells.d A cell development trajec-\ntory for the four B cell subpopulations, with the line representing the lymphoma\ndevelopment trajectory.e The pseudotime of the four B cell subpopulations.f The\ngene signature scores of anti-apoptosis, metastatic, and PD-PDL1 pathways. Each\nbox showcases the minimum,ﬁrst quartile, median, third quartile, and maximum\ngene signature enrichment scores of different pathways in four cell clusters\n(Cluster 0:n = 2754, Cluster 6:n = 731, Cluster 10:n = 456, Cluster 13:n = 72).\np-values were calculated based on two-tailt-test. Color represents cell clusters, and\nthe Y-axis is the enrichment score.g The regulatory relationship of the PDL1 gene\nacross the four B cell subpopulations. The red color signiﬁes the regulatory score\nfor each enhancer of the STAT1 coding gene across different B cell subpopulations,\nwhile blue indicates gene expression.h The regulatory relationship of the PDL1\ngene across the four B cell subpopulations. The red color signiﬁes the regulatory\nscore for each enhancer of the HIF1A coding gene across different B cell sub-\npopulations, while blue denotes gene expression across these subpopulations.\ni The regulatory relationship of the BCL2 gene (an anti-apoptosis promoting gene)\nacross the four B cell subpopulations. The red color represents the regulatory score\nof each enhancer for the BCL2 coding gene across different B cell subpopulations,\nwhile the blue color represents gene expression in these subpopulations.j The\nCoverage plot for gene BCL2. The Coverage Plot encompasses the tracks of\nscATAC-seq (upper), peak links (lower), and gene expression (right).k Observed\nand extrapolated future states (depicted as arrows) following the POU2F2 knockout\nin the four B cell subpopulations. The color represents the different cell clusters.\nl Observed and extrapolated future states (depicted as arrows) following the FOXP1\nknockout in the four B cell subpopulations. The color represents the different cell\nclusters. Source data are provided as a Source Dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 8\nvarying IRC across samples and the improved prognosis for low IRC\npatients following PD1-blocking immunotherapy.\nHigh IRC suppressed MAIT-like 1 cells response by triggering high\ninterleukin-10 (IL-10) production by DC, which subsequently inhibited\nthe secretion of IL-15, IL-18 which are costimulatory cytokines for\nMAIT-like 1 cell activation. This observation is supported by the\nexpression levels of the genes coding for these cytokines and their\nrespective receptors (Fig.6e–ga n dS o u r c eD a t a1 4–16). The effector\nfunctions of MAIT-like 1 cells are mediated through the production of\nIFN-II, GzmB, and Perforin (Fig.6h). Our attention then turned to the\nregulatory mechanisms of IFN-II, GzmB, and Perforin in the high and\nlow IRC contexts. In low IRC, IFN-I signaling is relayed by Tyk2-NFKB to\nregulate IFNG (the coding gene of IFN-II), and relayed by Jak1-STAT1 to\nregulate GZMB. IL-15 signaling is relayed by Jak1/Jak3-STAT1 to regulate\nGZMB, while IL-18 signaling is relayed by JNK-NFKB to regulate IFNG\nand by JNK-FOS/JUN to regulate GZMB and PRF1 (the coding gene of\nPerforin). In contrast, high IRC sees only IL-18 signaling relayed by JNK-\nFOS/JUN to regulate PRF1 (Fig.6i). The complete GRNs of IFNG, GZMB,\nSYTL2\nPTPRC\nRPS9\nSIPA1L1\nRNF149\nCELF2\nJMJD1C\nCCSER2\nRCL1\nGLS\nNKG7\nIQGAP2\nUMAP-2\nUMAP-1\na\nNK cell\nFCGR3A Monocyte\nCD14 Monocyte 2\nDC 1\nCD14 Monocyte 3\nCD8+ T 2\nDC 2\nDC 3\nCD8+ T 1\nCD14 Monocyte 1\nB cell\nCD4+ T 1\nCD8+ T 3\nNK cell\nFCGR3A Monocyte\nCD14 Monocyte 2\nDC 1\nCD14 Monocyte 3\nCD8+ T 2\nDC 2\nDC 3\nCD8+ T 1\nCD14 Monocyte 1\nB cell\nCD4+ T 1\nCD8+ T 3\nb\nc d\nef h\nGene signature score\nCCR6 ZBTB16 RORC SLC4A10\nKLRB1 IL18R1 CCR4 IL7RCD8A\nCD3E\nUMAP-2\nUMAP-1\np=3.31e-236\n6\n5\n4\n3\n2\n1\n0\np=7.74e-11\n2.5\n2.0\n1.5\n1.0\n0.5\n0\nMAIT-like 1 MAIT-like 2\nCD4\nCD8A\nCD19\nCD22\nMS4A1\nGNLY\nNKG7\nFCER1A\nCST3\nCD14\nLYZ\nFCGR3A\nMS4A7\n0\n1\n2\n3\n4\n5\n6\n7\n8\n9\n10\n11\n12\nFraction of cells (%)\nMean expression\nMAIT signatureNKT signature\n2 0 2\n-log(adj.p.value)\n4\nRegulation Of Type I Interferon Production\nInterleukin−15−Mediated Signaling Pathway\nPositive Regulation Of CD8−positive, Alpha−Beta T Cell Activation\nPositive Regulation Of Angiogenesis\nPositive Regulation Of Cytokine Production Involved In Immune Response\nPositive Regulation Of Cytokinesis\nRegulation Of I−kappaB kinase/NF−kappaB Signaling\nPositive Regulation Of T Cell Activation\nInterleukin−12−Mediated Signaling Pathway\nRegulation Of Programmed Cell Death\nPositive Regulation Of T Cell Mediated Immunity\nRegulation Of T Cell Cytokine Production\nNegative Regulation Of CD4−positive, Alpha−Beta T Cell Activation\nMAPK Cascade\nNIK/NF−kappaB Signaling\nPositive Regulation Of Signal Transduction By P53 Class Mediator\nPositive Regulation Of I−kappaB kinase/NF−kappaB Signaling\ng\nMAIT-like 1 MAIT-like 2 0.1 0.3\nEnrichment score\ni\nCellular Response To Tumor Necrosis Factor\nCellular Response To Interleukin−12\nCellular Response To Type II Interferon\ncalcineurin−NFAT Signaling Cascade\nMean expression\nMAIT-like 1\nMAIT-like 2\nMAIT-like 1\nMAIT-like 2\nMean chromatin activity score\nCELF2\nchr10:11162828-11163731chr5:76402535-76403437\nIQGAP2\nchr1:198620935-198621840\nPTPRC\nchr10:63268788-63269663\nJMDF1C\nchr11:85752589-85753493\nSYTL2\nchr2:190881662-190882529\nRNF149\nchr14:71324553-71325443\nSIPA1L1\nMAIT-like 1 MAIT-like 2\nZBTB16\nGLS\nchr2:190881662-190882529 chr10:11178386-11179241\nCELF2\nchr10:84333777-84334687\nCCSER2RCL1\nchr9:4938812-4939703\nchr19:51372411-51373335\nNKG7\nchr19:54210656-54211490\nRPS9\nZBTB16\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 9\nand PRF1 are depicted in Supplementary Fig. 21. Interestingly, we\nobserved a higher number of positive regulatory relations in low IRC\ncompared to high IRC. This suggests a critical role for low IRC in\nfacilitating the elimination of tumor cells. In other words, compared to\nsamples with high IRC, those with low IRC stimulate the expression of\ncytokine and cytolytic molecule coding genes in CD8+ T cells via var-\nious costimulatory factors and pathways. This leads to the enhanced\nsecretion of IFN-γ,T N F -α, Granzyme B, and Perforin, which in turn\nboosts the cytotoxic function of CD8+ T cells, promoting more\neffective tumor destruction.\nDiscussion\nMarsGT is an end-to-end deep learning model capable of inferring and\nidentifying rare cell populations from scMulti-omics data using a het-\nerogeneous graph transformer. To model and represent the scMulti-\nomics data, a heterogeneous graph is constructed, comprising nodes\nof cells, genes, and peaks. This conﬁguration allows for the updating of\njoint embeddings of cells, genes, and peaks, facilitated by a multi-head\nattention mechanism. An end-to-end model beneﬁts rare cell identiﬁ-\ncation as it integrates scMulti-omics data with minimal information\nloss. The graph transformer can enhance the signal-to-noise ratio,\naddressing the high dropout feature of single-cell technologies, which\nin turn reduces the false positive rate in rare cell identiﬁcation. Cru-\ncially, MarsGT employs a probability-based subgraph-sampling tech-\nnique during model training, which allows the selective highlighting of\ncell-gene and cell-peak relationships that are relevant to rare cells. In\nparallel, the model determines peak-gene relations and rare cell\npopulations from the subgraphs, undergoing iterative updates during\nthe training process. Consequently, MarsGT is well equipped to iden-\ntify rare cell populations and their corresponding gene regulatory\nnetworks within the entire heterogeneous graph.\nMarsGT’s performance remains consistent across data types\n(snRNA-ATAC-seq or scRNA-ATAC-seq), health statuses (healthy or\ndiseased), and species (human or mouse). In the mouse retina case,\nMarsGT identiﬁed not only six major cell populations but also a rare\nsub-cell population of Müller glia cells, a discovery unachievable by\nalternative computational tools and unreported in the original study.\nIn the human small lymphocytic lymphoma case, MarsGT pinpointed a\nrare B cell lymphoma population, with unique transcription factors\nand binding enhancer changes indicating potential regulatory\nmechanisms, functional differences, and a possible precursor state for\nB cell lymphoma. Thisﬁnding could lead to early detection or pre-\nvention strategies for B cell lymphoma progression. In the melanoma\ncase, MarsGT identiﬁed two CD8+ Mucosal-associated invariant T\n(MAIT)-like rare subpopulations and revealed that high IFN-I response\nhinders these MAIT-like cell responses by upregulating IL10 and\ninducing IL15 and IL12 from DC in patients who responded to immune\ncheckpoint blockade. These examples underscore the prowess of\nMarsGT in uncovering new biological insights, as well as generating\nnew biomarkers for guiding immunotherapy.\nWhile MarsGT shows impressive performance in identifying rare\ncells and uncovering biological insights, there is room for improvement.\nStatistical signiﬁcance is crucial for rare cell identiﬁcation to ensure that\ndetected rare cell populations genuinely exist, rather than being ran-\ndom false positives. In this study, weutilized scPOWER to maintain high-\nconﬁdence rare cell populations. It is necessary to develop a new\nmethod for signiﬁcance testing. More complex scenarios, such as\nsenescent cells that exhibit high heterogeneity even within the same cell\ntype, also need to be considered. For multi-sample datasets, batch\ncorrection is necessary prior to the MarsGT application. Thus, devel-\noping an algorithm that can performbatch correction during training\ncould enhance the utility of MarsGT. Moreover, the model’s depen-\ndency on GPU computations might challenge reproducibility. While our\nbenchmark tests demonstrate negligible variance across multiple runs,\nthe small number of rare cell populations identiﬁed suggests that the\nfocus should be on signiﬁcantﬁndings for analysis. Finally, although we\ndesigned a regularization term to balance the signal between rare and\nmajor cell populations, this approach did sacriﬁce some performance in\nidentifying major cell populations to ensure accuracy in rare cell iden-\ntiﬁcation (Supplementary Fig. 22). More intricate designs should be\nconsidered in future work. In conclusion, MarsGT represents a tool for\nthe identiﬁcation of rare cell populations and the elucidation of\nmicroenvironmental and immunotherapeutic mechanisms. It sets a\npromising trajectory for precision medicine by enabling the discovery\nof disease-associated rare cell populations and uncovering intrinsic\nregulatory mechanisms that could inform immunotherapy strategies.\nMethods\nData preprocessing\nMarsGT initiates by inputting the raw count matrices derived from\nmatched scRNA-seqX\nR = fxR\nik ji = 1,2,... ,M1; k = 1,2,... ,Ng and scATAC-\nseq XA = fxA\njk jj = 1,2,... ,M2; k = 1,2,... ,Ng.F o rt h es c R N A - s e qd a t a\nmatrix, we organize it such that rows represent genes, whereas cells\nconstitute the columns. Conversely, the scATAC-seq data matrix is\nstructured with regulatory regions (peaks) as rows and cells as col-\numns. Any row or column in each data matrix containing less than 0.1%\nnon-zero values is excluded from further analysis. Quality control\nmeasures for the data are conducted utilizing Seurat v3\n54, encom-\npassing criteria like total read counts and mitochondrial gene ratios.\nWe then construct the regulatory score matrix\nXRA = fxRA\nij ji = 1,2,... ,M1; j = 1,2,... ,M2g based on MAESTRO55.I nt h i s\nmatrix,xRA\nij signiﬁes the regulatory potential of peakj relative to genei.\nThis potential is determined in accordance with the genomic distance\nbetween peakj and genei.\nx\nRA\nij =\n0, dij >1 5 0 k b o r p e a kj located in any nearby genes\n1\nLength exonðÞ ,p e a kj located at the exon regions of the genei\n2\n/C0\ndij\nd0 ,e l s e\n8\n>><\n>>\n:\nð1Þ\nThe distance between the center of peakj and the transcription\nstart site of genei is denoted asd\nij. The half-decay of the distance,d0,\nis set to be 10 kb.LengthðexonÞ is the length of the exon where the\npeak j located in. As indicated by formula (1), the regulatory potential\nscore xRA\nij of peakj relative to genei is typically calculated by 2\n/C0\ndij\nd0 ;F o r\nFig. 5 | MarsGT identiﬁes MAIT-like rare cell populations and eGRNs in multi-\nsample melanoma scRNA-seq and scATAC-seq. aUMAP visualizes MarsGT’s\npredicted cell cluster results, annotated based on marker genes.b Dotplot depicts\nthe expression value and proportion of marker genes within the cell clusters pre-\ndicted by MarsGT.c UMAPS showcases the marker genes of MAIT cells.\nd Showcasing the marker genes of MAIT cells. Each box showcases the minimum,\nﬁrst quartile, median, third quartile, and maximum gene signature enrichment\nscores on different MAIT-like cell populations (MAIT-like 1:n = 1071, MAIT-like 2:\nn =6 7 ) .T h ep-value is calculated by the Mann-Whitney U test with two-sided.e The\nupset plot illustrates the peaks present in CD8 + T cell subpopulations.f The upset\nplot demonstrates the genes found in CD8 + T cell subpopulations.g Pathway\nenrichment across different MAIT-like cell populations. Colors represent distinct\ncell populations, while the size of the dots indicates the ratio of enriched genes.\np-values were calculated based on one-sided hypergeometric test. Multiple testing\ncorrection was performed by using FDR-adjustedp-values. h The expression and\naccessibility of ZBTB16-regulated genes across various MAIT cell populations.i The\nregulatory relations of ZBTB16 in different MAIT-like cell populations. Green means\nthe common regulatory relations between MAIT-like 1 and MAIT-like 2. Light blue\nmeans the regulatory relations unique in MAIT-like 1. Dark blue means the reg-\nulatory relations unique in MAIT-like 2. Source data are provided as a Source\nData ﬁle.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 10\npeaks withdij >1 5 0kb, we conveniently assign the regulatory potential\nscore of 0, considering that it will be less than 0.0005. For peaks\nlocated within the exon region,x\nRA\nij is computed as 1\nLengthðexonÞ.\nMultiple datasets integration\nIn our speciﬁc case analysis, we handled matched scRNA-seq and\nscATAC-seq across multiple samples. For batch effect correction in\nmultiple scRNA-seq datasets, we employed Harmony56,r e s u l t i n gi na n\nintegrated matrix. For multiple scATAC-seq datasets, we adopted a\nbinning approach with a length of 5000 base pairs to amalgamate\ndifferent samples. The counts of peaks falling within the same bin were\naggregated. Subsequently, multiple scATAC-seq datasets were inte-\ngrated into a single matrix, where rows represented bins and columns\ndenoted cells.\nISGs in MAIT-like cellsGene expression\nCytokines in DC cells\nHigh Low\np=0.00016\n8.0\n6.0\n4.0\n2.0\n0\nIL18RAP\n2.0\nHigh Low\np=0.06\n4.0\n3.0\n1.0\n0\nIL15RA\nHigh Low\np=0.46\n6.0\n4.0\n3.0\n1.0\n0\nIL18R1\n2.0\n5.0\nHigh Low\np=5.4e-09\n15\n12\n6\n3\n0\nMX1\n9\nHigh Low\np=1.7e-07\n8.0\n4.0\n0\nEIF2AK2\n2.0\n6.0\n14\n10\n8\n4\n2\n6\n12\nHigh Low\np=1.2e-07\n0\nIFIT3\nHigh Low\np=2e-04\n5.0\n1.0\n0\nISG15\n4.0\n3.0\n2.0\nHigh Low\np=0.03\n40\n20\n0\n10\n30\nIL15\nHigh Low\np=0.009\n2.0\n1.0\n0\n0.5\n1.5\nIL10\nHigh Low\np=0.11\n35\n30\n15\n0\n20\nIL18\n10\n25\n5\np=0.026\nHigh Low\n4.0\n3.0\n0\n2.0\nIFNG\n1.0\nHigh Low\np=7.7e-04\n8.0\n4.0\n0\n2.0\n6.0\nPRF1\nHigh Low\np=0.05\n6.0\n3.0\n0\n1.0\n5.0\nGZMB\n4.0\n2.0\nf\nc\nh i\nGene expression\nP1\nn=9723\nP2\nn=13370\nP3\nn=10820\nP4\nn=10107\nP5\nn=2719\nP6\nn=9581\nP7\nn=9081\nP8\nn=9390Patients\n176\n895\nMAIT-like cells\nHigh IRC Low IRC\n234\nDC\n106\nNumber of cells\nCell numbers\n0.0\n0.5\n1.0\n1.5\n2.0\np=3.6e-05\n-0.5\n0.0\n0.5\n1.5\np=0.036\n1.0\nMAIT effective \ngene signature\nMAIT exhausted \ngene signature\nEnrichment score\nEnrichment score\na b d\n51 453 319 0 53 3\n226\n30 25 2 5\n127\n20\n517\nNumber of cells\nHigh IRC Low IRC\nMAIT-like 1\nMAIT-like 2\nReceptors in MAIT-like cells\ne\nSecreted factors in MAIT-like cellsg\nFig. 6 | MarsGT reveals the good prognosis with high IFN-I response impairs\nMAIT cell responses by increasing IL10 and inducing IL15 and IL12 from DC.\na The number of cells in MAIT-like cell populations in different melanoma patients.\nb The number of cells in MAIT cells and DC cells in high IRC and low IRC.\nc Expression of ISGs in MAIT cells across different IRC.d Enrichment score of MAIT\neffective gene signature and exhausted gene signature across varying IRC. Each box\nshowcases the minimum,ﬁrst quartile, median, third quartile, and maximum gene\nsignature enrichment scores in different IRC in MAIT cells (High IRC:n =1 7 6 ,L o w\nIRC: n = 895). Thep-value is calculated by the two-sided Mann-Whitney U test.\ne Expression of critical cytokine genes in DC cells across varying IRC.f Expression of\nIFN-I receptor coding genes in MAIT cells across different IRC.g Expression of\nsecreted factors coding genes in MAIT cells across different IRC.h The mechanism\nof MAIT-like cells with different IRC samples.i The regulatory mechanism of IFN-II,\nGzmB, and Perforin in high IRC and low IRC. Green means the common regulatory\nrelations between high IRC and low IRC. Dark blue means the regulatory relations\nare unique in low IRC. Figure created with BioRender.com. Source data are pro-\nvided as a Source Dataﬁle.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 11\nMarsGT model’s construction\nHeterogeneous graph construction. To model and represent the\nscMulti-omics data, a heterogeneous graph is constructed, comprising\nnodes of cells, genes, and peaks. The intuitions of creating such a\nheterogeneous graph are: (1) Gene and peak entities do not exist in\nisolation. They interact with each other in intricate ways in cells. The\nheterogeneous graph captures these interactions and dependencies\ninto a uniﬁed framework. (2) A heterogeneous graph enables the\nidentiﬁcation of joint embeddings of cells, genes, and peaks in a hol-\nistic manner. Such joint embeddings will beneﬁt the harmonization of\nthe two data sources, revealing cross-modal relationships that might\nbe missed when analyzing each data type in isolation. (3) A hetero-\ngeneous graph also allows the message to pass across different cells,\ngenes, and peaks. The local and global message passing and transfer-\nring in the later graph transformer model can minimize the effect of\nmissing values or dropout issue in single-cell data.\nIn our case, we integrate matricesX\nR and XA by constructing a\ngene-cell-peak heterogeneous graphG, consisting of three node types\nand four edge types to ensure each type of element (nodes and edges)\nmaintains a unique distribution and furnishes a natural representation\nframework. We deﬁne the heterogeneous graph asG = ðV,E,FÞ with\nnode set V = V\nC ∪ VE ∪ VG,w h e r eVC = fvC\nk jk = 1,2,... ,Ng denotes all\ncells, VE = fvE\nj jj = 1,2,... ,M2g denotes all peaks,VG = fvG\ni ji = 1,2,... ,M1g\ndenotes all genes. The edge set E is constituted\nas fðvG\ni ,vC\nk Þ,ðvC\nk ,vG\ni Þ,ðvE\nj ,vC\nk Þ,ðvC\nk ,vE\nj Þji = 1,2,... ,M1,j = 1,2,... ,M2,k = 1,2,\n... ,Ng, with edge weight w deﬁned as follows. To eliminate\ninformation redundancy between node initial embeddings and\nthe edge weights, we utilize unweighted edges when constructing the\nheterogeneous graph. ForX\nR\nik >0 ,wðvG\ni ,vC\nk Þ = wðvC\nk ,vG\ni Þ =1 , o t h e r w i s e ,\nwðvG\ni ,vC\nk Þ = wðvC\nk ,vG\ni Þ =0 .F o rXA\njk >0 ,wðvE\nj ,vC\nk Þ = wðvC\nk ,vE\nj Þ =1 ,o t h e r w i s e ,\nwðvE\nj ,vC\nk Þ = wðvC\nk ,vE\nj Þ = 0. Lastly, we establish the initial feature vectorsF\nfor nodes inG as follows:\nFC\nk = XR\n/C1 ,k , k = 1,2,... ,N;\nFE\nj = ðXA\nj,/C1 Þ\nT\n, j = 1,2,... ,M2;\nFG\ni = ðXR\ni,/C1 Þ\nT\n, i = 1,2,... ,M1;\nwhere Xi,/C1 and X/C1 ,k represent theith row vector and thekth column\nvector ofX, respectively.\nSub-sampling of a heterogeneous graph. To enhance the efﬁciency\nof MarsGT when dealing with a large heterogeneous graph, it is neces-\nsary to select subgraphs prior to model training. We assume that a gene\nubiquitously expressed is unlikely to hold as much signiﬁcance for rare\ncell identiﬁcation compared to a gene that is expressed only in a parti-\ncular subpopulation. To discern rare cells, we devised a probability-\nbased sub-sampling method. It is imperative to identify genes or peaks\nthat are highly expressed in a target cell but exhibit low or no expression\nin other cells. There are two steps for the probability-based sub-sam-\npling method. Theﬁrst step is toﬁlter out lowly expressed genes, which\ns h o u l dn o tb er e g a r d e da sr a r e - r e l a t e df e a t u r e s .F o rc e l lk\n0, the genes\nvG\nik0\nwith xG\nik0\n>a are reserved.a is a threshold set to theﬁrst quartile of\nthe expression value of all genes in the given cell.\nT h es e c o n ds t e pi st os e l e c tg e n e sa n dp e a k sb a s e do np r o b -\nabilities calculated by the following formula:\nProb v G\nik0\n/C16/C17\n=\nProp v G\nik0\n/C16/C17\nP\nfijxG\nik0\n> ag\nProp v G\nik0\n/C16/C17 ð2Þ\nwhere\nProp v G\nik0\n/C16/C17\n=\nxR\nik0P\nk\nxR\nik\nð3Þ\nThe greater the probability value of gene correspondence, the\neasier it is to be selected into the subgraph of the corresponding cell.\nAt this time, the gene has a higher probability of displaying the rare\nsignal of the cell. The number of reserved genes is denoted asNg .\nConsidering the expensive nature of the deep learning model, here we\nset minðN\ng ,20Þ number of genes are selected as default. AsXA trends\ntowards binarization, peaksvE\njk0\nwithin the cell according to a prob-\nability that is deﬁned as follows:\nProb v A\njk0\n/C16/C17\n=\nProp v A\njk0\n/C16/C17\nP\nj\nProp v A\njk0\n/C16/C17 ð4Þ\nwhere\nProp v A\njk0\n/C16/C17\n=\nxA\njk0P\nk\nxA\njk\nð5Þ\nThe greater the probability value of peak correspondence, the\neasier it is to be selected into the subgraph of the corresponding cell.\nAt this time, the peak has a higher probability of displaying the rare\nsignal of the cell. The number of reserved peaks is denoted asN\np:\nConsidering the expensive nature of the deep learning model, here we\nset minðN\np,20Þ number of peaks as default.\nEach subgraph incorporates 30cells randomly along with their\nselected neighbor nodes. MarsGT is trained using multiple mini-bat-\nches, each represented by a subgraph.\nMarsGT embedding update.L e tH\nl represent the embedding of thelth\nlayer (l =1 ,2 ,… , L). The updated embedding ofvG\ni , vE\nj , vC\nk on thelth the\nlayer is denoted as Hl½vG\ni /C138,H l½vE\nj /C138,a n dHl½vC\nk /C138,r e s p e c t i v e l y .T oa l i g nt h e\nfeatures of different typ e so fn o d e si n t ot h es a m ed i m e n s i o n ,w ea p p l ya\nlinear projection functionW on the initial feature vectorsF and obtain\nthe initial embeddingsH0 with a lower dimension, which we set at 256:\nH0 vG\ni\n/C2/C3\n= WG FG\ni\n/C16/C17\nð6Þ\nH0 vE\nj\nhi\n= WE FE\ni\n/C16/C17\nð7Þ\nH0 vC\nk\n/C2/C3\n= WC FC\ni\n/C16/C17\nð8Þ\nSubsequently, we apply a multi-head mechanism to divide H0 v½/C138\nevenly intoH heads. Within thelth layer, we build three linear pro-\njection functions, query (Qh\nlinear ), key (Kh\nlinear ), and value (Vh\nlinear ), for\neach headðh =1 ,... ,HÞ.F o re a c hn o d ev within the graph, the feature\nvectors obtained after these transformations are denoted as follows:\nQh vðÞ = Qh\nlinear Hl/C0 1 v½/C138\n/C16/C17\nð9Þ\nKh vðÞ = Kh\nlinear Hl/C0 1 v½/C138\n/C16/C17\nð10Þ\nVh vðÞ = Vh\nlinear Hl/C0 1 v½/C138\n/C16/C17\nð11Þ\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 12\nTo calculate the mutual attention between nodev and its neigh-\nbor NðvÞ within thehth head, we introduce the attention operator. This\noperator estimates the importance of each neighboring nodevne in\nNðvÞ relative to v using Kh vneðÞ WATT\ntv ne,vðÞ Qh vðÞ\nT\n,w h e r eWATT\ntv ne,vðÞ is a\ntransformation matrix designed to capture edge features, whiletð:Þ\ndenotes the edge type. :ðÞ T signiﬁes the transposal function. The\nattention coefﬁcient within the headh0 is then calculated as follows:\natt vne,v, h0\n/C0/C1\n= Softmax\nall vne 2 NvðÞ Kh0 vne/C0/C1\nWATT\ntv ne,vðÞ Qh0 vðÞ\nT/C16/C17\nð12Þ\nThe concatenation of attention heads yields the attention coefﬁ-\ncients, represented as follows:\natt vne,v\n/C0/C1\n= jj\nh att vne,v,h\n/C0/C1/C0/C1 ð13Þ\nThe message fromvne that can be relayed tov within headh is\ngiven byVh vneðÞ WMSG\ntv ne,vðÞ . WMSG\ntv ne,vðÞ is also a transformation matrix. Then,\nthe results from different message heads should subsequently be\nconcatenated:\nmes v\nne,v\n/C0/C1\n= jj\nh Vh vne/C0/C1\nWMSG\ntv ne,vðÞ ð14Þ\nTo update the embedding of nodev,t h eﬁnal step within thelth\nlayer will sumHl/C0 1 v½/C138 and Hl’ v½/C138 with trainable weights into the node’s\nnew embedding.\nHl0\nv½/C138 = Aggregate\n8vne 2 NvðÞ att vne,v\n/C0/C1\nmes vne,v\n/C0/C1\nð15Þ\nHl v½/C138 = αReLU Hl0\nv½/C138\n/C16/C17\n+1 /C0 αðÞ Hl/C0 1 v½/C138 ð16Þ\nwhere α represents a trainable parameter, while ReLU functions as the\nactivation function. Theﬁnal embedding ofv is obtained by layer-wise\nstacking of information.\nMarsGT subgraph training. For the sake of generality, we continue\nusing the aforementioned notation for subgraphs. Following the cal-\nculation of embeddings, all nodes (genes, cells, and peaks) acquire new\nembeddings, denoted as fH\nl v½/C138 jv 2 VC ∪ VE ∪ VGg.T h eu p d a t e\nembeddings of cellsfHl v½/C138 j v 2 VC g is denoted asP after normalizing by\nthe sum of columns. Each row ofP represents a cell, each column ofP\nrepresents a reduced dimension set manually, and each element sig-\nniﬁes the probability that a cell belongs to a speciﬁc cell cluster. We\nestablish an initial number of cell clusters that align with the number of\ncell embeddings. A cell is assigned to the cell cluster where the cor-\nresponding dimension yields the highest value relative to all other\ndimensions. Thus, MarsGT does not require pre-speciﬁcation of the\nnumber of cell clusters. Similarly, we construct the initial embedding\nof links between genes and peaks for each cell cluster by concatenating\ngene and peak embeddings, denoted asQ.T h er o wo fQ represents a\npeak-gene link, and the column ofQ represents the cell cluster. By\napplying a linear layer and a ReLU layer, the dimension ofQ is reduced\nto match the number of initial cell clusters. The output is the prob-\nability that a peak-gene link belongs to each cell cluster which is\ndenoted asbO. The base peak-gene relations are determined based on\nX\nRA and adjusted according to the corresponding gene expressions\nand chromatin accessibility of all cells in a cell cluster, denoted asO.\nIn our model training, we devise a multi-task loss function, which\nconsists of four critical components (Supplementary Fig. 2). Loss\ncomponents (1) and (2) are designed to obtain high-quality node\nembeddings. Loss components (3) and (4) are the key to identifying\nrare and major cell populations simultaneously. Based on component\n(3), we introduce the peak-gene relations in the model training\np r o c e s s ,w h i c hc a np r o v i d em o r ea c c u r a t er a r es i g n a l s .C o m p o n e n t( 4 )\nis critical for our model to keep the major population signal not\ndiminished while we focus on rare populations. The multi-task loss\nfunction is deﬁned as follows:\nLoss = KL\ncluster\nzﬄﬄﬄﬄ}|ﬄﬄﬄﬄ{\nð1Þ\n/C0 Cosloss\nzﬄﬄﬄ}|ﬄﬄﬄ{\nð2Þ\n+ KLðbO,OÞ\nzﬄﬄﬄﬄﬄ}|ﬄﬄﬄﬄﬄ{\nð3Þ\n+ δRegloss\nzﬄﬄﬄﬄ ﬄ}|ﬄﬄﬄﬄ ﬄ{\nð4Þ\nð17Þ\nwhere KLcluster = KLðHl½VG/C138*Hl½VC/C138\nT\n,XRÞ + KLðHl½VE /C138*Hl½VC /C138\nT\n,XRÞ. δ is\nthe weight coefﬁcients, the default values are all set to 1.\nThe Cosine similarity in clusterC0 is deﬁned as:\nCosloss C0\n/C0/C1\n=\nX\n8ka,kb2C0\nCosineðHl½Vka /C138,Hl½Vkb /C138Þ ð18Þ\nThe regular term is deﬁned as:\nRegloss = Smoothingcross Pr ,L,εðÞ ð19Þ\nwhere L = fljjlj 2 1, ... ,Tfg , j =1 ,... ,Ng is the cell cluster results by\nLouvain with scRNA-seq,Pr is the predicted results of model.T is the\nnumber of cell clusters by Louvain,ε is a smoothing factor.\nSmoothingcross P,L,εðÞ = /C0\nXN\nj =1\nXT\nt =1\nyjt log pjt ð20Þ\nyjt =\n1 /C0 ε + ε\nT if l j = t\n/C16/C17\nε\nT if l j≠t\n/C16/C17\n8\n><\n>:\nð21Þ\nwhere pjt represents the predicted probability of the given cell\nbelonging to the classt, i.e. the corresponding element in matrixP.\n(1) The goal of Component 1 is to maximize embedding retention of\nthe original information of the data. In detail,\nKL\ncluster = KLðHl½VG/C138*Hl½VC /C138\nT\n,XRÞ + KLðHl½VE /C138*Hl½VC /C138\nT\n,XAÞ, Hl½VG/C138\nis the embedding of genes, Hl½VC/C138 is the embedding of\ncells,Hl½VE /C138is the embedding of peaks,XR is the expression data,\nand XA is the accessibility data. We expect that their inner product\ncan greatly restore the distribution of the original expression data\nand accessibility data, thus preserving the original expression\ninformation. As the KL divergence diminishes, less information is\nlost during heterogeneous graph transformer learning.\n(2) The goal of Component 2 is to ensure that the embeddings within\nthe same cluster we identify are sufﬁciently similar. In detail,\nCos\nloss = P\n8ka,kb2C0\nCosineðHl½Vka /C138,Hl½Vkb /C138Þ. A higher similarity score\nindicates superior clustering efﬁcacy and closely distance in the\nsame cluster.\n(3) The goal of Component 3 is to ensure that the union of peak-gene\nrelations under the predicted cell cluster is similar to the peak-\ngene relations of bulk level, and to ensure that if a peak regulates a\ngene under a cell type, then the peak is accessible and the gene is\nexpressed. We utilize another KL divergence score to evaluate\ndiscrepancies between predicted and baseline peak-gene links\nwithin each cell cluster. The baseline peak-gene associations are\ndetermined based on proximity to the nearest genes. Further, we\ncalculate a regulatory potential scoreO, and adjust this score\naccording to the corresponding gene expressions and chromatin\naccessibility across all cells within a cell cluster. Intuitively, this\nc o m p o n e n tc a np o t e n t i a l l yr e d u c et h ef a l s ep o s i t i v eo fc e l l\nclusters’results.\n(4) The goal of Component 4 is to ensure that the feature of major\ncell population is not diminished, although we have speciﬁc\ndesigns for rare populations as above. In detail,\nReg\nloss = Smoothingcross ðPr,L,εÞ. We calculate an entropy score\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 13\nto contrast the differences between the base (Louvain clustering\nresults, L) and predicted cell clustering outcomesP.S i n c et h e\nresult of Louvain is not a true label, we allow for errorε in calcu-\nlating the cross entropy.\nOur algorithm concurrently updates the cell clustering outcomes\nand the peak-gene links within each set of cell cluster prediction\nresults. The model is designed to iterate until it reaches a state of\nconvergence, at which point we obtain the cell clusters and all peak-\ngene links speciﬁc to each cluster. Following this, the peak-gene links\nwithin each cell cluster are obtained.\nMarsGT predicts cell clusters and eGRN in the whole graph.U p o n\ncompleting the two phases of training, a robustly trained model is\ngenerated. To ensure that every cell is mapped to its corresponding\npredicted cluster, and every gene and peak is associated with cell\ncluster-speciﬁc peak-gene regulatory information, we apply the\ntrained model to the entire graph. By covering all cells through the\nchosen union of subgraphs, the trained model, when applied to the\nentire graph, can also have a good performance. The cell cluster pre-\ndictions encompass all cells. Regarding cell cluster-speciﬁcp e a k - g e n e\nlink, we use theﬁnal predicted cell cluster results to calculate all genes\nand peaks, eschewing the use of a subgraph. In order to quantify the\nspeciﬁc degree of each peak-gene link, we determine the peak-gene\nscore based on gene expression, peak accessibility, and the regulatory\npotential of peaks to genes. The peak-gene link score (PGS) is deﬁned\nas:\nPGS i,j,CTðÞ = xi × j,CT =\nP CTjj\nk =1 xR\nik × x\nRA\nij × xA\njk\nCTjj ,j,i = 1,2,... ,M1,j = 1,2,... ,M2,k = 1,2,... ,N\n8\n<\n:\n9\n=\n;\nð22Þ\nwhere CTjj is the cell number in cell clusterCT . Then the cell cluster\ncorresponding peak-gene links are inferred. To infer eGRN, we need to\nintroduce the TF information. We retrieved the genome browser track\nﬁle from JASPAR, which stores all known TF binding sites of each TF. A\np-value score was provided in JASPAR. We removed TF binding sites\nwith p-value scores more than 0.05. And then, if a TF binding site\noverlaps with any peak regions in the predicted peak-gene link, it will\nbe kept, otherwise, removed. Finally, the TF-peak relations will be\nobtained, and the eGRNs in each cell cluster also are inferred.\nBenchmark of rare cell population identiﬁcation\nSimulated single-cell multi-omics data. We evaluated the perfor-\nm a n c eo fr a r ec e l li d e n t iﬁcation based on the algorithm’s capability to\ndistinguish between two known rare populations. We assessed the\nalgorithm’se fﬁcacy using 400 simulated datasets with eight different\ndesigns from two different data types. Theﬁrst data type consisted of\ncell line data (549 cells) characterized by low intra-class heterogeneity,\navailable at https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?study=\nSRP136421.T h i sd a t ac o n t a i n e dﬁve cell line types: PDX1, PDX2,\nHeLa.S3, K562, and HCT116. The second type was the immune popu-\nlation dataset (17,243 cells) with high intra-class heterogeneity,\nobtainable from https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?\nacc=GSE194122. In the cell line dataset, we selected PDX1 (176 cells)\nand PDX2 (167 cells) as the common cell populations, while HeLa.S3\n(42 cells) and K562 (74 cells) were chosen as the rare population in the\nsimulated data. Two types of simulated datasets were created based on\nthe cell line data: (1) PDX1 and PDX2 (major, 290 cells), HeLa.S3 (rare,\n10 cells); and (2) PDX1 and PDX2 (major, 280 cells), HeLa.S3 (rare, 10\ncells), K562 (rare, 10 cells). (Supplementary Table S1). Each dataset\nconsisted of 50 datasets, each containing 300 cells that were randomly\nsubsampled from each cell type. Similarly, for PBMC cells, we utilized\nNK, CD4+ T naïve, CD8+ T (common), Erythroblast, Plasma, HSC, and\nID2-hi myeloid prog cells (rare) to establish six types of simulated\ndatasets (Supplementary Table S1).\nThere were six datasets on the immune population data: (1) CD8+\nT (major, 490 cells) and Plasma (rare, 10); (2) CD4+ T naïve (major, 480\ncells), HSC (rare, 10 cells), and Plasma (rare, 10 cells); (3) CD8+ T\n(major, 490 cells), Erythroblast (rare, 10 cells), (4) CD8+ T (major, 480\ncells), Erythroblast (rare, 10 cells), and HSC (rare, 10 cells); (5) CD8+ T\n(major, 480 cells), Erythroblast (rare, 10), and Naive CD20+ B (rare, 10);\n(6) CD14+Mono (major, 250 cells) and CD8+ (major, 250 cells). There\nwere 50 datasets of 500 cells generated by randomly subsampling\nfrom each cell type.\nTo assess the proportion of rare cells detected by different\nsoftware, datasets were created to include from 970 to 995 com-\nmon cells and 30 to 5 rare cells. For instance, the smallest common\ndataset was comprised of 970 common cells and 30 rare cells (3%),\nwhile the largest included 995 common cells and 5 rare cells (0.5%).\nSix datasets of 1000 cells, with differing rare cell proportions, were\ngenerated by random subsampling from each cell type. Theﬁrst ﬁve\ndatasets tested rare cell population identiﬁcation, while the sixth\nassessed the false-positive rate of each algorithm. All algorithms\nwere applied to these datasets with default or suggested settings.\nThe results were visualized using UMAP for Scanpy and colored by\npredicted results.\nFurthermore, to ensure that the simulation datasets more closely\nresemble real data, we increased the number of cell types and the\nnumber of cells We simulated 150 datasets using peripheral blood\nmononuclear cells. Each simulation dataset contained 5,000 cells and\n5-15 cell types (Sim-PBMC 7, 8, 9). Theﬁrst type contains one rare cell\npopulation and four major cell populations (Sim-PBMC 7). The second\ntype contains one rare cell population and nine major cell populations\n(Sim-PBMC 8). The third type containsﬁve rare cell populations and\nten major cell populations (Sim-PBMC 9). The details of each simula-\ntion dataset are shown as follows:\nSim-PBMC 7:\nWe have established a speciﬁc set of sampling rules to construct\nthe simulated dataset, Sim-PBMC 7. Firstly, we deﬁnitively select the\nfour cell types that have the highest proportions in terms of the cell\nnumbers of each cell type. Secondly, from the two least abundant cell\ntypes (rare types), we randomly select one. Ultimately, we extract a\ntotal of 5000 cell samples from theseﬁve cell types. It is noteworthy\nthat, except for the rare cell type, which has aﬁxed quantity of 50, the\nsampling ratios of the remaining cell types are normalized based on\ntheir proportions in the original dataset.\nSim-PBMC 8:\nTo verify whether our software can accurately identify rare types\namong numerous cell types, we have established a speciﬁcs e to f\nsampling rules to construct the simulated dataset Sim-PBMC 8. Firstly,\nwe deﬁnitively select the nine cell types that have the highest pro-\nportions in terms of the cell numbers of each cell type. Secondly, from\nthe two least abundant cell types (rare types), we randomly select one.\nUltimately, we extract a total of 5000 cell samples from these 10 cell\ntypes. It is noteworthy that, except for the rare type of cells, which have\na ﬁxed quantity of 50, the sampling ratios of the remaining cell types\nare normalized based on their proportions in the original dataset.\nSim-PBMC 9:\nTo further increase the level of difﬁculty, we aim to continue\nverifying whether our model remains efﬁcient when multiple rare cell\ntypes are present. We have established a speciﬁc set of sampling rules\nto construct the simulated dataset Sim-PBMC 9. First, we decisively\nchoose the ten cell types that have the highest proportions in terms of\nthe cell numbers of each cell type. Next, for those cell types that\naccount for less than 1% of the total, we randomly selectﬁve. Ulti-\nmately, we draw a total of 5000 cell samples from these 15 cell types. It\nis noteworthy that the sampling ratio of each cell type is normalized\nbased on their proportions in the original dataset.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 14\nSimulated datasets benchmarking quantiﬁcation\nTo optimize the default parameters of MarsGT, we conducted a grid-\nsearch test on seven simulated datasets. The parameters considered in\nthis optimization included weighted decay (0, 0.1, 0.3), learning rate\n(0.001, 0.0005), and label smoothing (0, 0.1, 0.3), which are important\nparameters to prevent overﬁtting and ensure convergence speed. This\nresulted in a total of 18 unique parameter combinations. We randomly\nselected one dataset from each type of simulation as a training set. The\nmost effective parameter combination was weighted decay = 0.1,\nlearning rate = 0.001, and label smoothing = 0.3. This set was subse-\nquently adopted as the default parameter combination. The remaining\nsimulation datasets were processed using these default parameters.\nReal datasets benchmarking quantiﬁcation\nTo assess the generalizability of our model, we applied the same\nparameter combinations that we used with the simulated datasets to\nthree benchmark (PBMC-bench-1, 2, 3) real datasets. We subsequently\nemployed the default parameters for an independent test dataset\n(PBMC-test).\nThe ability of rare cell identiﬁcation\nTypically, a cell type is classiﬁed as rare if it constitutes less than 3% of\nthe total cell count. However, truly rare cell types often represent\nmuch less than this threshold. To evaluate the capacity of various tools\nto identify these rare cells, we designated cell types representing 0.5%,\n1%, 2%, and 3% of the total cell count as rare in the independent test\ndataset. We then calculated the F1 score, precision, and recall score for\neach category.\nStatistics & reproducibility\nIn our case analysis, we utilized scPower, a tool that assists in deter-\nmining the power needed to detect a sufﬁcient number of cells from a\nspeciﬁc cell type in each individual. Using this tool, we calculated the\nminimum number of cells per individual required to reach a pre-\ndetermined power threshold. This calculation was based on the\nnegative binomial distribution.\nNo data were excluded from the analyses. The experiments were\nnot randomized. The Investigators were not blinded to allocation\nduring experiments and outcome assessment.\nTo evaluate the stability and reproducibility of MarsGT, we exe-\ncuted the algorithm 20 times on the independent test dataset, utilizing\nthe default parameters. We then computed the variance of several key\nmetrics, including the F1 score, precision, recall score, Normalized\nMutual Information (NMI), purity, and entropy.\nBaseline tools parameter set\nTo evaluate the performance of MarsGT relative to other tools for\nidentifying rare cells, we conducted a comparative analysis between\nMarsGT and other established methods.\n(i) FIRE\n4 (v 1.0.1, https://github.com/princethewinner/FIRE,d a t a\npre-processing, and feature extraction uses the function\n“ranger_preprocess”).\n(ii) GapClust\n13 (v 0.1.0, https://github.com/fabotao/GapClust, genes\nthat were expressed in less than three cells were excluded, and\ncells expressing <200 genes were also excluded, the normal-\nization procedure was accomplished using the scran (R package).\n(iii) CellSIUS\n26 (v 1.0.0, https://github.com/Novartis/CellSIUS,c e l l s\nwere ﬁltered based on the total number of detected genes, total\nUMI counts, and the percentage of total UMI counts attributed to\nmitochondrial genes, genes have to present with at least 3 UMIs in\nat least one cell. After this initial QC, the remaining outlier cells\nwere identiﬁed and removed using the plotPCA function from the\nscatter (R package with detect_outliers set to TRUE). Data were\nnormalized using scran (R package), including aﬁrst clustering\nstep as implemented in the“quickCluster”function).\n(iv) RaceID\n2 (v 0.2.3, https://github.com/dgrun/RaceID3_StemID2_\npackage).\n(v) GiniClust 15 (v 3.0, https://github.com/rdong08/GiniClust3,t h e\n“neighbors” parameter of the function“clusterGini” is set to 10\n(the recommended value is from 5 to 15), other parameters at the\ndefault values).\n(vi) SCMER 1 (v 0.1.0a3, https://github.com/KChen-lab/SCMER, data\npre-processing is carried out using Scanpy (Python package)).\nFor each benchmarking tools, grid tests were also applied to a\ncombination of parameters(Supplementary Data 5).\nEvaluation index\nTo assess the precision of various rare cell identiﬁcation algorithms, we\nemployed metrics quantifying the purity of the clustering output. We\nevaluated two categories of algorithms: theﬁrst encompassing clus-\ntering methods capable of differentiating all cell populations, such as\nSCMER\n1, GiniClust15, and RaceID2, and the second consisting of classi-\nﬁcation methods that can distinguish only between rare cell and major\ncell populations. For evaluating clustering methods, we utilized purity,\nentropy, and Normalized Mutual Information (NMI). For assessing\nclassiﬁcation methods, we applied recall, precision, and F1-score\nmetrics.\nPurityis based on the frequency of the most abundant class in the\npredicted clusters. LetS = fs\n1,s2, ... ,sSg be the set of predicted clusters,\nand T = ft1,t2, ... ,tT g be the set of true labels. The purity index is\ndeﬁned as:\npurityðS,TÞ =\nP\nsmaxtjss \\ ttj\nN\nð23Þ\nwhere ss (s =1 ,... ,S) is the set of cells in the predicted clusters.tt\n(t =1 ,... ,T) is the set of cells in the true labels.N is the number of cells.\nThe value of purity ranges from 0 to 1, where 1 provides the best\nclustering effect.\nEntropy uses Shannon entropy to evaluate cluster accuracy by\nmeasuring the expected amount of information from the clusters. Let\nS = fs\n1,s2, ... ,sSg be the set of predicted clusters, andT = ft1,t2, ... ,tT g\nbe the set of true labels. The entropy of each predicted clusters is\ndeﬁned as:\nHs s\n/C0/C1\n= /C0\nX\nt\njsst j\njssj logjsst j\njssj ð24Þ\nsst = ss \\ tt ð25Þ\nThen, the entropy for all clusters is deﬁned as:\nentropyðS,TÞ =\nX\ns\njssj\nN HðssÞ ð26Þ\nLower entropy means higher clustering accuracy.\nNMI measures the normalized dependency of the true labels on\nthe predicted cluster. Mutual information is deﬁned as:\nI S,TðÞ =\nX\ns\nX\nt\njsst j\nN log Njsst j\nss\n/C12/C12 /C12/C12 tt\n/C12/C12 /C12/C12 ð27Þ\nTo compare mutual information across different clusters,IðS,TÞ is\nnormalized to the½0,1/C138, which is bounded by min½H SðÞ ,H TðÞ /C138 ,w h e r e\nH SðÞ = /C0\nX\ns\njssj\nN log jssj\nN ð28Þ\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 15\nH TðÞ = /C0\nX\nt\njttj\nN logjttj\nN ð29Þ\nThen, NMI is deﬁned as:\nNMI S,TðÞ = I S,TðÞ\nmin H SðÞ ,H TðÞ½/C138 ð30Þ\nHigher NMI means higher clustering accuracy.\nPrecisionrepresents the ability of the model to correctly predict\nrare cells among all rare cell predictions.\nPrecision = TP\nTP + FP ð31Þ\nRecallrepresents the model’s ability to correctly predict rare cells\nfrom actual rare cells.\nRecall = TP\nTP + FN ð32Þ\nF1-score can be interpreted as a weighted average of precision\nand recall. F1-score ranges from 0, poor classiﬁc a t i o n ,t o1 ,p e r f e c t\nclassiﬁcation:\nF1 score = TP\nTP +0 :5* TP + FNðÞ ð33Þ\nTP means the number of cells predicted to be rare in real rare\ncells. FP means the number of cells predicted to be rare in real com-\nmon cells.FN means the number of cells predicted to be common cells\nin real rare cells\nReporting summary\nFurther information on research design is available in the Nature\nPortfolio Reporting Summary linked to this article.\nData availability\nAll relevant data supporting the keyﬁndings of this study are available\nwithin the article and its Supplementary Informationﬁles. All data used\nin this study are from public domain. The raw data are downloaded\nfrom the GEO database with the accession numbers for: human PBMC\npaired scRNA-seq and scATAC-seq data“GSE194122”,m o u s er e t i n a\npaired scRNA-seq and scATAC-seq data “GSE201402” and human\nmelanoma PBMC paired scRNA-seq and scATAC-seq data\n“GSE199994”. The scRNA-seq and scATAC-seq cancer cell line data was\ndownloaded from NCBI with an accession code of“CNP0000213\n[https://trace.ncbi.nlm.nih.gov/Traces/index.html?study=\nSRP136421]”. The following paired scRNA-seq and scATAC-seq dataset\nwas obtained from the 10X Genomics website:“lymph node data\n[https://www.10xgenomics.com/resources/datasets/fresh-frozen-\nlymph-node-with-b-cell-lymphoma-14-k-sorted-nuclei-1-standard-2-0-\n0]”. All datasets are publicly available without restrictions. Details of\ndata information can be found in Supplementary Data 1. Source data\nare provided with this paper.\nCode availability\nMarsGT is a user-friendly, efﬁcient package developed in Python,\nleveraging the capabilities of PyTorch. The source code and vignettes\nof MarsGT are freely available athttps://github.com/mtduan/marsgt.\nThe source code is also available on Zenodo57 with linkhttps://doi.org/\n10.5281/zenodo.8406470.\nReferences\n1. Liang, S. H. et al. Single-cell manifold-preserving feature selection\nfor detecting rare cell populations.Nat. Comput. Sci.1,3 7 4– 384\n(2021).\n2. Grun, D. Revealing dynamics of gene expression variability in cell\nstate space.Nat. Methods17,4 5( 2 0 2 0 ) .\n3. Wen, L. & Tang, F. Computational biology: How to catch rare cell\ntypes. Nature 525,1 9 7– 198 (2015).\n4. Jindal, A., Gupta, P., Jayadeva & Sengupta, D. Discovery of rare cells\nfrom voluminous single cell expression data.Nat. Commun.9,\n4719 (2018).\n5. Arvaniti, E. & Claassen, M. Sensitive detection of rare disease-\nassociated cell subsets via representation learning.Nat. Commun.\n8,1 4 8 2 5( 2 0 1 7 ) .\n6. Belarif, L., Vanhove, B. & Poirier, N. Full antagonist of the IL-7\nreceptor suppresses chronic inﬂammation in non-human primate\nmodels by controlling antigen-speciﬁcm e m o r yTc e l l s .Cell Stress\n2,3 6 2– 364 (2018).\n7. Hu, X. et al. Application of user-guided automated cytometric data\nanalysis to large-scale immunoproﬁling of invariant natural killer\nTc e l l s .P r o c .N a t lA c a d .S c i .U S A110,1 9 0 3 0– 19035 (2013).\n8. Hong, Y. et al. The impact of donor characteristics on the invariant\nnatural killer T cells of granulocyte-colony-stimulating factor-\nmobilized marrow grafts and peripheral blood grafts.Transpl.\nImmunol.48,5 5– 59 (2018).\n9. Martinez-Lopez, J. et al. Monitoring of the minimum residual disease\nand depth of response in multiple myeloma.Haematologica104,\n150– 150 (2019).\n10. Pruess, M. et al. A high sensitivity, tumor-informed liquid\nbiopsy platform, designed to detect minimum residual disease\nat part per million resolution.J. Immunother. Cancer 10,\nA21– A21 (2022).\n11. Kotliar, D. et al. Identifying gene expression programs of cell-type\nidentity and cellular activity with single-cell RNA-Seq.Elife 8,\nhttps://doi.org/10.7554/eLife.43803(2019).\n12. Janssens, J. et al. Decoding gene regulation in theﬂy brain.Nature\n601, 630 (2022).\n13. Fa, B. T. et al. GapClust is a light-weight approach distinguishing\nrare cells from voluminous single cell expression proﬁles. Nat.\nCommun. 12, 4197 (2021).\n14. Schwartz, G. W. et al. TooManyCells identiﬁes and visualizes rela-\ntionships of single-cell clades.Nat. Methods17, 405 (2020).\n15. Jiang, L., Chen, H. D., Pinello, L. & Yuan, G. C. GiniClust: detecting\nrare cell types from single-cell gene expression data with Gini\nindex. Genome Biol.17, 144 (2016).\n16. Ma, A. et al. Single-cell biological network inference using a\nheterogeneous graph transformer. Nat. Commun. 14,\n964 (2023).\n17. Yi, H. C., You, Z. H., Huang, D. S. & Kwoh, C. K. Graph repre-\nsentation learning in bioinformatics: trends, methods and appli-\ncations. Brief Bioinform.23, https://doi.org/10.1093/bib/bbab340\n(2022).\n18. Yun, S. et al. Graph transformer networks: learning meta-path\ngraphs to improve GNNs.Neural Netw.153,1 0 4– 119\n(2022).\n19. Zheng, Y. et al. A graph-transformer for whole slide image classi-\nﬁcation. IEEE Trans. Med. Imaging41,3 0 0 3– 3015 (2022).\n20. Chu, T., Nguyen, T. T., Hai, B. D., Nguyen, Q. H. & Nguyen, T. Graph\ntransformer for drug response prediction.IEEE/ACM Trans. Comput\nBiol. Bioinform20,1 0 6 5– 1072 (2023).\n21. Vaswani, A. et al. Attention is all you need.Adv. Neural Inf. Process.\nSyst. 30 (NIPS 2017)30 (2017).\n22. Hu, Z., Dong, Y., Wang, K. & Sun, Y. inProceedings of The Web\nConference 20202704– 2710 (2020).\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 16\n23. Mei, X., Cai, X., Yang, L. & Wang, N. Relation-aware Heterogeneous\nG r a p hT r a n s f o r m e rb a s e dd r u gr e p u r p o s i n g .Expert Syst. Appl.190,\nhttps://doi.org/10.1016/j.eswa.2021.116165(2022).\n24. Gu, H. et al. scGNN 2.0: a graph neural network tool for imputation\nand clustering of single-cell RNA-Seq data.Bioinformatics38,\n5322– 5325 (2022).\n25. Wang, J. et al. scGNN is a novel graph neural network framework for\nsingle-cell RNA-Seq analyses.Nat. Commun.12, 1882 (2021).\n26. Wegmann, R. et al. CellSIUS provides sensitive and speciﬁc\ndetection of rare cell populations from complex single-cell RNA-\nseq data.Genome Biol.20, 142 (2019).\n27. SenNet, C. NIH SenNet Consortium to map senescent cells\nthroughout the human lifespan to understand physiological health.\nNat. Aging2,1 0 9 0– 1100 (2022).\n28. Schmid, K. T. et al. scPower accelerates and optimizes the design of\nmulti-sample single-cell transcriptomic studies.Nat. Commun.12,\n6625 (2021).\n29. Sun, W., Li, Y.-N., Ye, J.-F., Guan, Y.-Q. & Li, S.-J. MEG3 is involved\nin the development of glaucoma through promoting the autop-\nhagy of retinal ganglion cells.Eur. Rev. Med. Pharmacol. Sci.\n22 (2018).\n30. Bai, Y., Ma, J.-X. & Le, Y.-Z. The role of retinal Müller Cell-Produced\nVEGF in ischemia induced vascular leakage.Investig. Ophthalmol.\nVis. Sci.50,5 8 9 9– 5899 (2009).\n31. Yan, W. et al. Mouse retinal cell atlas: molecular identiﬁcation of\nover sixty Amacrine cell types.J. Neurosci.40, 5177– 5195 (2020).\n32. Chen, Y. et al. Single-cell transcriptomic proﬁling in inherited retinal\ndegeneration reveals distinct metabolic pathways in rod and cone\nphotoreceptors.Int. J. Mol. Sci.23, https://doi.org/10.3390/\nijms232012170(2022).\n33. Jin, S. Q. et al. Inference and analysis of cell-cell communication\nusing CellChat.Nat. Commun.12,1 0 8 8( 2 0 2 1 ) .\n34. Sarin, S. et al. Role for Wnt signaling in retinal neuropil develop-\nment: analysis via RNA-Seq and In vivo somatic CRISPR mutagen-\nesis. Neuron 98,1 0 9– 126.e108 (2018).\n35. Shekhar, K. et al. Comprehensive classiﬁcation of retinal bipolar\nneurons by single-cell transcriptomics.Cell 166,\n1308– 1323.e1330 (2016).\n36. Dou, J. et al. Bi-order multimodal integration of single-cell data.\nGenome Biol.23, 112 (2022).\n37. Luhmann, U. F. et al. Role of theNorrie disease pseudoglioma gene\nin sprouting angiogenesis during development of the retinal vas-\nculature.Invest Ophthalmol. Vis. Sci.46, 3372– 3382\n(2005).\n38. Moscona, A. A., Fox, L., Smith, J. & Degenstein, L. Antiserum to lens\nantigens immunostains Muller glia cells in the neural retina.Proc.\nNatl Acad. Sci. USA82,5 5 7 0– 5573 (1985).\n39. Hao, Y. H. et al. Integrated analysis of multimodal single-cell data.\nCell 184,3 5 7 3( 2 0 2 1 ) .\n4 0 . A n d r e a t t a ,M .&C a r m o n a ,S .J .U C ell: Robust and scalable single-\ncell gene signature scoring.Comput. Struct. Biotechnol. J.19,\n3796– 3798 (2021).\n41. Youle, R. J. & Strasser, A. The BCL-2 protein family: opposing\nactivities that mediate cell death.Nat. Rev. Mol. Cell Biol.9,\n47– 59 (2008).\n4 2 . K a p o o r ,I . ,B o d o ,J . ,H i l l ,B .T . ,H s i ,E .D .&A l m a s a n ,A .T a r g e t i n gB C L -\n2 in B-cell malignancies and overcoming therapeutic resistance.\nCell Death Dis.11,9 4 1( 2 0 2 0 ) .\n43. Czabotar, P. E., Lessene, G., Strasser, A. & Adams, J. M. Control of\napoptosis by the BCL-2 protein family: implications for physiology\nand therapy.Nat. Rev. Mol. Cell Biol.15,4 9– 63 (2014).\n44. Klanova, M. & Klener, P. BCL-2 Proteins in pathogenesis and therapy\nof B-cell Non-Hodgkin Lymphomas.Cancers12, https://doi.org/10.\n3390/cancers12040938(2020).\n45. Kamimoto, K. et al. Dissecting cell identity via network inference\nand in silico gene perturbation.Nature 614,7 4 2– 751 (2023).\n46. Jingjing, Z. et al. A novel MEF2C mutation in lymphoid neoplasm\ndiffuse large B-cell lymphoma promotes tumorigenesis by\nincreasing c-JUN expression.Naunyn Schmiedebergs Arch. Pharm.\n393,1 5 4 9– 1558 (2020).\n47. Ying, C. Y. et al. MEF2B mutations lead to deregulated expression of\nt h eo n c o g e n eB C L 6i nd i f f u s el a r g eBc e l ll y m p h o m a .Nat. Immunol.\n14,1 0 8 4– 1092 (2013).\n48. Hodson, D. J. et al. Regulation of normal B-cell differentiation and\nmalignant B-cell survival by OCT2.P r o c .N a t lA c a d .S c i .U S A113,\nE2039– 2046 (2016).\n49. Yu, B. et al. FOXP1 expression and its clinicopathologic signiﬁcance\nin nodal and extranodal diffuse large B-cell lymphoma.Ann.\nHematol.90,7 0 1– 708 (2011).\n50. Brown, P. J. et al. FOXP1 suppresses immune response signatures\nand MHC class II expression in activated B-cell-like diffuse large\nB-cell lymphomas.Leukemia30,6 0 5– 616 (2016).\n5 1 . W l o d a r s k a ,I .e ta l .F O X P 1 ,ag e n eh i g h l ye x p r e s s e di nas u b s e to f\ndiffuse large B-cell lymphoma, is recurrently targeted by genomic\naberrations.Leukemia19,1 2 9 9– 1305 (2005).\n52. Gascoyne, D. M. & Banham, A. H. The signiﬁcance of FOXP1 in\ndiffuse large B-cell lymphoma.Leuk. Lymphoma58,\n1037– 1051 (2017).\n53. Wu, T. et al. The TCF1-Bcl6 axis counteracts type I interferon to\nrepress exhaustion and maintain T cell stemness.Sci. Immunol.1,\nhttps://doi.org/10.1126/sciimmunol.aai8593(2016).\n5 4 . B u t l e r ,A . ,H o f f m a n ,P . ,S m i b e r t ,P . ,P a p a l e x i ,E .&S a t i j a ,R .I n t e -\ngrating single-cell transcriptomic data across different conditions,\ntechnologies, and species.Nat. Biotechnol.36, 411 (2018).\n55. Wang, C. F. et al. Integrative analyses of single-cell transcriptome\nand regulome using MAESTRO.Genome Biol.21,1 9 8\n(2020).\n56. Korsunsky, I. et al. Fast, sensitive and accurate integration of single-\ncell data with Harmony.Nat. Methods16,1 2 8 9( 2 0 1 9 ) .\n57. Wang, X. et al. MarsGT: Multi-omics analysis for rare population\ninference using single-cell graph transformer.Zenodo https://doi.\norg/10.5281/zenodo.8406470(2023).\nAcknowledgements\nThis work was supported by National Key R&D Program of China\n(2020YFA0712400), National Nature Science Foundation of China\n(NSFC, 62272270 and 11931008), and Shandong University multi-\ndisciplinary research and innovation team of young scholars\n(2020QNQT017). This work was supported by the Pelotonia Insti-\ntute of Immuno-Oncology (PIIO). The content is solely the\nresponsibility of the authors and does not necessarily represent the\nofﬁcial views of the PIIO. In addition, we thank Dr. Jordan Krull from\nthe Ohio State University for his valued suggestions in biological\ninsights.\nAuthor contributions\nQ.M. and B.L. conceived the basic idea. X.W. designed the algo-\nrithm, conducted the case study, and wrote the manuscript. M.D.\ncarried out benchmark experiments and wrapped the code. A.M.\nand M.D. participated in the case analysis. J.L. collected the data\nand pre-processed the data. A.M. led theﬁgure design. Z.L. and\nG.X. provided immunological knowledge. D.X. provided deep\nlearning knowledge. All authors participated in the interpretation\nand writing of the manuscript.\nCompeting interests\nThe authors declare no competing interests.\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 17\nAdditional information\nSupplementary informationThe online version contains\nsupplementary material available at\nhttps://doi.org/10.1038/s41467-023-44570-8.\nCorrespondenceand requests for materials should be addressed to\nBingqiang Liu or Qin Ma.\nPeer review informationNature Communicationsthanks Guangyu\nWang and the other, anonymous, reviewer(s) for their contribution to the\npeer review of this work. A peer reviewﬁle is available.\nReprints and permissions informationis available at\nhttp://www.nature.com/reprints\nPublisher’s noteSpringer Nature remains neutral with regard to jur-\nisdictional claims in published maps and institutional afﬁliations.\nOpen AccessThis article is licensed under a Creative Commons\nAttribution 4.0 International License, which permits use, sharing,\nadaptation, distribution and reproduction in any medium or format, as\nlong as you give appropriate credit to the original author(s) and the\nsource, provide a link to the Creative Commons license, and indicate if\nchanges were made. The images or other third party material in this\narticle are included in the article’s Creative Commons license, unless\nindicated otherwise in a credit line to the material. If material is not\nincluded in the article’s Creative Commons license and your intended\nuse is not permitted by statutory regulation or exceeds the permitted\nuse, you will need to obtain permission directly from the copyright\nholder. To view a copy of this license, visithttp://creativecommons.org/\nlicenses/by/4.0/.\n© The Author(s) 2024\nArticle https://doi.org/10.1038/s41467-023-44570-8\nNature Communications|          (2024) 15:338 18",
  "topic": "Population",
  "concepts": [
    {
      "name": "Population",
      "score": 0.6167699098587036
    },
    {
      "name": "Computational biology",
      "score": 0.5766050815582275
    },
    {
      "name": "Inference",
      "score": 0.48272988200187683
    },
    {
      "name": "Computer science",
      "score": 0.4363023340702057
    },
    {
      "name": "Biology",
      "score": 0.41781675815582275
    },
    {
      "name": "Cell",
      "score": 0.41391387581825256
    },
    {
      "name": "Bioinformatics",
      "score": 0.38025832176208496
    },
    {
      "name": "Medicine",
      "score": 0.20228296518325806
    },
    {
      "name": "Genetics",
      "score": 0.1309148371219635
    },
    {
      "name": "Artificial intelligence",
      "score": 0.12762585282325745
    },
    {
      "name": "Environmental health",
      "score": 0.0
    }
  ]
}
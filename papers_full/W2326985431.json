{
    "title": "Eilenberg–Moore Monoids and Backtracking Monad Transformers",
    "url": "https://openalex.org/W2326985431",
    "year": 2016,
    "authors": [
        {
            "id": "https://openalex.org/A5044376589",
            "name": "Maciej Piróg",
            "affiliations": [
                "KU Leuven"
            ]
        }
    ],
    "references": [
        "https://openalex.org/W1998546360",
        "https://openalex.org/W3037159123",
        "https://openalex.org/W2132990655",
        "https://openalex.org/W2182641640",
        "https://openalex.org/W1859242033",
        "https://openalex.org/W583126019",
        "https://openalex.org/W4247177360",
        "https://openalex.org/W2119903195",
        "https://openalex.org/W3002938516",
        "https://openalex.org/W6634414854",
        "https://openalex.org/W2123887510",
        "https://openalex.org/W1970782371",
        "https://openalex.org/W1764096108",
        "https://openalex.org/W1508259349",
        "https://openalex.org/W1980827618",
        "https://openalex.org/W2044178213",
        "https://openalex.org/W2150276232",
        "https://openalex.org/W2079655821",
        "https://openalex.org/W2999365512",
        "https://openalex.org/W2024148855",
        "https://openalex.org/W6681361447",
        "https://openalex.org/W4210839962",
        "https://openalex.org/W2079637559",
        "https://openalex.org/W1996151507",
        "https://openalex.org/W1606211906",
        "https://openalex.org/W2127956576",
        "https://openalex.org/W2149935768",
        "https://openalex.org/W1982998916",
        "https://openalex.org/W2056991192",
        "https://openalex.org/W1580323916",
        "https://openalex.org/W1979039632",
        "https://openalex.org/W2146563885",
        "https://openalex.org/W2106256381",
        "https://openalex.org/W3104184071",
        "https://openalex.org/W2120713972",
        "https://openalex.org/W4300408184",
        "https://openalex.org/W2964176916",
        "https://openalex.org/W2963187563",
        "https://openalex.org/W2148498831"
    ],
    "abstract": "We develop an algebraic underpinning of backtracking monad transformers in the general setting of monoidal categories. As our main technical device, we introduce Eilenberg–Moore monoids, which combine monoids with algebras for strong monads. We show that Eilenberg–Moore monoids coincide with algebras for the list monad transformer ('done right') known from Haskell libraries. From this, we obtain a number of results, including the facts that the list monad transformer is indeed a monad, a transformer, and an instance of the MonadPlus class. Finally, we construct an Eilenberg–Moore monoid of endomorphisms, which, via the codensity monad construction, yields a continuation-based implementation a la Hinze.",
    "full_text": "Atkey & Krishnaswami (Eds.): MSFP 2016\nEPTCS 207, 2016, pp. 23–56, doi:10.4204/EPTCS.207.2\nc⃝ M. Pir´ og\nThis work is licensed under the\nCreative Commons Attribution License.\nEilenberg–Moore Monoids and\nBacktracking Monad Transformers\nMaciej Pir´ og\nDepartment of Computer Science\nKU Leuven, Belgium\nmaciej.pirog@cs.kuleuven.be\nWe develop an algebraic underpinning of backtracking monadtransformers in the general setting\nof monoidal categories. As our main technical device, we introduceEilenberg–Moore monoids,\nwhich combine monoids with algebras for strong monads. We show that Eilenberg–Moore monoids\ncoincide with algebras for the list monad transformer (‘done right’) known from Haskell libraries.\nFrom this, we obtain a number of results, including the factsthat the list monad transformer is\nindeed a monad, a transformer, and an instance of theMonadPlus class. Finally, we construct an\nEilenberg–Moore monoid of endomorphisms, which, via the codensity monad construction, yields a\ncontinuation-based implementation ` a la Hinze.\n1 Introduction\nIn monadic functional programming, the most straightforward approach to backtracking is realised by\nthe list monad [9, 30]. More advanced structures are used forefﬁcient implementation or for combining\nbacktracking with other computational effects [13, 20]. This paper is concerned with a category-theoretic\nexplanation of such more advanced structures.\nHistorically, there has been some dispute over the ‘correct’ deﬁnition of the monad transformer\nassociated with the list monad. First, a popular Haskell librarymtl1 proposed the following deﬁnition\n(in a pseudo-Haskell syntax):\ntype ListT m a = m [a]\nThe idea behind this type is that each computation ﬁrst performs some effects inm, and then returns a\nlist of results. This structure is not entirely satisfactory. One problem with it is strictly mathematical:\nthe list monad transformer deﬁned in this way is not really a monad transformer, since it does not satisfy\nthe required equations in general (it does when the transformed monad m is commutative). A conceptual\ndisadvantage is that it does not fully reﬂect the backtracking aspect of list computations: if we want to\nlook only for the ﬁrst result, we are not necessarily interested in the effects associated with the subsequent\nresults of the computation, while in this implementation allm-effects are performed immediately.\nIn this paper, we consider an alternative deﬁnition of the list monad transformer, known as ‘ListT\ndone right’, which is provided by the Haskell packageslist-t,List, andpipes. It can be implemented\nas follows:\ndata ListT m a = ListT (m (Maybe (a, ListT m a)))\nThe idea is that a value of this type is a list in which each tailis guarded bym. Intuitively, if we want to\nextract then-th result from the computation, we ﬁrst have to perform the effects guarding the elements 1\n1Documentation for each Haskell package is available onlineat http://hackage.haskell.org/package/\nPACKAGE-NAME.\n24 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nton. Jaskelioff and Moggi [18] propose an equational presentation of this monad, on which we expand\nand generalise in this paper (in particular, we abstract to general monoidal categories).\nAnother approach to backtracking transformers—taken, forexample, by Hinze [13] and Kiselyovet\nal.[20]—is to employ continuations. Hinze proposes the following monad, which uses a pair of success\nand failure continuations:\ntype Backtr m a = forall x. (a -> m x -> m x) -> m x -> m x\nHinze derives this monad using Hughes’s [15] ‘context-passing’ technique. As one of our contributions,\nwe relate it to the list monad transformer using the codensity monad construction [14].\nIn this paper, we model structures like those mentioned above in a monoidal categoryC (or, when\nthe continuation-based structures are involved, a closed monoidal category), starting with an algebraic\nspeciﬁcation of backtracking. As our point of departure, wedeﬁne Eilenberg–Moore monoids, which\ncombine the theory of a strong monad (the ‘transformed’ monad), the theory of monoids (which gives\nus choice and failure), and a coherence condition that speciﬁes the order in which computations are\nexecuted. We construct the free monad induced by Eilenberg–Moore monoids, which coincides with\nthe list monad transformer ‘done right’, and introduce a ‘Cayley representation’, which gives us an\nisomorphic continuation-based implementation. In detail, our contributions are the following:\n• In Section 3, given a strong monadM , we introduceEilenberg–Moore M-monoids. They are tu-\nples⟨A,a,m ,u⟩, where⟨A,a⟩ is an Eilenberg–MooreM -algebra, and⟨A,m ,u⟩ is a monoid in the\nambient monoidal category, that satisfy a coherence condition bringing together the algebra struc-\nture, the monoid structure, and the strength of the monad. Then, assuming certain algebraically\nfree monads exist, we construct free Eilenberg–Moore monoids. The monadUF induced by the\nfree–underlying adjunctionF ⊣ U is the list monad transformer applied toM .\n• In Section 4, we show that the category of Eilenberg–MooreM -monoids is isomorphic to the\ncategory of Eilenberg–Moore algebras for the list monad transformer applied toM . As an applica-\ntion of this result, we employ a correspondence between monad morphisms and functors between\nEilenberg–Moore categories to obtain a monad transformer structure.\n• In Section 5, assuming that the ambient category is closed, we introduce an Eilenberg–Moore\nmonoid of endomorphismsMA ⇒ MA . We prove that it is a Cayley representation of a certain\nsubcategory of Eilenberg–Moore monoids. Since this subcategory contains all free Eilenberg–\nMoore monoids, this gives us, via the codensity monad construction [14], a continuation-based\nmonad transformer isomorphic to the list monad transformer. It turns out to coincide with the\nmentioned construction introduced by Hinze [13].\n• In Section 6, to show that the used techniques can be applied more universally, we revisit the\ntransformer for commutative monadsm [a]. We characterise its algebras, which turn out to form\na subcategory of Eilenberg–MooreM -monoids for a commutative monadM . We introduce a\nCayley representationA ⇒ MA of a sufﬁcient subcategory of these monoids, and obtain a novel\ncontinuation-based implementation.\nThus, we relate a number of existing constructions and introduce one new ‘commutative monad’\ntransformer. We take a high-level approach—for example, weuse the resumption monad and its uni-\nversal properties to describe free Eilenberg–Moore monoids, which liberates us from tedious proofs by\nstructural induction. The seemingly arbitrary structure related to the list monad transformer (like the\nlift monad morphism or the instance of theMonadPlus class) is simply a corollary of the general\nresults, and is not only correct by construction, but also recognised as canonically related to the free–\nunderlying adjunctionF ⊣U . The category-theoretic approach allows us to split the tackled constructions\nM. Pir´ og 25\ninto more ﬁne-grained pieces; for example, the role of monadic strength becomes apparent, although in\nHaskell, where all monads are canonically strong, it is usually used implicitly, obfuscating equational\nreasoning.\n2 Background\nWe denote categories byC ,D , . . . . We work in a monoidal category⟨C ,⊗,I⟩ (we additionally assume\nthat it is closed in Section 5, and symmetric closed in Section 6). We use the symbol∼\n= for the structural\nnatural isomorphisms of monoidal categories (instead of the more traditional\nλ ,ρ , andα ). We always\ngive types explicitly, so no confusion should arise. Also, we skip the subscripts in natural transforma-\ntions when the component is obvious from the type (so, for example, we writeMMA\nµ\n− →MA instead of\nMMA\nµA\n− →MA ).\n2.1 Monoids in monoidal categories\nA monoid inC is a triple⟨A, A ⊗ A m− →A, I u− →A⟩, wherem and u are called themultiplicationand the\nunitrespectively, such that the following diagrams commute:\nI⊗ A A ⊗ A A ⊗ I\nA\nu ⊗ id\n∼\n=\nm ∼\n=\nid ⊗ u\n(A ⊗ A) ⊗ A\nA ⊗ (A ⊗ A) A ⊗ A A\nA ⊗ A\nm ⊗ id\n∼\n= id ⊗ m m\nm\nA morphism between monoids ⟨A,m A ,uA ⟩ and ⟨B,m B ,uB ⟩ is a morphismh :A → B in C such that\nh·m A = m B ·(h⊗h) and h·uA = uB . The category of monoids and morphisms between monoids is called\nMon . If the obvious forgetful functorU Mon :Mon → C has a left adjointFMon , the induced monad is a\ngeneralisation of the list monad.\n2.2 Monads and strength\nTo set the notation, we give a number of basic deﬁnitions of monads and some related concepts. A\nmonad on C is a triple⟨M , MM\nµ\n− →M , Id\nη\n− →M ⟩ such that it is a monoid in the monoidal category\nof endofunctors onC with natural transformations as morphisms, and the monoidal tensor given by\ncomposition of endofunctors. We denote a monad simply by itscarrierM , and the monadic structure,\nthat is, the multiplication and the unit, are always denotedµ and η respectively. If there are a number of\nmonads in the context, we sometimes put the name of the monad in superscript, for exampleµ M and η M .\nThe category of monads onC and monad morphisms (that is, morphism between appropriatemonoids)\nis denotedMnd .\nAn Eilenberg–Moore algebra(or simply analgebra) for a monadM on C is a pair⟨A, MA a− →A⟩,\nwhere A is an object inC , whilea is a morphism such thata·Ma = a· µA and a·ηA = idA . Ifa :MA → A\nis a morphism such that the pair⟨A,a⟩ is an Eilenberg–Moore algebra, we say thata has the Eilenberg–\nMoore property. A morphism between two Eilenberg–Moore algebras⟨A,a⟩ and ⟨B,b⟩ is a morphism\nh :A → B such thatb · Mh = h · a. The category of such algebras and such morphisms is called the\nEilenberg–Moore categoryofM .\n26 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nFor a monadM on C there is an adjunction betweenC and the Eilenberg–Moore category ofM\ngiven on objects asA ↦→ ⟨MA ,µA ⟩ in one direction and⟨A,a⟩ ↦→A in the other direction. For every other\nadjunctionL ⊣ R :C → D that inducesM , there exists a functor (called thecomparison functor) fromD\nto the Eilenberg–Moore category ofM . It is deﬁned on objects as\nX ↦→ ⟨RX , MRX =− →RLRX Rε− →RX ⟩,\nwhere ε is the counit of the adjunctionL ⊣ R. If the comparison functor is an isomorphism, we say that the\nadjunctionL ⊣ R isstrictly monadic. An example of a strictly monadic adjunction isFMon ⊣ U Mon . This\nentails that the Eilenberg–Moore category of the list monadis isomorphic to the category of monoids.\nAn endofunctorG isstrongif it is equipped with a transformationτ :GA ⊗ B → G (A ⊗ B) (called a\nstrengthofG ) natural inA and B such that the following diagrams commute:\nGA ⊗ I G (A ⊗ I)\nGA\nτ\n∼\n=\n∼\n=\nGA ⊗ (B ⊗C )\n(GA ⊗ B) ⊗C G (A ⊗ B) ⊗C G ((A ⊗ B) ⊗C )\nG (A ⊗ (B ⊗C ))\nτ\n∼\n= τ ⊗ id τ\n∼\n=\nA monad M isstrongif it is strong as an endofunctor, and additionally the following diagrams commute:\nA ⊗ B MA ⊗ B\nM (A ⊗ B)\nη ⊗ id\nη\nτ\nMMA ⊗ B\nM (MA ⊗ B) MM (A ⊗ B) M (A ⊗ B)\nMA ⊗ B\nµ ⊗ id\nτ\nM τ µ\nτ\nWhile a monad can have more than one strength, inSet(and in Haskell), every monad is equipped with\na canonical strength given by⟨m ,b⟩ ↦→(M (λ a.⟨a,b⟩))(m ). A strong monad onC can be turned into a\nmonoid inC :\nTheorem 1 (Wolff [32]). Let M be a strong monad onC . Then, the tuple⟨MI ,m,u⟩, where\nm =\n(\nMI ⊗ MI τ− →M (I⊗ MI )\n∼\n=− →MMI\nµ\n− →MI\n)\nand u =\n(\nI\nη\n− →MI\n)\n,\nis a monoid.\n2.3 Strongly generated algebraically free monads\nGiven an endofunctorG on C , consider the category ofG -algebras, that is, pairs⟨A,GA a− →A⟩, and\nmorphisms ⟨A,a⟩ → ⟨B,b⟩ given byC -morphisms h :A → B such thatb · Gh = h · a. If the obvious\nforgetful functor from the category ofG -algebras toC has a left adjoint, we denote the free algebra\ngenerated by an objectA as ⟨G ∗A,GG ∗A cons− − →G ∗A⟩, and call the induced monadG ∗ thealgebraically\nfreemonad generated byG . This adjunction is strictly monadic, which entails that the category ofG -\nalgebras is the Eilenberg–Moore category ofG ∗. We denote the monadic structure of the algebraically\nfree monad as\nµ F and η F . The freeness property of⟨G ∗A,cons⟩can be described as follows, where the\nmorphism emb is given byGA\nG η F\n− − − →GG ∗A cons− − →G ∗A.\nM. Pir´ og 27\nTheorem 2. For a morphism GA\ng\n− →A, there exists a unique morphism G∗A\n/llbracketg/rrbracket\n− − →A such that the following\ndiagram commutes:\nGA G ∗A\nA\nemb\ng /llbracketg/rrbracket\nIfC has coproducts, the carrier of the free algebra⟨G ∗A,cons⟩ can be given as the carrier of the\ninitial(G (–)+ A)-algebra (if it exists), that is,G ∗A = µ X .GX +A. For endofunctorsG and H , if bothG ∗\nand H ∗ exist, every natural transformationh :G → H induces a monad morphismh∗ :G ∗ → H ∗ given as\nG ∗A\nG ∗η F\n− − − →G ∗H ∗A\n/llbracketcons·h/rrbracket\n− − − − →H ∗A. Note that we use the notation(–)∗ as if it was a functor, although in\ngeneral not all endofunctors induce algebraically free monads. IfG is strong, we deﬁne in what wayG ∗\ncan inherit the strength ofG in a coherent fashion:\nDeﬁnition 3.LetG be a strong endofunctor such thatG ∗ exists. We say thatG ∗ isstrongly generatedif\nfor all morphismsf :A ⊗B → C and aG -algebra⟨C ,c⟩, there exists a unique morphismˆ\nf that makes the\nfollowing diagram commute:\nGG ∗A ⊗ B\nG ∗A ⊗ B\nA ⊗ B\nG (G ∗A ⊗ B) GC\nC\nτ\ncons ⊗ id\nη F ⊗ id\nˆf\nf\nG ˆf\nc\nA strongly generated monad is strong with the strength givenby ˆη forη :A ⊗ B → M (A ⊗ B).\nMoreover, for a natural transformationh :G → H , the monad morphismh∗ :G ∗ → H ∗ preserves strength,\nthat is,h∗ · τ = τ · (h∗ ⊗ id). If the categoryC is closed (for example,Set), all algebraically free monads\ngenerated by strong endofunctors are strongly generated (see Fiore [11, Theorem 4.4]). In this paper, we\nassume that all the algebraically free monads that we deal with are strongly generated.\n2.4 The resumption monad\nAnother construction that we use is theresumption monadintroduced by Moggi [24], also known as\nthefree monad transformer. Given a monadM and an endofunctorG , it is given as the composition\nM (GM )∗ if(GM )∗ exists. In the case of the free monad given by initial algebras, it becomesA ↦→\nM (\nµ X .GMX + A). Using the rolling lemma [5], it is isomorphic toA ↦→µ X .M (GX + A).\nWe notice that the endofunctor part of the list monad transformer that we work with in this paper can\nbe given by initial algebrasA ↦→µ X .M ((A ⊗X )+ I) ∼\n= M (A ⊗M (–))∗I, which are similar in shape to the\nresumption monad for the endofunctor(A ⊗ –) applied to the objectI (and this is how it is implemented\nin the Haskell packagepipes). Although the monadic structure ofLMTM is not given directly by the\nmonadic structure of the resumption monad, the two are related.\nHyland, Plotkin, and Power [16] show two important properties of the resumption monad. The ﬁrst\none is that it is induced by a distributive law\nλ :(GM )∗M → M (GM )∗. Thus, its monadic structure can\n28 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nbe deﬁned asµ R = µ M µ F ·M λ (GM )∗ and η R = η M η F . Moreover, a natural transformationh :G → H\ninduces a monad morphismM (hM )∗ :M (GM )∗ → M (HM )∗. In general, the composition of two strong\nendofunctors is strong, and the composition of two strong monads via a distributive law is strong. Thus,\nifM and G are strong, and(GM )∗ is strongly generated, the resumption monadM (GM )∗ is strong.\nThe other important property of the resumption monad is thatM (GM )∗ is the coproduct inMnd\nof M and G ∗. A classical result by Kelly [19] states that the coproduct in Mnd of two monadsM\nand T is always given by the free–underlying adjunction between the base category and the category\nof tuples⟨A, MA m− →A, TA t− →A⟩, where bothm and t have the Eilenberg–Moore property. Moreover,\nthis adjunction is strictly monadic. Thus, using the correspondence between Eilenberg–Moore algebras\nfor algebraically free monads and algebras for endofunctors, Hyland, Plotkin, and Power describe the\nEilenberg–Moore category of the resumption monad for an endofunctorG and a monadM as consisting\nof tuples⟨A,MA a− →A,GA\ng\n− →A⟩such thata has the Eilenberg–Moore property. Adapting Kelly’s result,\nthe freeness property of the resumption monad can be stated as follows, where the natural transformation\nINF (injection of the functor) is deﬁned as:\nINF =\n(\nG\nG η M\n− − − →GM emb− − →(GM )∗ η M\n− − →M (GM )∗\n)\nTheorem 4. Given an Eilenberg–Moore algebra⟨B, MB b− →B⟩, an algebra⟨B, GB\ng\n− →B⟩, and a mor-\nphism h:A → B, there exists a unique morphism⟨ ⟨b,g,h⟩ ⟩:M (GM )∗A → B such that the following\ndiagrams commute:\nM (GM )∗AMM (GM )∗A M (GM )∗M (GM )∗A GM (GM )∗A\nBMB GB\n⟨ ⟨b,g,h⟩ ⟩\nµ M\nb\nM ⟨ ⟨b,g,h⟩ ⟩\nINFµ R\nG ⟨ ⟨b,g,h⟩ ⟩\ng\nM (GM )∗AA\nB\nη R\n⟨ ⟨b,g,h⟩ ⟩h\nMorphisms ⟨ ⟨–,–,–⟩ ⟩enjoy some equational properties that we ﬁnd useful in the remainder of this\npaper:\nLemma 5. Given b, g, and h as in the previous theorem, the following hold:\n1. The morphism⟨ ⟨b,g,h⟩ ⟩can be expressed as M(GM )∗A\nM (GM )∗h\n− − − − − →M (GM )∗B\n⟨ ⟨b,g,id⟩ ⟩\n− − − − →B.\n2. The morphism⟨ ⟨b,g,id⟩ ⟩has the Eilenberg–Moore property, and it is equal to M(GM )∗B\nM /llbracketg·Gb /rrbracket\n− − − − − →\nMB b− →B.\n3. The morphism GAINF− − →M (GM )∗A\n⟨ ⟨b,g,h⟩ ⟩\n− − − − →B is equal to GAGh− →GB\ng\n− →B.\n3 Eilenberg–Moore monoids\nIn this section, we introduce Eilenberg–Moore monoids, which serve as an algebraic speciﬁcation of\nbacktracking combined with other effects. Then, we construct free Eilenberg–Moore monoids, which\ninduce the list monad transformer.\nDeﬁnition 6.LetM be a strong monad on a monoidal categoryC . AnEilenberg–Moore M-monoidis a\ntuple\n⟨A, MA a− →A, A ⊗ A m− →A, I u− →A⟩\nsuch that the following hold:\nM. Pir´ og 29\n1. ⟨A,a⟩ is an Eilenberg–MooreM -algebra,\n2. ⟨A,m ,u⟩ is a monoid,\n3. coherence: the following diagram commutes:\nMA ⊗ A\nM (A ⊗ A)\nA ⊗ A\nMA A\na ⊗ id\nτ\nMm a\nm\nA morphism between two Eilenberg–MooreM -monoids is a morphism inC that is both a morphism\nbetween M -algebras and between monoids. We call the category of Eilenberg–Moore M -monoids and\nsuch morphismsEMMon M .\nExample 7. LetC be Set. LetM = G ∗ be the free monad generated by the functorGX = X × X , that is,\nG ∗ is the free monad of the theory of a single binary operation. Consider the tuple⟨N, /llbracket(+)/rrbracket:G ∗N →\nN,(∗) :N × N → N, λ x.1 :I → N⟩, in which we interpret the monad operation as addition, while the\nmonoid is given by natural numbers with multiplication. It is an Eilenberg–Moore monoid. In this case,\nthe coherence condition amounts to the right-distributivity of multiplication over addition.\nAlthough to the author’s best knowledge Eilenberg–MooreM -monoid is a new concept, it is an\nobvious generalisation of the concept ofF -monoid:\nDeﬁnition 8(Fiore, Plotkin, and Turi [12]). F-monoids are similar to Eilenberg–Moore monoids, but we\ndrop the condition (1) from Deﬁnition 6 and the assumption that the endofunctor is a monad (that is, it is\nmerely a strong endofunctor).\nWe also need the following technical lemma, which relatesF -monoids to Eilenberg–Moore monoids\nfor free monads. Note that it could be used for a simple proof that the tuple from Example 7 is an\nEilenberg-Moore monoid.\nLemma 9. Let G be a strong endofunctor that strongly generates a free monad G∗. Then, each G-monoid\n⟨A, GA\ng\n− →A, A ⊗ A m− →A, I u− →A⟩ gives rise to an Eilenberg–Moore G∗-monoid⟨A, G ∗A\n/llbracketg/rrbracket\n− − →A, m , u⟩.\nFrom the perspective of algebraic effects (see Hyland and Power [17]), Eilenberg–MooreM -monoids\ncan be seen as the right-distributive tensor of the theory ofmonoids over the theory of the monadM . Each\nEilenberg–Moore monoid consists of a monoid and an interpretation of operations provided byM , while,\ndenoting the monoid multiplication as∨, for ann-aryM -operationf, the coherence diagram becomes\nthe following equation:\nf(x1,... ,xn) ∨ y = f(x1 ∨ y,...,xn ∨ y)\nIntuitively, it states that when making a choice between twovalues, the effects in the left-hand argument\nare always executed ﬁrst. This differentiates backtracking from plain nondeterminism, where no order of\nexecution is imposed. Note that the list monad is used for backtracking usually in lazy languages, where\nlaziness is the effect that deﬁnes the order in which elements arrive. In eager languages, backtracking\ncan be implemented usinglazy lists, in which laziness is an explicit effect. Indeed, the type oflazy lists\nis an instance of the list monad transformer (see Section 7).\n30 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n3.1 Free Eilenberg–Moore monoids\nNow, we describe free Eilenberg–Moore monoids, which give us the monadic structure of the list monad\ntransformer. First, we need an auxiliary deﬁnition:\nDeﬁnition 10.For a monadM and aC -objectA, we deﬁne the functor(A⋉M )X = A ⊗ MX .\nNote that each morphismf :A → B induces a natural transformationf⋉M :A⋉M → B⋉M . IfM\nis strong, the functorA⋉M is strong via(A ⊗ MB ) ⊗C\n∼\n=− →A ⊗ (MB ⊗C ) id⊗\nτ− − →A ⊗ M (B ⊗C ). If the\nmonad (A⋉M )∗ exists and is strongly generated, we denote the resulting strength as˜τ :(A⋉M )∗B ⊗C →\n(A⋉M )∗(B ⊗C ). Our main result follows.\nTheorem 11. Let M be a strong monad. Assume that there exists a strongly generated algebraically\nfree monad(A⋉M )∗ for all objects A. Then, the obvious forgetful functor U:EMMon M → C has a left\nadjoint F:C → EMMon M given as follows:\nFA = ⟨M (A⋉M )∗I, µ M , m, u⟩\nF ( f :A → B) =M ( f⋉M )∗I,\nwhere ⟨M (A⋉M )∗I,m,u⟩ is the monoid induced by the resumption monad as described inTheorem 1.\nIn detail, the associated natural isomorphism⌊–⌋ :EMMon M (FA ,⟨B,b,m B ,uB ⟩) ∼\n= C (A,B) :⌈–⌉ is\ndeﬁned as follows. Letf :FA → ⟨B,b,m B ,uB ⟩ be a morphism between Eilenberg–MooreM -monoids.\nThe C -morphism ⌊ f⌋ :A → B is deﬁned as:\nA\n∼\n=− →A ⊗ I INF− − →M (A⋉M )∗I\nf\n− →B\nIn the other direction, letg :A → U ⟨B,b,m B ,uB ⟩ be aC -morphism. Then, theEMMon M -morphism\n⌈g⌉ :FA → ⟨B,b,m B ,uB ⟩ is deﬁned as:\nM (A⋉M )∗I\n⟨ ⟨MB\nb\n− →B,A⊗B\ng⊗id\n− − →B⊗B\nm B\n− →B,I\nuB\n− →B⟩ ⟩\n− − − − − − − − − − − − − − − − − − − − − − − − →B\nDeﬁnition 12.We call the monadUF induced by the adjunction above thelist monad transformerand\ndenote it asLMTM .\nTo get a more direct deﬁnition of the monadic structure ofLMTM , let\nε⟨A,a,m A ,uA ⟩ = ⌈A id− →A⌉ be the\ncounit of the adjunction. The monad multiplication is thus given as follows:\n(\nUFUF U εF− − →UF\n)\n=\n(\nM (M (A⋉M )∗⋉M )∗I\n⌈id⌉=⟨ ⟨µ M ,m,u⟩ ⟩\n− − − − − − − − − →M (A⋉M )∗I\n)\nThe unit ofLMTM is given as:⌊id⌋ =\n(\nA\n∼\n=− →A ⊗ I INF− − →M (A⋉M )∗I\n)\n.\nWe can also verify that the morphismsm and u form aMonadPlus structure [29]. They obviously\nform a monoid, so it is left to verify two additional laws: left distributivity and left zero (or, in the\nlanguage of Plotkin and Power [27], thatm and u arealgebraic). The desired laws are simply the\npreservation of the multiplication and the unit byU\nεF , which follows from the fact thatεF is a morphism\nbetween Eilenberg–Moore monoids.\nM. Pir´ og 31\n4 Algebras for the list monad transformer\nThe previous section shows a construction of an adjunctionF ⊣ U that gives rise to the monadLMTM ,\nbut it is not an ordinary adjunction: we show that it is strictly monadic. We use this fact to construct\nsome monad morphisms.\nTheorem 13. The adjunction F⊣ U is strictly monadic. This entails that the categoryEMMon M is\nisomorphic to the category of Eilenberg–Moore algebras of the monad LMTM .\nAs an application of Theorem 13, we show thatLMT is indeed a monad transformer, that is, we\nconstruct a monad morphism from a monadM toLMTM . Instead of deﬁning the morphism directly and\nmundanely verifying the necessary properties, we utilise the following theorem (see Barr and Wells [6,\nCh. 3, Theorem 6.3]):\nTheorem 14. LetEM be a category in which objects are Eilenberg–Moore categories of monads onC ,\nwhile morphisms are carrier-preserving functors (that is,functors that commute with the forgetful func-\ntors from Eilenberg–Moore categories toC ). Then, there exists an isomorphismMnd ∼\n= EM op, where\nMnd is the category of monads onC and monad morphisms.\nIn detail, given two monadsT and M , consider a carrier-preserving functorF , and let⟨TA , MTA a− →\nTA ⟩= F ⟨TA ,\nµ T ⟩. Now, the monad morphism corresponding toF is given for an objectA asMA\nM η T\n− − − →\nMTA Ma− − →TA .\nThere exist obvious forgetful functors fromEMMon M to the category of monoids and to the category\nof algebras forM . These give us two monad morphisms: from the list monad and from M respectively.\nThe latter is the desiredlift operation of monad transformers. Following the description above, it is\ngiven as follows:\n(\nMA\nM η LMTM\n− − − − − →MM (A⋉M )∗I\nµ M\n− − →M (A⋉M )∗I\n)\n=\n(\nMA M ∼\n=− − →M (A ⊗ I) M emb− − − →M (A⋉M )∗I\n)\nMoreover, there exists a forgetful functor fromEMMon M to the Eilenberg–Moore category of\nthe resumption monad generated by the endofunctorA ↦→A ⊗ A. This forgetful functor is given as\n⟨A,a,m ,u⟩ ↦→ ⟨A,a,m ⟩, and it induces a monad morphism from the resumption monad toLMTM , which\nﬂattens the tree structure into a list.\n5 Continuation-based implementation\nIn this section, we deal with a continuation-based backtracking monad transformer ` a la Hinze [13] men-\ntioned in the introduction. We derive it from the list monad transformer using the codensity monad\nconstruction, thus automatically obtaining that the two monads are isomorphic. First, we discuss some\nbackground on closed monoidal categories, which we need to model continuations.\n5.1 Background: closed monoidal categories\nA monoidal category⟨C ,⊗,I⟩ isclosedif for allC -objectsB, the functor(–) ⊗ B has a right adjoint\nB ⇒ (–). The associated natural isomorphisms⌊–⌋⊗ :C (A ⊗ B,C ) ∼\n= C (A,B ⇒ C ) :⌈–⌉⊗ are currying\nand uncurrying respectively. We call the counit of this adjunctionapp :(A ⇒ B) ⊗ A → B. Note that for\na morphismg :A ⊗ B → C , it is the case that the morphismA ⊗ B\n⌊g⌋⊗⊗id\n− − − − →(B ⇒ C ) ⊗ B\napp\n− − →C is equal\ntog.\n32 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nFor objectsA,B, andC , we deﬁne the following morphismk:\nk =\n(\n((B ⇒ C ) ⊗ (A ⇒ B)) ⊗ A\n∼\n=− →(B ⇒ C ) ⊗ ((A ⇒ B) ⊗ A)\nid⊗app\n− − − − →(B ⇒ C ) ⊗ B\napp\n− − →C\n)\nWe deﬁne the ‘composition’ morphismcomp = ⌊k⌋⊗ :(B ⇒ C ) ⊗ (A ⇒ B) → A ⇒ C and the identity\nmorphism ident = ⌊I⊗ A\n∼\n=− →A⌋⊗ :I→ (A ⇒ A). The triple⟨A ⇒ A,comp,ident⟩ forms a monoid.\n5.2 Cayley representation of ‘Kleisli’ Eilenberg–Moore monoids\nThe codensity monad of a functorG :D → E is given by the right Kan extension ofG along itself\nRanG G :E → E (see Mac Lane [23, Ch. X] or Leinster [22]). Using the coend representation of Kan\nextensions, one can implement the codensity monad of a Haskell functorf as follows:\ndata Cod f a = Cod (forall x. (a -> f x) -> f x)\nIt is known that the codensity monad of a right adjoint is isomorphic to the monad induced by the\nadjunction. Hinze [14] gives the following example of how one can use this fact to derive a continuation-\nbased implementation of the list monad. First, we can simulate the forgetful functor from the category\nof monoids using a class constraint:\ndata L1 a = L1 (forall w. (Monoid w) => (a -> w) -> w)\nNow, instead of relying on instances of theMonoid class, one can use the universal monoid of endomor-\nphismsx -> x. A classic result by Cayley states that every monoid can be represented as a submonoid\nof the universal monoid (this submonoid is called theCayley representation). Thus, we can equivalently\ndeﬁne the monad in question as follows:\ndata L2 a = L2 (forall x. (a -> x -> x) -> x -> x)\nIn this section, we give a similar construction to obtain a continuation-based implementation of the list\nmonad transformer. We start with an Eilenberg–Moore monoidof endomorphismsMA ⇒ MA :\nTheorem 15. LetC be closed monoidal. Then, the tuple\n⟨MA ⇒ MA , ⌊p⌋⊗, comp, ident⟩,\nwhere\np =\n(\nM (MA ⇒ MA ) ⊗ MA\nτ− →M ((MA ⇒ MA ) ⊗ MA )\nM app\n− − − →MMA\nµ\n− →MA\n)\n,\nis an Eilenberg–Moore monoid.\nUnfortunately, the Eilenberg–Moore monoid deﬁned in Theorem 15 is not universal. For that, we\nwould have to deﬁne a morphism⟨A,a,m ,u⟩ → ⟨ MA ⇒ MA ,⌊p⌋⊗,comp,ident⟩ for each Eilenberg–\nMoore monoid ⟨A,a,m ,u⟩, while it is in general not possible to deﬁne a morphismg :A → (MA ⇒ MA )\nthat is a morphism between Eilenberg–Moore algebras⟨A,a⟩ and ⟨MA ⇒ MA ,⌊p⌋⊗⟩. To make the\nconstruction work, we need to slightly restrict the domain of the forgetful functorU .\nFirst, we give some intuition. The universal property of theadjunctionF ⊣ U described in Theo-\nrem 11 is a folding property: given morphismsa :MA → A,m :A ⊗ A → A,u :I → A, andh :B → A,\nas long asa,m , andu satisfy the conditions given in the deﬁnition of Eilenberg–Moore monoids, we\nobtain a unique coherentfold, that is, a morphismLMTM B → A. It could be also understood as ‘running’\nor ‘interpreting’ the monadic computation. However, in programming, when we ‘run’ a backtracking\ncomputation, we do not interpret it as a value of some typeA. Rather, we interpret it as a value in the\nM. Pir´ og 33\nbase monad, that is,MA . In other words, we fold the structure of the list, but, instead of eliminating\nthe monadic parts using an Eilenberg–Moore algebraa :MA → A, we accumulate it using the monadic\nmultiplicationµ .\nThus, we are interested in Eilenberg–Moore monoids of the shape ⟨MA ,µ ,m ,u⟩, which we call,\nfor the sake of this article,Kleisli monoids, referring to the known fact that the full subcategory of the\nEilenberg–Moore category of a monadM that consists of algebras of the shape⟨MA ,µ ⟩ is equivalent to\nthe Kleisli category ofM . We call the full subcategory ofEMMon M that consists of Kleisli monoids\nKlMon M . The restriction of the forgetful functorU :EMMon M → C to KlMon M is dubbedU Kl :\nKlMon M → C .\nA useful observation is that free Eilenberg–Moore monoids deﬁned in Theorem 11 are also Kleisli\nmonoids. This means thatU Kl has a left adjointFKl deﬁned in the same way asF , and that the monad\ninduced byFKl ⊣ U Kl is the same monad as the one induced byF ⊣ U , that is,LMTM . Therefore, the\nmonad LMTM is also isomorphic to the codensity monad ofU Kl. This way, it is enough for our purposes\nto ﬁnd a Cayley representation of Kleisli monoids, not necessarily all Eilenberg–Moore monoids. The\nEilenberg–Moore monoidMA ⇒ MA from Theorem 15, although not a Kleisli monoid itself, is universal\nfor Kleisli monoids:\nTheorem 16. For each Kleisli monoid⟨MA ,\nµ ,m ,u⟩, the morphism⌊m ⌋⊗ :MA → (MA ⇒ MA ) has the\nfollowing properties:\n• it is an Eilenberg–Moore monoid morphism⟨MA ,µ ,m ,u⟩ → ⟨MA ⇒ MA ,⌊p⌋⊗,comp,ident⟩,\n• it is a split monomorphism inC , that is, there exists a morphism r:(MA ⇒ MA ) → MA in C such\nthat r· ⌊m ⌋⊗ = id.\nUsing the codensity monad for this representation yields the following monad transformer:\ntype Backtr m a = forall x. (a -> m x -> m x) -> m x -> m x\nIt is the same monad transformer as obtained, although usingdifferent methods, by Hinze [13].\n6 Revisiting the ‘effects-ﬁrst’ transformer for commutative monads\nNow, we revisit the commutative-monad transformerm [a] known from themtl library in Haskell. We\ncall it a ‘commutative-monad transformer’, as it is a monad if and only if the transformed monad is\ncommutative (see, for example, Mulry [25]). In this section, we derive its continuation-based isomorph,\nrecreating the steps for theLMTM monad presented in previous sections. We assume thatC is symmetric\nclosed, and thatM is commutative.\n6.1 Background: symmetric monoidal categories and commutative monads\nA monoidal category issymmetricif it is equipped with a natural isomorphismA ⊗ B s− →B ⊗ A such that\nsym is an involution (that is,sym · sym = id) and the following diagrams commute:\nI⊗ A A ⊗ I\nA\nsym\n∼\n=\n∼\n=\n(A ⊗ B) ⊗C\nA ⊗ (B ⊗C ) ( B ⊗C ) ⊗ A\n(B ⊗ A) ⊗C\nB ⊗ (C ⊗ A)\nB ⊗ (A ⊗C )\nsym ⊗ id ∼\n=\n∼\n= sym ∼\n=\nid ⊗ sym\n34 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nIn a symmetric monoidal category, we deﬁne aleft strengthfor a strong monadM :\nτ′ =\n(\nA ⊗ MB\nsym\n− − →MB ⊗ A τ− →M (B ⊗ A)\nM sym\n− − − →M (A ⊗ B)\n)\nOne can show that the appropriate mirror images of the diagrams for a strong endofunctor and a strong\nmonad commute forτ′. A monad iscommutativeif it is equipped both with a (right) strength and a left\nstrength, and the following diagram commutes for all objects A and B:\nMA ⊗ MB\nM (A ⊗ MB ) MM (A ⊗ B)\nM (MA ⊗ B)\nM (A ⊗ B)\nMM (A ⊗ B)\nτ′ M τ\nτ\nM τ′ µ\nµ\nIfC is a closed symmetric monoidal category andM is commutative, we deﬁne the Kleisli composi-\ntion. First, for all objectsA,B, andC , consider the following morphism:\nw =\n(\n((B ⇒ MC ) ⊗ (A ⇒ MB )) ⊗ A\n∼\n=− →(B ⇒ MC ) ⊗ ((A ⇒ MB ) ⊗ A)\nid⊗app\n− − − − →(B ⇒ MC ) ⊗ MBτ′\n− →M ((B ⇒ MC ) ⊗ B)\nM app\n− − − →MMC\nµ\n− →MC\n)\nWe deﬁne the composition of Kleisli morphisms askcomp = ⌊w ⌋⊗ :(B ⇒ MC )⊗(A ⇒ MB ) → A ⇒ MC ,\nand the identity as⌊I⊗ A\n∼\n=− →A\nη\n− →MA ⌋⊗ :I → A ⇒ MA . The triple⟨A ⇒ MA ,kcomp,kident⟩ is a\nmonoid.\n6.2 Symmetric Eilenberg–Moore monoids\nWe now describe how the monadm [a] arises as a composition of adjoint functors. This is not a new\nconstruction, so we skip the proofs. Consider the categoryMon of monoids in a symmetric monoidal\ncategoryC . Assume that the obvious forgetful functorU Mon :Mon → C has a left adjointFMon :C →\nMon . The induced monadU Mon FMon is the list monad. Now, given a commutative monadM on C , we\ndeﬁne a monad\nM on Mon (in fact, a lifting in the sense of Beck [8]). It is given as follows:\nM ⟨A,m ,u⟩= ⟨MA , MA ⊗ MA τ− →M (A ⊗ MA ) M τ′\n− − →MM (A ⊗ A)\nµ m\n− − →MA , I u− →A\nη\n− →MA ⟩\nM f = M f\nµ M = µ η M = η\nLet FM ⊣ U M be the Eilenberg–Moore adjunction ofM . Since adjoint functors compose, we obtain an\nadjunctionFM FMon ⊣ U Mon U M . The induced monadU Mon U M FM FMon corresponds to the Haskell monad\nm [a]. Here, we call this monadCLTM (‘commutative list transformer’).\nNow, we take a closer look at the Eilenberg–Moore category ofM . Each object consists of a pair\n⟨⟨A,m ,u⟩,a⟩, where⟨A,m ,u⟩ is a monoid, anda has the Eilenberg–Moore property, that is,a·Ma = a· µ\nand a·η = id (since the monadic structure ofM is identical to the monadic structure ofM ). Note thata is\na morphism inMon , so it preserves the monoid structure. That is, the following two diagrams commute:\nMA ⊗ MA\nM (A ⊗ MA ) MM (A ⊗ A) MA\nA ⊗ A\nA\nτ\nM τ′ µ m a\nm\na ⊗ a\n(1)\nM. Pir´ og 35\nI A MA\nA\nu η\na\nu (2)\nNote that the diagram (2) commutes for alla with the Eilenberg–Moore property. This, together with\nsome rearranging of the elements of the tuples, leads us to the following equivalent deﬁnition of algebras\nforM :\nDeﬁnition 17.Let M be a commutative monad on a symmetric monoidal categoryC . A symmetric\nEilenberg–Moore M-monoidis a tuple⟨A,a,m ,u⟩, such that:\n• ⟨ A,a⟩ is an Eilenberg–Moore algebra,\n• ⟨ A,m ,u⟩ is a monoid,\n• coherence: the diagram (1) commutes.\nA morphism between two symmetric Eilenberg–MooreM -monoids is given by aC -morphism that is\nboth a morphism between the Eilenberg–Moore algebra parts and the monoid parts. We call the category\nof symmetric Eilenberg–MooreM -monoidsSEMMon M .\nThe name is justiﬁed by the following theorem:\nTheorem 18. Every symmetric Eilenberg–Moore M-monoid is an Eilenberg–Moore M-monoid.\nRemark 19. One could also imagine a ‘twisted’ deﬁnition of Eilenberg–Moore monoids that usesτ′\ninstead ofτ, and a coherence condition that equates the two corresponding morphisms A ⊗ MA → A.\nThe proof of Theorem 18 can be easily adapted to state that every symmetric Eilenberg–Moore monoid\nis a ‘twisted’ Eilenberg–Moore monoid. Additionally, one can prove that a quadruple that is both an\nEilenberg–Moore monoid and a ‘twisted’ Eilenberg–Moore monoid for a commutative monadM is nec-\nessarily a symmetric Eilenberg–Moore monoid.\nSince the deﬁnition of symmetric Eilenberg–Moore monoids is a simple rearrangement of the deﬁni-\ntion of algebras forCLTM , the adjunctionFM FMon ⊣ U Mon U M gives us that the obvious forgetful functor\nU SEMMon :SEMMon M → C has a left adjointFSEMMon , and that the induced monad is equal toCLTM .\nAlthough a composition of two monadic adjunctions is not always monadic, it is so in this case (it follows\nform a general theorem of Beck about algebras for composite monads [8, Proposition 2]):\nTheorem 20. The adjunction FSEMMon ⊣ U SEMMon is strictly monadic. This entails thatSEMMon M is\nisomorphic to the category of algebras forCLTM .\n6.3 Endomorphism representation and a continuation-basedimplementation\nNow, assume thatC is a closed symmetric monoidal category. We deﬁne a symmetric Eilenberg–Moore\nmonoid of Kleisli endomorphisms, that is, objectsA ⇒ MA :\nTheorem 21. LetC be a symmetric closed monoidal category, and M be a commutative monad onC .\nThen, the tuple\n⟨A ⇒ MA , ⌊q⌋⊗, kcomp, kident⟩,\nwhere\nq =\n(\nM (A ⇒ MA ) ⊗ A τ− →M ((A ⇒ MA ) ⊗ A)\nM app\n− − − →MMA\nµ\n− →MA\n)\n,\nis a symmetric Eilenberg–Moore monoid.\n36 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nIt is left to prove that the monoidA ⇒ MA is universal for the sufﬁcient subcategory of symmetric\nEilenberg–Moore monoids:\nTheorem 22. For each symmetric Eilenberg–Moore monoid of the shape⟨MA ,\nµ ,m ,u⟩, the morphism\n⌊s⌋⊗ :MA → (A ⇒ MA ), where\ns=\n(\nMA ⊗ A\nid⊗η\n− − − →MA ⊗ MA m− →MA\n)\n,\nhas the following properties:\n• it is a morphism⟨MA ,µ ,m ,u⟩ → ⟨A ⇒ MA ,⌊q⌋⊗,kcomp,kident⟩ between symmetric Eilenberg–\nMoore monoids,\n• it is a split monomorphism inC , that is, there exists a morphism r:(A ⇒ MA ) → MA in C such\nthat r· ⌊s⌋⊗ = id.\nThe codensity monad that uses the representation above can be encoded in Haskell as follows:\ndata CLT m a = CLT (forall x. (a -> x -> m x) -> x -> m x)\nIntuitively, this type represents folds over a list-like structure. Folding a single element can produce\nsome effects in the monadm, but it does not depend on the effects produced by previous elements (it\ncan depend on the values though). The nil of the list (that is,the failure continuation) does not produce\nmonadic effects on its own.\n7 Discussion\nEquations similar to the conditions in the deﬁnition of Eilenberg–Moore monoids were previously dis-\ncussed by Hinze [13], although in a different setting, that is, as equations between Haskell expressions.\nJaskelioff and Moggi [18] suggest that an equational theorylike the one discussed in Section 3 induces\nthe list monad transformer, but they leave this without a proof. Wand and Vaillancourt [31] use logical\nrelations to compare two metalanguages with backtracking:one based on streams, and the other on a\ntwo-continuation monad. Eilenberg–Moore algebras of the resumption monad are also known asF -and-\nM -algebras. They were used by Filinski and Støvring [10] (andlater by Atkeyet al.[3, 4]) to model data\nstructures that interleave pure data and effects.\nIn eager languages, the bare list monad is rarely used as a basis of backtracking computations, since\nthe entire list structure is always computed upfront. Thus,in ML-like languages, one uses the type of lazy\nlists, which produce elements on demand. It can be implemented using the Haskell syntax as follows:\ndata LazyList a = LazyList (() -> Maybe (a, LazyList a))\nGiven a value of this type, one can force the next step of the computation by supplying the unit value(),\nand only then the structure is evaluated. This is nothing else than the list monad transformer (‘done\nright’) applied to the reader monad() -> a.\nSome languages provide separate primitives for inductive and coinductive data. From the point of\nview of semantics, it means that the language supports typesgiven by initial algebras and ﬁnal coalgebras\nseparately. It is an interesting challenge for future work to describe the ‘coinductive’ list monad trans-\nformer, given by carriers of ﬁnal coalgebras. In such a case,the free monad becomes thefree completely\niterative monadintroduced by Aczelet al.[1], and the resumption monad becomes thecoinductive re-\nsumption monaddescribed by Pir´ og and Gibbons [26]. The universal properties of both constructions\nM. Pir´ og 37\nare similar to those of their inductive counterparts, but considerably more complicated (see Ad´ ameket\nal.[2] for the case of the free completely iterative monad).\nAnother challenge for future work is to extend the current development with control operators, such\nas Prolog’scutor fair disjunction. These features can be found, for example, in Kiselyovet al.’s imple-\nmentation [20]. We hope that such control structures can be obtained using the methods described in this\npaper.\nAcknowledgements\nI would like to thank Tom Schrijvers for his remarks on an early draft of this paper, and the anonymous\nreviewers for their detailed comments and helpful suggestions.\nReferences\n[1] Peter Aczel, Jiˇ r´ ı Ad´ amek, Stefan Milius & Jiˇ r´ ı Velebil (2003):Inﬁnite trees and completely itera-\ntive theories: a coalgebraic view.\nTheoretical Computer Science300(1-3), p. 145, doi:10.1016/\nS0304-3975(02)00728-4.\n[2] Jiˇ r´ ı Ad´ amek, Stefan Milius & Jiˇ r´ ı Velebil (2006):Elgot Algebras. Logical Methods in Computer Science\n2(5), doi:10.2168/LMCS-2(5:4)2006.\n[3] Robert Atkey, Neil Ghani, Bart Jacobs & Patricia Johann (2012):Fibrational Induction Meets Effects. In Lars\nBirkedal, editor:Foundations of Software Science and Computational Structures,Lecture Notes in Computer\nScience7213, Springer, pp. 42–57, doi:10.1007/978-3-642-28729-9_3 .\n[4] Robert Atkey & Patricia Johann (2015):Interleaving data and effects. Journal of Functional Programming\n25, doi:10.1017/S0956796815000209.\n[5] Roland Carl Backhouse, Marcel Bijsterveld, Rik van Geldrop & Jaap van der Woude (1995):Cate-\ngorical Fixed Point Calculus. In: Category Theory and Computer Science, p. 159179, doi:10.1007/\n3-540-60164-3_25 .\n[6] Michael Barr & Charles Wells (1985):Toposes, Triples, and Theories. Grundlehren der mathematischen\nWissenschaften, Springer-Verlag, New York. Available athttp://www.tac.mta.ca/tac/reprints/\narticles/12/tr12abs.html, doi:10.1007/978-1-4899-0021-0 .\n[7] Jonathan M. Beck (1967):Triples, Algebras and Cohomology. Ph.D. thesis, Columbia University. Available\nathttp://www.tac.mta.ca/tac/reprints/articles/2/tr2abs.html.\n[8] Jonathan M. Beck (1969):Distributive laws. In B. Eckmann, editor:Seminar on Triples and Categorical Ho-\nmology Theory,Lecture Notes in Mathematics80, Springer Berlin Heidelberg, pp. 119–140, doi:10.1007/\nBFb0083084. Available athttp://www.tac.mta.ca/tac/reprints/articles/18/tr18abs.html.\n[9] Richard S. Bird (2006):A program to solve Sudoku (functional pearl). Journal of Functional Programming\n16(6), pp. 671–679, doi:10.1017/S0956796806006058.\n[10] Andrzej Filinski & Kristian Støvring (2007):Inductive Reasoning About Effectful Data Types. SIGPLAN\nNot.42(9), pp. 97–110, doi:10.1145/1291220.1291168.\n[11] Marcelo Fiore (2013):An equational metalogic for monadic equational systems. Theory and Applica-\ntions of Categories27(18), pp. 465–492. Available athttp://www.tac.mta.ca/tac/volumes/27/18/\n27-18abs.html.\n[12] Marcelo P. Fiore, Gordon D. Plotkin & Daniele Turi (1999):Abstract syntax and variable binding. In:14th\nAnnual IEEE Symposium on Logic in Computer Science, Trento,Italy, July 2-5, 1999, IEEE Computer\nSociety, pp. 193–202, doi:10.1109/LICS.1999.782615.\n38 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n[13] Ralf Hinze (2000):Deriving backtracking monad transformers (functional pearl). In Martin Odersky &\nPhilip Wadler, editors:Proceedings of the Fifth ACM SIGPLAN International Conference on Functional\nProgramming (ICFP ’00), Montreal, Canada, September 18-21, 2000., ACM, pp. 186–197, doi:10.1145/\n351240.351258.\n[14] Ralf Hinze (2012):Kan extensions for program optimisation or: Art and Dan explain an old trick. In Jeremy\nGibbons & Pablo Nogueira, editors:Mathematics of Program Construction - 11th International Confer-\nence, MPC 2012, Madrid, Spain, June 25-27, 2012. Proceedings,Lecture Notes in Computer Science7342,\nSpringer, pp. 324–362, doi:10.1007/978-3-642-31113-0_16 .\n[15] John Hughes (1995):The design of a pretty-printing Library. In Johan Jeuring & Erik Meijer, editors:\nAdvanced Functional Programming, First International Spring School on Advanced Functional Programming\nTechniques, B˚ astad, Sweden, May 24-30, 1995, Tutorial Text, Lecture Notes in Computer Science925,\nSpringer, pp. 53–96, doi:10.1007/3-540-59451-5_3 .\n[16] Martin Hyland, Gordon D. Plotkin & John Power (2006):Combining effects: Sum and tensor. Theoretical\nComputer Science357(1-3), p. 7099, doi:10.1016/j.tcs.2006.03.013.\n[17] Martin Hyland & John Power (2006):Discrete Lawvere theories and computational effects. Theoretical\nComputer Science366(1-2), pp. 144–162, doi:10.1016/j.tcs.2006.07.007.\n[18] Mauro Jaskelioff & Eugenio Moggi (2010):Monad transformers as monoid transformers.Theoretical Com-\nputer Science411(5152), p. 44414466, doi:10.1016/j.tcs.2010.09.011.\n[19] Gregory M. Kelly (1980):A uniﬁed treatment of transﬁnite constructions for free algebras, free monoids,\ncolimits, associated sheaves, and so on. Bulletin of the Australian Mathematical Society22, pp. 1–83,\ndoi:10.1017/S0004972700006353.\n[20] Oleg Kiselyov, Chung-chieh Shan, Daniel P. Friedman & Amr Sabry (2005):Backtracking, Interleaving,\nand Terminating Monad Transformers: (Functional Pearl). SIGPLAN Notices 40(9), pp. 192–203, doi:10.\n1145/1090189.1086390.\n[21] Anders Kock (1971):Closed categories generated by commutative monads.Journal of the Australian Math-\nematical Society12, pp. 405–424, doi:10.1017/S1446788700010272.\n[22] Tom Leinster (2013):Codensity and the ultraﬁlter monad. Theory and Applications of Categories28(13),\npp. 332–370. Available athttp://www.tac.mta.ca/tac/volumes/28/13/28-13abs.html.\n[23] Saunders Mac Lane (1998):Categories for the Working Mathematician. Graduate Texts in Mathematics,\nSpringer, doi:10.1007/978-1-4757-4721-8 .\n[24] Eugenio Moggi (1989):An Abstract View of Programming Languages. Technical Report, Edinburgh Univer-\nsity. Available athttp://www.lfcs.inf.ed.ac.uk/reports/90/ECS-LFCS-90 -113/.\n[25] Philip Mulry (2013):Notions of Monad Strength. In Anindya Banerjee, Olivier Danvy, Kyung-Goo Doh &\nJohn Hatcliff, editors:Semantics, Abstract Interpretation, and Reasoning about Programs: Essays Dedicated\nto David A. Schmidt on the Occasion of his Sixtieth Birthday,Manhattan, Kansas, USA, 19-20th September\n2013,Electronic Proceedings in Theoretical Computer Science129, Open Publishing Association, pp. 67–83,\ndoi:10.4204/EPTCS.129.6.\n[26] Maciej Pir´ og & Jeremy Gibbons (2014):The Coinductive Resumption Monad.Electronic Notes in Theoreti-\ncal Computer Science308, pp. 273–288, doi:10.1016/j.entcs.2014.10.015. Mathematical Foundations\nof Programming Semantics (MFPS XXX).\n[27] Gordon D. Plotkin & John Power (2003):Algebraic Operations and Generic Effects. Applied Categorical\nStructures11(1), pp. 69–94, doi:10.1023/A:1023064908962.\n[28] Exequiel Rivas & Mauro Jaskelioff (2014):Notions of Computation as Monoids. Available athttp://\narxiv.org/abs/1406.4823. Submitted to the Journal of Functional Programming.\n[29] Exequiel Rivas, Mauro Jaskelioff & Tom Schrijvers (2015):From monoids to near-semirings: the essence\nof MonadPlus and alternative. In Moreno Falaschi & Elvira Albert, editors:Proceedings of the 17th Inter-\nnational Symposium on Principles and Practice of Declarative Programming, Siena, Italy, July 14-16, 2015,\nACM, pp. 196–207, doi:10.1145/2790449.2790514.\nM. Pir´ og 39\n[30] Philip Wadler (1985):How to replace failure by a list of Successes: A method for exception handling,\nbacktracking, and pattern matching in lazy functional languages. In Jean-Pierre Jouannaud, editor:Func-\ntional Programming Languages and Computer Architecture, FPCA 1985, Nancy, France, September 16-\n19, 1985, Proceedings, Lecture Notes in Computer Science201, Springer, pp. 113–128, doi:10.1007/\n3-540-15975-4_33 .\n[31] Mitchell Wand & Dale Vaillancourt (2004):Relating Models of Backtracking.SIGPLAN Notices 39(9), pp.\n54–65, doi:10.1145/1016848.1016861.\n[32] Harvey Wolff (1973):Monads and monoids on symmetric monoidal closed categories. Archiv der Mathe-\nmatik24(1), pp. 113–120, doi:10.1007/BF01228184.\nA Proofs\nA.1 Lemma 9\nThe conditions (1) and (2) from Deﬁnition 6 are trivial. For (3), we need to show that the following\ndiagram commutes:\nG ∗A ⊗ A\nG ∗(A ⊗ A)\nA ⊗ A\nG ∗A A\n/llbracketg/rrbracket⊗ id\n˜τ\nG ∗m /llbracketg/rrbracket\nm\nWe show that both paths satisfy the universal property of strongly generated free monads, so they are\nequal. The top-right path:\nG ∗A ⊗ A A ⊗ A A\nGG ∗A ⊗ A G (G ∗A ⊗ A) G (A ⊗ A) GA\nGA ⊗ A\nA ⊗ A\n/llbracketg/rrbracket⊗ id m\ncons ⊗ id\nτ G (/llbracketg/rrbracket⊗ id) Gm\ng\ng ⊗ id\nF /llbracketg/rrbracket⊗ id τ\nη ⊗ id id\n➀\n➁\n➂\n➃\n➀ /llbracketg/rrbracketis an algebra morphism,➁ naturality ofτ,➂ ⟨A,g,m ,u⟩ is aG -monoid,➃ universal property\nof/llbracket–/rrbracket.\nThe left-bottom path:\nG ∗A ⊗ A G ∗(A ⊗ A) G ∗A A\nGG ∗A ⊗ A G (G ∗A ⊗ A) GG ∗(A ⊗ A) GG ∗A GA\nA ⊗ A A\n˜τ G ∗m /llbracketg/rrbracket\ncons\nτ G ˜τ GG ∗m G /llbracketg/rrbracket\ngconscons\nη ⊗ id η\nm\nη id\n➀ ➁ ➂\n➃ ➄ ➅\n40 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n➀ deﬁnition of strongly generated free monad,➁ naturality ofcons,➂ /llbracket–/rrbracketis a morphism of algebras,➃\nproperties of strength,➄ naturality ofη ,➅ universal property of/llbracket–/rrbracket.\nA.2 Theorem 11\nWe split the proof into a number of lemmata. We need to show thatF is a functor (Lemma 23), that⌊–⌋\nis natural (Lemma 24), that⌈–⌉ produces morphisms between Eilenberg–Moore monoids (Lemma 26),\nand that⌊–⌋ is an inverse of⌈–⌉ (Lemma 27).\nLemma 23. The assignment F is a functor.\nProof.First, we check thatFA is an Eilenberg–Moore monoid, that is, that the three conditions from\nDeﬁnition 6 hold. The ﬁrst two are obvious. For the third one,consider the following diagram, which is\nthe desired coherence diagram with the deﬁnitions ofm and u unfolded:\nMM (A⋉M )∗I⊗ M (A⋉M )∗I M (A⋉M )∗I⊗ M (A⋉M )∗I\nM (M (A⋉M )∗I⊗ M (A⋉M )∗I)\nMM ((A⋉M )∗I⊗ M (A⋉M )∗I)\nMM (A⋉M )∗(I⊗ M (A⋉M )∗I)\nMM (A⋉M )∗M (A⋉M )∗I\nM ((A⋉M )∗I⊗ M (A⋉M )∗I)\nM (A⋉M )∗(I⊗ M (A⋉M )∗I)\nM (A⋉M )∗M (A⋉M )∗I\nM (A⋉M )∗IMM (A⋉M )∗I\nµ M ⊗ id\nτM\nM τM\nMM ˜τM\n∼\n=\nτM\nM ˜τM\n∼\n=\nµ RM µ R\nµ M\nµ M\nµ M\n➀\n➁\n➂\n➀ properties of strength,➁ naturality of\nµ M ,➂ µ R is deﬁned via a distributive law.\nTo verify the morphism part, letf :A → B be a morphism inC . It is trivial thatF fis a morphism\nbetween Eilenberg–Moore algebra parts ofFA and FB , as it amounts to the naturality ofµ M . As for the\nmonoid parts, the preservation of the unit is simply the factthatM ( f⋉M )∗I is a monad morphism. For\nM. Pir´ og 41\nthe preservation of the multiplication, consider the following diagram:\nM (A⋉M )∗I⊗ M (A⋉M )∗I\nM ((A⋉M )∗I⊗ M (A⋉M )∗I)\nM (A⋉M )∗(I⊗ M (A⋉M )∗I)\nM (A⋉M )∗M (A⋉M )∗I\nM (A⋉M )∗I\nM (A⋉M )∗I⊗ M (A⋉M )∗I\nM ((B⋉M )∗I⊗ M (B⋉M )∗I)\nM (B⋉M )∗(I⊗ M (B⋉M )∗I)\nM (B⋉M )∗M (B⋉M )∗I\nM (B⋉M )∗I\nτM\nM ˜τM\n∼\n=\nµ R\nτM\nM ˜τM\n∼\n=\nµ R\nM ( f⋉M )∗I⊗ M ( f⋉M )∗I\nM (( f⋉M )∗I⊗ M ( f⋉M )∗I)\nM ( f⋉M )∗(id ⊗ M ( f⋉M )∗)\nM ( f⋉M )∗M ( f⋉M )∗\nM ( f⋉M )∗\n➀\n➁\n➂\n➃\n➀ naturality of\nτ,➁ the fact that( f⋉M )∗ preserves strength, and naturality o˜τ,➂ naturality of∼\n=,➃\nmonad morphism.\nLemma 24. The assignment⌊–⌋ is a natural transformation.\nProof.Let f:FA → ⟨B,b,m B ,uB ⟩and l:⟨B,b,m B ,uB ⟩ → ⟨Y,y,m Y ,uY ⟩be morphisms inEMMon M , and\nr :X → A be a morphism inC . The following diagram commutes, where the top-most path isequal to\n⌊l· f· Fr⌋, while the bottom-most path is equal toUl · ⌊ f⌋ · r:\nX\nA\nX ⊗ I\nA ⊗ I\nM (X ⋉M )∗I\nM (A⋉M )∗I B Y\nr\n∼\n=\n∼\n=\nINF\nINF\nM (r⋉M )∗I\nf lr⊗ id\n➀ ➁\n➀ naturality of∼\n=,➁ deﬁnition ofINF.\nLemma 25. Given an Eilenberg–Moore M-monoid⟨B,b,m B ,uB ⟩and aC -morphism g:A → B, the tuple\n⟨B, A ⊗ MB\ng⊗b\n− − →B ⊗ B m B\n− →B, m B , uB ⟩ is an(A ⊗ M (–))-monoid for A⊗ M (–) understood as a functor\nwith strength given as(A ⊗ MX ) ⊗Y\n∼\n=− →A ⊗ (MX ⊗Y ) id⊗\nτ− − →A ⊗ M (X ⊗Y ).\n42 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nProof.Since⟨B,m B ,uB ⟩ is a monoid by deﬁnition, it is left to check the coherence diagram:\n(A ⊗ MB ) ⊗ B (B ⊗ MB ) ⊗ B (B ⊗ B) ⊗ B B ⊗ B\nA ⊗ (MB ⊗ B) B ⊗ (MB ⊗ B) B ⊗ (B ⊗ B)\nA ⊗ M (B ⊗ B) B ⊗ M (B ⊗ B)\nA ⊗ MB B ⊗ MB B ⊗ B B\n(g ⊗ id) ⊗ id (id ⊗ b) ⊗ id m B ⊗ id\ng ⊗ (id ⊗ id) id ⊗ (b ⊗ id)\n∼\n=\n∼\n=\n∼\n=\nid ⊗ τ id ⊗ τ\nid ⊗ Mm B id ⊗ Mm B\nid ⊗ m B\nm B\ng ⊗ id id ⊗ b m B\n➀ ➁\n➂\n➃ ➄\n➀ and ➁ naturality of∼\n=,➂ associativity ofm B ,➃ ⊗ is a bifunctor,➄ coherence of⟨B,b,m B ,uB ⟩.\nLemma 26. For aC -morphism g:A → U ⟨B,b,m B ,uB ⟩, the morphism⌈g⌉ is anEMMon M -morphism\nof the type FA→ ⟨B,b,m B ,uB ⟩ .\nProof.The fact that⌈g⌉ is a morphism between the Eilenberg–Moore algebra parts follows from the\nfollowing diagram, where the right-most edge is equal to⌈g⌉ unfolded as in Lemma 5(1):\nMM (A⋉M )∗I M (A⋉M )∗I\nMM (A⋉M )∗B M (A⋉M )∗B\nMMB MB\nMB B\nµ M\nµ M\nMM (A⋉M )∗uB M (A⋉M )∗uB\nµ M\nM ⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩ ⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\nb\nb\nMb\nMM /llbracketm B · (g ⊗ b)/rrbracketM /llbracketm B · (g ⊗ b)/rrbracket\n➀\n➁\n➂ ➃\n➄\n➀ and ➁ naturality of\nµ M ,➂ and ➃ Lemma 5(2),➄ b has the Eilenberg–Moore property.\nThe fact that⌈g⌉ commutes with monoid multiplication follows from the following diagram, in which\nM. Pir´ og 43\nthe left-most edge is the deﬁnition ofm (that is, the multiplication ofFA ):\nM (A⋉M )∗I⊗ M (A⋉M )∗I M (A⋉M )∗I⊗ B B ⊗ B\nM ((A⋉M )∗I⊗ M (A⋉M )∗I) M ((A⋉M )∗I⊗ B)\nM (A⋉M )∗(I⊗ M (A⋉M )∗I) M (A⋉M )∗(I⊗ B)\nM (A⋉M )∗M (A⋉M )∗I M (A⋉M )∗B\nM (A⋉M )∗I B\nid ⊗ ⌈g⌉ ⌈g⌉ ⊗ id\nM (id ⊗ ⌈g⌉)\nM (A⋉M )∗(id ⊗ ⌈g⌉)\nτ τ\nM ˜τ M ˜τ\n∼\n=\n⌈g⌉\nµ R\nM (A⋉M )∗⌈g⌉\n∼\n=\nm B\n⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\n➀\n➁\n➂\n➃\n➄\n(3)\n➀ naturality of\nτ,➁ naturality of˜τ,➂ naturality of∼\n=,➃ see below,➄ see below.\nTo verify that the square➃ above commutes, we unfold⌈g⌉ as in Lemma 5(1). The desired diagram\nis then as follows:\nM (A⋉M )∗M (A⋉M )∗I M (A⋉M )∗M (A⋉M )∗B M (A⋉M )∗B\nM (A⋉M )∗I M (A⋉M )∗B B\nM (A⋉M )∗M (A⋉M )∗uB M (A⋉M )∗⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\nM (A⋉M )∗uB ⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\nµ R µ R ⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩➀ ➁\n➀ naturality ofµ R ,➁ ⟨ ⟨–,–,id⟩ ⟩has the Eilenberg–Moore property (Lemma 5(2)).\nBelow, we detail➄ from the diagram (3):\nM (A⋉M )∗I⊗ B M (A⋉M )∗B ⊗ B\nM ((A⋉M )∗I⊗ B) M ((A⋉M )∗B ⊗ B)\nM (A⋉M )∗(I⊗ B) M (A⋉M )∗(B ⊗ B)\nM (A⋉M )∗B\nB ⊗ B\nMB ⊗ B\nM (B ⊗ B)\nMB\nB\nM (A⋉M )∗uB ⊗ id\nM ((A⋉M )∗uB ⊗ id)\nM (A⋉M )∗(uB ⊗ id)\nτ τ\nM ˜τ M ˜τ\n∼\n=\nM (A⋉M )∗m B\n⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩ ⊗id\nM /llbracketm B · (g ⊗ b)/rrbracket⊗ id\nb ⊗ id\nτ\nMm B\nb\nm B\n⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\nM (/llbracketm B · (g ⊗ b)/rrbracket⊗ id)\nM /llbracketm B · (g ⊗ b)/rrbracket\n➀ ➁\n➂\n➃\n➄ ➅\n➆\n➇\n44 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n➀ and ➁ naturality ofτ,➂ Lemma 5(2),➃ coherence for⟨B,b,m B ,uB ⟩,➄ naturality of˜τ,➅ M -image\nof the coherence diagram for the Eilenberg–Moore(A⋉M )∗-monoid generated as in Lemma 9 by the\n(A⋉M )-monoid ⟨B, m B · (g ⊗ b), m B , uB ⟩ described in Lemma 25,➆ monoid,➇ Lemma 5(2).\nIt is left to show that⌈g⌉ preserves units of the monoid parts of the respective Eilenberg–Moore\nmonoids. The following diagram commutes, where the right-most edge is equal to⌈g⌉ via Lemma 5(1):\nB M (A⋉M )∗B\nB\nI M (A⋉M )∗I\nη R\nid ⟨ ⟨b, m B · (g ⊗ id), id⟩ ⟩\nu = η R\nuB M (A⋉M )∗uB➀\n➁\n➀ naturality ofη R ,➁ ⟨ ⟨–,–,id⟩ ⟩has the Eilenberg–Moore property (Lemma 5(2)).\nLemma 27. The natural transformation⌊–⌋ is a natural isomorphism with the inverse given by⌈–⌉.\nProof.In one direction, letg :A → U ⟨B,b,m B ,uB ⟩ be aC -morphism. The fact that⌊⌈g⌉⌋ = g follows\nfrom the following diagram, where the longer path of the perimeter is obtained by unfolding the deﬁni-\ntions of⌊–⌋ and ⌈–⌉:\nA B\nB B ⊗ I B ⊗ B\nA ⊗ B\nA ⊗ I M (A⋉M )∗I\ng\n∼\n=\nINF\n⟨ ⟨b, m B · (g ⊗ id), uB ⟩ ⟩\ng\n∼\n=\nid ⊗ uB\nm B\ng ⊗ id\nid ⊗ uB\ng ⊗ id\n➀\n➁\n➂ ➃\n➀ right unit law for monoids,➁ naturality of∼\n=,➂ ⊗ is a bifunctor,➃ cancellation property of⟨ ⟨–⟩ ⟩\n(Lemma 5(3)).\nIn the other direction, we need to show that⌈⌊ f⌋⌉ = f for f :FA → ⟨B,b,m B ,uB ⟩. Unfolding the\ndeﬁnition of⌈–⌉, we obtain:\n⌈⌊ f⌋⌉ = ⟨ ⟨MB b− →B, A ⊗ B\n⌊ f⌋⊗id\n− − − − →B ⊗ B m B\n− →B, I uB\n− →B⟩ ⟩\nTo prove that it is equal tof, it is enough to show that the universal property of⟨ ⟨–⟩ ⟩(given in Lemma 4)\nholds forf.\nThe left-hand side of the ﬁrst diagram in Lemma 4 commutes, since morphisms inEMMon M are\nnecessarily morphisms between Eilenberg–Moore algebra parts. The right-hand side of the diagram (that\nis, the fact thatf is a morphisms between(A ⊗(–))-algebras) is given by the following diagram, in which\nM. Pir´ og 45\nwe unfold the deﬁnition of⌊ f⌋ inm B · (⌊ f⌋ ⊗ id) (the bottom edge):\nA ⊗ M (A⋉M )∗I M (A⋉M )∗I\n(A ⊗ I) ⊗ M (A⋉M )∗I M (A⋉M )∗I⊗ M (A⋉M )∗I\nA ⊗ B (A ⊗ I) ⊗ B M (A⋉M )∗I⊗ B B ⊗ B B\n∼\n= ⊗ id\nINF ⊗ id f⊗ id m B\nfid ⊗ f\nµ R · INF\n∼\n= ⊗ id INF ⊗ id\nf⊗ f\nm➀\n➁ ➂\n➀ see below,➁ ⊗ is a bifunctor,➂ f is a monoid morphism (as a morphism inEMMon M ).\nBelow, we detail➀ from the diagram above. We unfold the deﬁnitions ofINF and m.\nA ⊗ M (A⋉M )∗I A ⊗ MM (A⋉M )∗I (A⋉M )∗M (A⋉M )∗I M (A⋉M )∗M (A⋉M )∗I\nM (A⋉M )∗I\n(A ⊗ I) ⊗ M (A⋉M )∗I\n(A ⊗ MI ) ⊗ M (A⋉M )∗I\n(A⋉M )∗I⊗ M (A⋉M )∗I\nM (A⋉M )∗I⊗ M (A⋉M )∗I M ((A⋉M )∗I⊗ M (A⋉M )∗I)\nM (A⋉M )∗(I⊗ M (A⋉M )∗I)\nA ⊗ (I⊗ M (A⋉M )∗I)\nA ⊗ (MI ⊗ M (A⋉M )∗I)\nA ⊗ M (I⊗ M (A⋉M )∗I)\n(A⋉M )∗(I⊗ M (A⋉M )∗I)\nµ R\nid ⊗ η M emb η M\n∼\n= ⊗ id\n(id ⊗ η M ) ⊗ id\nemb ⊗ id\nη M ⊗ id\n∼\n=\nM ˜τ\nτ\nη M\nid ⊗ (η M ⊗ id)\nid ⊗ τ\nemb\nid ⊗ ∼\n=∼\n=\n∼\n=\n˜τ η M\nid ⊗ η M\n∼\n=\n➀\n➁\n➂\n➃\n➄\n➅\n➆ ➇\n➀ monoidal category,➁ naturality of∼\n=,➂ the fact that(A⋉M )∗ is strongly generated and the deﬁnition\nof strength ofA⋉M , ➃ properties of strength,➄ naturality of\nη M and emb, ➅ naturality ofη M , ➆\nproperties of strength,➇ naturality ofη M .\nIt is left to show that the following diagram commutes:\nI M (A⋉M )∗I\nB\nη R\nuB f\nIt commutes, sinceη R = u, andf is a morphism between the monoid parts ofFA and ⟨B,b,m B ,uB ⟩.\n46 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nA.3 Theorem 13\nWe use the strict version of Beck’s monadicity theorem [7] (see Mac Lane [23, Sec. VI.7]). Leth0,h1 :\n⟨A,a,m A ,uA ⟩ → ⟨B,b,m B ,uB ⟩ be a pair of morphisms between Eilenberg–Moore monoids. Assume that\ng :B → C is a split coequaliser ofUh 0 and Uh 1, that is, the following diagram commutes, and the top\nand bottom paths are both equal toid:\nB A B\nC B C\nt h0\ns\ng h1\ng\ng\nBy Beck’s theorem, it is enough to show that there exists a unique Eilenberg–Moore monoid⟨C ,c,m C ,uC ⟩\nsuch thatg is a morphism of Eilenberg–Moore monoids⟨B,b,m B ,uB ⟩ → ⟨C ,c,m C ,uC ⟩ and a coequaliser\nofh0 and h1.\nWe notice thath0 and h1 are also morphisms of Eilenberg–Moore algebras⟨A,a⟩ → ⟨B,b⟩. Hence, by\nthe fact that the Eilenberg–Moore adjunction is monadic, there exists a unique Eilenberg–Moore algebra\n⟨C ,c⟩ such thatg :⟨B,b⟩ → ⟨C ,c⟩ is a unique coequaliser ofh0 and h1 understood as morphisms between\nEilenberg–Moore algebras. In detail, the algebra⟨C ,c⟩ is equal to:\n⟨C , MC Ms− →MB b− →B\ng\n− →C ⟩\nSimilarly,h0 and h1 are morphism between monoids⟨A,m A ,uA ⟩ and ⟨B,m B ,uB ⟩. Since the adjunction\nbetweenC and the category of monoids is monadic, there exists a uniquemonoid ⟨C ,m C ,uC ⟩ such that\ng :⟨B,m B ,uB ⟩ → ⟨C ,m C ,uC ⟩ is a unique coequaliser ofh0 and h1 understood as morphism between\nmonoids. In detail, the monoid⟨C ,m C ,uC ⟩ is given as:\n⟨C , C ⊗C s⊗s− − →B ⊗ B m B\n− →B\ng\n− →C , I uB\n− →B\ng\n− →C ⟩\nTo check that⟨C ,c,m C ,uC ⟩ is an Eilenberg–Moore monoid, we need to verify the coherence condi-\ntion:\nMC ⊗C MB ⊗C B ⊗C C ⊗C\nM (C ⊗C ) M (B ⊗C ) MB ⊗ B B ⊗ B B ⊗ B\nM (B ⊗ B) B B\nMB MC MB B C\nMs ⊗ id b ⊗ id g ⊗ id\nM (s⊗ id) b ⊗ id\ng ⊗ g s⊗ sid ⊗ sid ⊗ sτ τ\nM (s⊗ s)\nM (id ⊗ s)\nτ m B\nMm B\nm B\ng\nMg Ms b g\nb g\n➀\n➁\n➂ ➃\n➄ ➅ ➆\n➇\n➀ and ➁ naturality ofτ,➂ ⊗ is a bifunctor,➃ g·s= id, sinceg is a split coequaliser,➄ ⊗ is a bifunctor,\n➅ ⟨B,b,m B ,uB ⟩is an Eilenberg–Moore monoid,➆ g is a morphism between monoids,➇ g is a morphism\nbetween Eilenberg–Moore algebras.\nMorphisms in EMMon M need to be exactly morphisms between Eilenberg–Moore algebras and\nmonoids. Thus,g is a morphism⟨B,b,m B ,uB ⟩ → ⟨C ,c,m C ,uC ⟩ and a coequaliser ofh0 and h1.\nM. Pir´ og 47\nA.4 Theorem 15\nThe triple⟨MA ⇒ MA , comp, ident⟩ is a monoid, since it is a special case of the general construction\n⟨A ⇒ A, comp, ident⟩; see, for example, Rivaset al.[29]. We need to verify thatp has the Eilenberg–\nMoore property.2 First, we need to show that⌊p⌋⊗ ·\nη = id. Using the naturality of⌊–⌋⊗, it is enough\nto show that⌊p · (η ⊗ id)⌋⊗ = id. Consider the following diagram, where the left-bottom path is equal to\np · (η ⊗ id):\n(MA ⇒ MA ) ⊗ MA\nM (MA ⇒ MA ) ⊗ MA M ((MA ⇒ MA ) ⊗ MA ) MMA MA\nη ⊗ id\nτ M app µ\nη\napp\n➀\n➁\n➀ properties of strength,➁ naturality ofη and monad laws.\nThus, we obtain⌊p · (η ⊗ id)⌋⊗ = ⌊app⌋⊗ = id, sinceapp is the counit of the adjunction. To see that\n⌊p⌋⊗ has the Eilenberg–Moore property, we also need to verify that⌊p⌋⊗ · M ⌊p⌋⊗ = ⌊p⌋⊗ · µ . Using\nthe naturality of⌊–⌋⊗, it is enough to verify that⌊p · (M ⌊p⌋⊗ ⊗ id)⌋⊗ = ⌊p · (µ ⊗ id)⌋⊗. Therefore, it is\nenough to show thatp · (M ⌊p⌋⊗ ⊗ id) =p · (µ ⊗ id). It is detailed in the following diagram:\nMM (MA ⇒ MA ) ⊗ MA M (MA ⇒ MA ) ⊗ MA\nM (M (MA ⇒ MA ) ⊗ MA )\nMM ((MA ⇒ MA ) ⊗ MA )\nMMMA\nM ((MA ⇒ MA ) ⊗ MA )\nMMA\nMAMMAM ((MA ⇒ MA ) ⊗ MA )\nM (MA ⇒ MA ) ⊗ MA\nµ ⊗ id\nτ\nM τ\nMM app\nτ\nµ\nM app\nµ\nµ\nµ\nM µ\nMp\nM ⌊p⌋⊗ ⊗ id\nτ\nM app\nM (⌊p⌋⊗ ⊗ id)\n➀ ➁\n➂ ➃\n➄\n➅\n➀ naturality of\nτ,➁ properties of strength,➂ app is the counit of the adjunction,➃ deﬁnition ofp,➄\nnaturality ofµ ,➅ monad laws.\nIt is left to check that the coherence diagram commutes, which in this case instantiates as follows:\nM (MA ⇒ MA ) ⊗ (MA ⇒ MA )\nM ((MA ⇒ MA ) ⊗ (MA ⇒ MA ))\n(MA ⇒ MA ) ⊗ (MA ⇒ MA )\nM (MA ⇒ MA ) MA ⇒ MA\n⌊µ · M app · τ⌋⊗ ⊗ id\nτ\nM comp ⌊µ · M app · τ⌋⊗\ncomp\n2Note that⟨MA ⇒ MA ,⌊p⌋⊗⟩ is deﬁned as in Kock’s [21] construction of a closed monoidalstructure on the Eilenberg–\nMoore category of a commutative monad. Kock’s proof that⟨MA ⇒ MA ,⌊p⌋⊗⟩ is an Eilenberg–Moore algebra can be applied\nif we additionally assume thatC is symmetric.\n48 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nSince⌈–⌉⊗ is an isomorphism, it is enough to show that the⌈–⌉⊗-images of both paths in the diagram\nare equal. The top-right path:\n⌈comp · (⌊\nµ · M app · τ⌋⊗ ⊗ id)⌉⊗ = ⌈comp⌉⊗ · ((⌊µ · M app · τ⌋⊗ ⊗ id) ⊗ id) naturality of⌈–⌉⊗\n= ⌈⌊k⌋⊗⌉⊗ · ((⌊µ · M app · τ⌋⊗ ⊗ id) ⊗ id) deﬁnition ofcomp\n= k· ((⌊µ · M app · τ⌋⊗ ⊗ id) ⊗ id) isomorphism\n(∗) =k· ((((id ⇒ µ ) · (id ⇒ M app) · ⌊τ⌋⊗) ⊗ id) ⊗ id) naturality of⌊–⌋⊗\nThe left-bottom path:\n⌈⌊µ · M app · τ⌋⊗ · M app · τ⌉⊗ = ⌈⌊µ · M app · τ⌋⊗⌉⊗ · (M app ⊗ id) · (τ ⊗ id) naturality of⌈–⌉⊗\n(∗∗) =µ · M app · τ · (M app ⊗ id) · (τ ⊗ id) isomorphism\nTo show that(∗) is equal to(∗∗), we split the desired diagram into two. First, consider the following\ndiagram, where the left-bottom path is equal to(∗). For brevity, we denote the objectMA ⇒ MA asE .\n(ME ⊗ E ) ⊗ MA\n((MA ⇒ M (E ⊗ MA )) ⊗ E ) ⊗ MA\n((MA ⇒ MMA ) ⊗ E ) ⊗ MA\n(E ⊗ E ) ⊗ MA\nE ⊗ (E ⊗ MA ) E ⊗ MA MA\nME ⊗ (E ⊗ MA )\n(MA ⇒ M (E ⊗ MA )) ⊗ (E ⊗ MA )\n(MA ⇒ M (E ⊗ MA )) ⊗ MA\n(MA ⇒ MMA ) ⊗ MA\nE ⊗ MA\nME ⊗ MA\n(MA ⇒ M (E ⊗ MA )) ⊗ MA\nMMA\nM (E ⊗ MA )\n(⌊τ⌋⊗ ⊗ id) ⊗ id\n((id ⇒ M app) ⊗ id) ⊗ id\n((id ⇒ µ ) ⊗ id) ⊗ id\n∼\n= id ⊗ app app\n⌊τ⌋⊗ ⊗ id\n(id ⇒ M app) ⊗ id\n(id ⇒ µ ) ⊗ id\n∼\n=\n∼\n= comp ⊗ id\ncomp ⊗ id\ncomp ⊗ id\napp\n⌊τ⌋⊗ ⊗ id\nid ⊗ app\nid ⊗ app\nµ\nM app\napp\napp\nτ\n➀ ➁\n➂ ➃\n➄\n➅ ➆\n➇\n➀ naturality of∼\n=,➁ ⊗ is a bifunctor,➂ and ➃ app is the counit of the adjunction,➄ and ➅ naturality\nofcomp,➆ naturality ofapp,➇ app is the counit of the adjunction.\nNow, consider the following diagram, where the left-most path is equal to the top-right path of the\nM. Pir´ og 49\ndiagram above, while the path around the perimeter is equal to (∗∗):\n(ME ⊗ E ) ⊗ MA\nME ⊗ (E ⊗ MA )\nME ⊗ MA\nM (E ⊗ MA )\nMMA\nMA\nM (E ⊗ (E ⊗ MA )) M ((E ⊗ E ) ⊗ MA )\nM (E ⊗ E ) ⊗ MA\nME ⊗ MA\nM (E ⊗ MA )\n∼\n=\nid ⊗ app\nτ\nM app\nµ\nτ\nM (id ⊗ app)\nM ∼\n=\nM comp ⊗ id\nτ\nτ ⊗ id\nM app\nτ\nM (comp ⊗ id)\n➀\n➁ ➂\n➃\n➀ properties of strength,➁ and ➂ naturality of strength,➃ app is the counit of the adjunction.\nA.5 Theorem 16\nThe fact that⌊m ⌋⊗ is a morphism between monoids follows from the constructionof Cayley represen-\ntation of monoids in monoidal categories [28, 29]. The retractionr :(MA ⇒ MA ) → MA is deﬁned as\nfollows:\nr =\n(\n(MA ⇒ MA )\n∼\n=− →(MA ⇒ MA ) ⊗ I id⊗u− − →(MA ⇒ MA ) ⊗ MA\napp\n− − →MA\n)\nTo check that⌊m ⌋⊗ is a morphism between Eilenberg–Moore parts, we want the following diagram\nto commute:\nMMA M (MA ⇒ MA )\nMA MA ⇒ MA\nM ⌊m ⌋⊗\n⌊m ⌋⊗\nµ ⌊p⌋⊗\nUsing the naturality of⌊–⌋⊗, it is enough to show that⌊p · (M ⌊m ⌋⊗ ⊗ id)⌋⊗ = ⌊m · (µ ⊗ id)⌋⊗. Thus,\nit is enough to show thatp · (M ⌊m ⌋⊗ ⊗ id) =m · (µ ⊗ id). It is detailed in the following diagram, where\n50 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nthe right-most edge is equal top:\nMMA ⊗ MA M (MA ⇒ MA ) ⊗ MA\nMA ⊗ MA\nM ((MA ⇒ MA ) ⊗ MA )\nMMA\nMA\nM (MA ⊗ MA )\nM ⌊m ⌋⊗ ⊗ id\nm\nµ ⊗ id\nτ\nM app\nµ\nτ\nM (⌊m ⌋⊗ ⊗ id)\nMm\n➀\n➁\n➂\n➀ naturality ofτ,➁ app is the counit of the adjunction,➂ coherence for⟨MA ,µ ,m ,u⟩.\nTo verify that⌊m ⌋⊗ preserves the unit, we want the following diagram:\nI MA\nMA ⇒ MA\nu\nident\n⌊m ⌋⊗\nUsing the naturality of⌊–⌋⊗, it is enough to show that⌊m · (u ⊗ id)⌋⊗ = ident. Thus, it is enough to show\nthatm · (u ⊗ id) =⌈ident⌉⊗ = (I⊗ MA\n∼\n=− →MA ). This follows from the fact that⟨MA ,m ,u⟩ is a monoid.\nA.6 Theorem 18\nExcept for the assumption thatM is commutative, the only difference between the deﬁnition of symmetric\nEilenberg–Moore monoids and the deﬁnition of regular Eilenberg–Moore monoids is in the coherence\nconditions. Thus, given a symmetric Eilenberg–Moore monoid ⟨A,a,m ,u⟩, it is enough to show that it\nsatisﬁes the coherence condition for Eilenberg–Moore monoids:\nMA ⊗ A\nM (A ⊗ A)\nMA ⊗ MA\nM (MA ⊗ A)\nMM (A ⊗ A)\nM (A ⊗ MA )\nMM (A ⊗ A)\nM (A ⊗ A)\nMA\nMA\nA\nA ⊗ A\nτ\nid ⊗ η\nτ′\nM τ\nη\nη τ\nM τ′\nµ\nµ Mm\nMm a\nm\na ⊗ id\naid\na ⊗ a\n➀\n➁\n➂\n➃ ➄\n➅\n➆\nM. Pir´ og 51\n➀ naturality ofη ,➁ properties of strength,➂ a has the Eilenberg–Moore property,➃ M is commutative,\n➄ coherence for symmetric Eilenberg–Moore monoids,➅ monad laws,➆ identity.\nA.7 Theorem 21\nThe fact that⌊q⌋⊗ has the Eilenberg–Moore property follows from exactly the same reasoning as for\n⌊p⌋⊗ in the proof of Theorem 15.\nIt is left to verify the coherence condition. It is shown by the following diagram (and subsequent two\ndiagrams, each detailing a part of the previous one), whereE stands forA ⇒ MA :\n(ME ⊗ ME ) ⊗ A (E ⊗ E ) ⊗ A\nE ⊗ (E ⊗ A)\nE ⊗ MA\nM (E ⊗ A)\nMMA\nMA\nME ⊗ (ME ⊗ A)\nME ⊗ M (E ⊗ A)\nME ⊗ MMA\nM (E ⊗ ME ) ⊗ A\nMM (E ⊗ E ) ⊗ A\nMME ⊗ A\nME ⊗ A M (E ⊗ A) MMA\nM (E ⊗ E ) ⊗ A\nM ((E ⊗ E ) ⊗ A) M (E ⊗ (E ⊗ A)) M (E ⊗ MA )\nMM (E ⊗ A)MMMA\n(⌊q⌋⊗ ⊗ ⌊q⌋⊗) ⊗ id\n⌊q⌋⊗ ⊗ (⌊q⌋⊗ ⊗ id)\n∼\n=\n∼\n=\nid ⊗ app\nτ′\nM app\nµ\nτ ⊗ id\nid ⊗ M app\n⌊q⌋⊗ ⊗ q\nid ⊗ τ\n⌊q⌋⊗ ⊗ µ\nM τ′ ⊗ id\nMM kcomp ⊗ id\nµ ⊗ id\nτ M app µ\nµ ⊗ id\nτ\nM (kcomp⊗ id)\nM ∼\n=\nM (id ⊗ app)\nM τ′\nM µ\nMM app\n➀\n➁\n➂\n➃\n➄\n➅\n➀ detailed below,➁ naturality of∼\n=,➂ app is the counit of the adjunction,➃ deﬁnition ofq,➄ naturality\nof\nµ and τ,➅ app is the counit of the adjunction. TUTAJ!!\n52 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n(ME ⊗ ME ) ⊗ A ME ⊗ (ME ⊗ A) ME ⊗ M (E ⊗ A) ME ⊗ MMA\nM (E ⊗ ME ) ⊗ A M ((E ⊗ ME ) ⊗ A)\nM (E ⊗ (ME ⊗ A)) M (E ⊗ M (E ⊗ A))\nM (E ⊗ MMA )\nE ⊗ MAME ⊗ MA\nM (ME ⊗ A) M (E ⊗ A)\nMMA\nMA\nM (E ⊗ MA )\nMM (E ⊗ A)\nMM (E ⊗ A)\nM (E ⊗ A)\nMMMA\nMMA\nMM (E ⊗ E ) ⊗ A\nM (E ⊗ E ) ⊗ A\nM ((E ⊗ E ) ⊗ A)\nM (E ⊗ (E ⊗ A)) M (E ⊗ MA ) MM (E ⊗ A) MMMA MMA\nM (M (E ⊗ E ) ⊗ A)\nMM ((E ⊗ E ) ⊗ A)\nMM (E ⊗ (E ⊗ A))\n∼\n=\nid ⊗ τ id ⊗ M app\nτ ⊗ id\nτ\nM ∼\n=\nτ τ\nM (id ⊗ τ)\nM (id ⊗ M app)\n⌊q⌋⊗ ⊗ µ\nid ⊗ µ\nτ′ τ′\nM app\nµ\nM (⌊q⌋⊗ ⊗ id)\nMqM (id ⊗ µ )\nτ\nM τ′\nM τ\nMM app\nM µ\nµ\nµ\nµ\nµ\nM app\nM τ′ ⊗ id\nµ ⊗ id\nτ\nM ∼\n= M (id ⊗ app) M τ′ MM app M µ µ\nτ\nM (τ′ ⊗ id)\nM τ\nµ\nMM ∼\n=\nµ\n➀ ➁ ➂\n➃ ➄\n➅\n➆\n➇\n➈\n➉\n➋ ➌\n➊\n➀ properties of strength,➁ ➂ ➃ naturality ofτ,➄ detailed below,➅ M is commutative,➆ naturality of\nτ′,➇ app is the counit of the adjunction,➈ deﬁnition ofq,➉ properties of strength,➊ and ➋ naturality\nofµ ,➌ monad laws.\nM ((E ⊗ ME ) ⊗ A) M (E ⊗ (ME ⊗ A)) M (E ⊗ M (E ⊗ A)) M (E ⊗ MMA )\nM (M (E ⊗ E ) ⊗ A)\nMM ((E ⊗ E ) ⊗ A)\nMM (E ⊗ (E ⊗ A))\nM (E ⊗ MA )\nMM (E ⊗ A)\nM (E ⊗ A)\nMMA\nMA\nM (E ⊗ (E ⊗ A))\nMM (E ⊗ MA ) MMM (E ⊗ A) MM (E ⊗ A)\nM (E ⊗ MA ) MM (E ⊗ A) MMMA MMA\nMMMMA MMMA\nM (τ′ ⊗ id)\nM ∼\n=\nM (id ⊗ τ)\nM τ′M τ\nMM ∼\n=\nM (id ⊗ M app)\nM (id ⊗ µ )\nµ\nM (id ⊗ app)\nM τ′ MM app M µ µ\nM τ′\nµ\nM app\nµ\nMM (id ⊗ app)\nM τ′\nµ\nMM τ′\nM µ\nµ\nMMM app\nµ\nµ µ\nµ µ\n➀ ➁\n➂\n➃\n➄\n➅ ➆\n➇\n➈\n➀ M is a bistrong monad,➁ naturality of\nτ′,➂ properties of strength,➃ monad laws,➄ ➅ ➆ ➇naturality\nofµ ,➈ monad laws.\nM. Pir´ og 53\nA.8 Theorem 22\nWe need to show that⌊s⌋⊗ is a morphism between Eilenberg–Moore algebras. It is enough to show that\nthe following diagram commutes:\nMMA ⊗ A\nMMA ⊗ A\nMMA ⊗ MA\nM (MA ⊗ A)\nMMA ⊗ MMA\nM (A ⇒ MA ) ⊗ A\nM ((A ⇒ MA ) ⊗ A)\nMMA\nMA\nM (MA ⊗ MA )\nM (MA ⊗ MMA )\nMA ⊗ MA\nMM (MA ⊗ MA )\nµ ⊗ id\nτ\nid ⊗ η\nid ⊗ η\nM ⌊s⌋⊗ ⊗ id\nτ\nM app\nM (⌊s⌋⊗ ⊗ id)\nτ\nM (id ⊗ η )\nMm\nM (id ⊗ η )\nτ µ\nid ⊗ η m\nµ ⊗ µ\nM τ′\nµ m\nM η\n➀\n➁\n➂\n➃\n➄\n➅\n➆\n➇\n➀ monad laws,➁ and ➂ naturality ofτ,➃ app is the counit of the adjunction, and the deﬁnition ofs\n➄ naturality ofτ,➅ properties of strength,➆ monad laws,➇ coherence for⟨MA ,µ ,m ,u⟩.\nNext, we need to⌊s⌋⊗ is a morphism between the monoid parts. It is easy to verify that it preserves\nthe unit. As for the preservation of monoid multiplication,we ﬁrst show that the following diagram\ncommutes:\nMA ⊗ MA\nMA\nM (MA ⊗ A)\nMA ⊗ MMA\nMA ⊗ MA\nM (MA ⊗ MA )\nMMA\nτ′ M (id ⊗ η )\nid ⊗ M η τ′\nid ⊗ µ\nm\nm Mm\nµ\n➀\n➁ ➂\n(4)\n➀ naturality ofτ′,➁ monad laws,➂ the ‘twisted’ coherence condition forτ′ (see Remark 19).\nNow, to see that⌊s⌋⊗ preserves the monoid multiplication, it is enough to show that the following\ndiagram commutes, in whichE stands forA ⇒ MA :\n54 Eilenberg–Moore Monoids and Backtracking Monad Transformers\n(MA ⊗ MA ) ⊗ A\nMA ⊗ A MA ⊗ MA\n(E ⊗ E ) ⊗ A\nE ⊗ (E ⊗ A)\nE ⊗ MA\nM (E ⊗ A)\nMMA\nMA\n(MA ⊗ MA ) ⊗ MA\nMA ⊗ (MA ⊗ MA )\nMA ⊗ M (MA ⊗ A)\nMA ⊗ M (MA ⊗ MA )\nM (MA ⊗ (MA ⊗ MA ))\nM (MA ⊗ MA )\nMM (MA ⊗ A)\nMM (MA ⊗ MA )\nMMMA\n(E ⊗ E ) ⊗ MA\nE ⊗ (E ⊗ MA )\nE ⊗ M (E ⊗ A)\nE ⊗ MMA\nM (E ⊗ MA )\nMM (E ⊗ A)\nM (MA ⊗ A)\nM (MA ⊗ MA )\nMMA\n(⌊s⌋⊗ ⊗ ⌊s⌋⊗) ⊗ id\nid ⊗ η\n(⌊s⌋⊗ ⊗ ⌊s⌋⊗) ⊗ id\n⌊s⌋⊗ ⊗ (⌊s⌋⊗ ⊗ id)\nid ⊗ η\n∼\n=\n∼\n=\nid ⊗ τ′\n∼\n=\nid ⊗ (id ⊗ η )\nid ⊗ η\nid ⊗ M app id ⊗ app\nid ⊗ η\nτ′\nM τ′\nη\nτ′\nµ\nM (⌊s⌋⊗ ⊗ id))\nid ⊗ τ′\n⌊s⌋⊗ ⊗ M (⌊s⌋⊗ ⊗ id)\nid ⊗ M (id ⊗ η )\n⌊s⌋⊗ ⊗ Mm\nτ′\nM (⌊s⌋⊗ ⊗ m )\nM (id ⊗ m )\nM τ′\nµ\nM (id ⊗ η )\nMM (⌊s⌋⊗ ⊗ id)\nM (⌊s⌋⊗ ⊗ id)\nMm\nM app\nµ\nm ⊗ id\nid ⊗ η m\nMM (id ⊗ η )\nMMm\nµ\nµ\nµ\nM µ\nMm\n➀\n➁\n➂ ➃\n➄ ➅\n➆ ➇\n➈ ➉\n➊\n➋\n➌\n➍\n➎ ➏\n➐\n➑\n➒\n➀ see below,➁ ⊗ is a bifunctor,➂ and ➃ naturality of∼\n=,➄ naturality of\nτ′,➅ properties of strength,\n➆ app is the counit of the adjunction,➇ naturality ofη ,➈ naturality ofτ′,➉ properties of strength,\n➊ ⊗ is a bifunctor,➋ naturality ofτ′,➌ naturality ofη , and monad laws,➍ and ➎ naturality ofµ ,\n➏ app is the counit of the adjunction,➐ naturality ofµ ,➑ monad laws,➒ diagram (4).\nM. Pir´ og 55\nBelow, we detail➀ from the diagram above.\n(MA ⊗ MA ) ⊗ A\n(MA ⊗ MA ) ⊗ MA\nMA ⊗ (MA ⊗ MA )\nMA ⊗ M (MA ⊗ A)\nMA ⊗ M (MA ⊗ MA )\nM (MA ⊗ (MA ⊗ MA )) M (MA ⊗ MA ) MMA MA\nMA ⊗ A\nMA ⊗ MA\nMA ⊗ MA\nMA ⊗ MMA\nid ⊗ η\n∼\n=\nid ⊗ τ′\nid ⊗ M (id ⊗ η )\nτ′\nM (id ⊗ m ) Mm µ\nm ⊗ id\nm ⊗ id\nid ⊗ η\nm\nid ⊗ m\nm\nid ⊗ Mm\nτ′\nid ⊗ µ\n➀\n➁\n➂\n➃\n➄\n➀ ⊗ is a bifunctor,➁ associativity of monoid multiplication,➂ (id ⊗ (–))-image of the diagram (4),\n➃ the ‘twisted’ coherence condition for\nτ′ (see Remark 19),➄ naturality ofτ′.\nIt is left to show that⌊s⌋⊗ is a split mono. The retractionr is given as follows:\nr =\n(\n(A ⇒ MA )\n∼\n=− →(A ⇒ MA ) ⊗ I id⊗u− − →(A ⇒ MA ) ⊗ MA\nτ′\n− →M ((A ⇒ MA ) ⊗ A)\nM app\n− − − →MMA\nµ\n− →MA\n)\n56 Eilenberg–Moore Monoids and Backtracking Monad Transformers\nWe verify thatr· ⌊s⌋⊗ = id:\nMA\nA ⇒ MA\n(A ⇒ MA ) ⊗ I\n(A ⇒ MA ) ⊗ MA\nM ((A ⇒ MA ) ⊗ A)\nMMA\nMA\nMA ⊗ I\nMA ⊗ MA\nM (MA ⊗ A)\nM (MA ⊗ MA ) MA ⊗ MMA\nMA ⊗ MA\n⌊s⌋⊗\n∼\n=\nid ⊗ u\nτ′\nM app\nµ\nid ⊗ u\nτ′\nM (id ⊗ η )\n∼\n=\n⌊s⌋⊗ ⊗ id\n⌊s⌋⊗ ⊗ id\nM (⌊s⌋⊗ ⊗ id)\nMm\nid ⊗ µ\nid ⊗ M η\nm\nτ′\nid\n➀\n➁\n➂\n➃ ➄ ➅\n➆\n➀ naturality of∼\n=,➁ ⊗ is a bifunctor,➂ naturality of\nτ′,➃ app is the counit of the adjunction, and\nthe deﬁnition ofs,➄ naturality ofτ′,➅ monad laws,➆ the ‘twisted’ coherence condition forτ′ (see\nRemark 19)"
}